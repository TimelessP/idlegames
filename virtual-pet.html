<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Virtual Pet</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f6f7fb; --card:#ffffff; --muted:#8a93a8; --accent:#5b8def; --danger:#e05c5c; --glass:rgba(255,255,255,0.6);
      --radius:14px; --pad:18px; --gap:12px; --shadow: 0 6px 18px rgba(20,30,60,0.08);
    }
    html,body{height:100%;}
    body{
      margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif; background:linear-gradient(180deg,#eef2ff 0%, var(--bg) 60%); color:#0b1220; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      display:flex; align-items:center; justify-content:center; padding:12px; box-sizing:border-box;
    }
    /* app container scales to viewport */
    .app{
      width:100%; height:100%; max-width:1100px; max-height:900px; display:grid; grid-template-columns: 360px 1fr; gap:18px; align-items:stretch;
      transform-origin:top left;
    }
    @media (max-width:900px){
      .app{grid-template-columns:1fr; grid-template-rows: 320px 1fr; max-width:100%; max-height:100%}
    }

    /* left sidebar */
    .panel{background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:18px; display:flex; flex-direction:column; gap:12px}
    .pet-card{display:flex; gap:12px; align-items:center}
    .avatar{
      width:96px; height:96px; border-radius:16px; background:linear-gradient(180deg,#fff 0%,#f0f6ff 100%); display:flex; align-items:center; justify-content:center; box-shadow: 0 6px 14px rgba(60,80,120,0.06);
    }
    .avatar .face{font-size:44px}
    .pet-meta{flex:1}
    .pet-name{font-weight:700; font-size:18px}
    .pet-sub{font-size:12px; color:var(--muted)}

    .stats{display:grid; grid-template-columns:repeat(2,1fr); gap:10px}
    .stat{background:linear-gradient(180deg, rgba(90,120,220,0.04), rgba(255,255,255,0.02)); padding:10px; border-radius:12px}
    .stat .label{font-size:11px; color:var(--muted)}
    .stat .value{font-size:14px; font-weight:600}
    .money{font-size:16px; font-weight:700; color:var(--accent)}

    /* main area */
    .main{background:linear-gradient(180deg,#fff, #fbfdff); border-radius:var(--radius); box-shadow:var(--shadow); padding:18px; display:flex; flex-direction:column; gap:14px}
    .stage{flex:1; display:flex; align-items:center; justify-content:center; position:relative; overflow:hidden; border-radius:12px; background:linear-gradient(180deg,#e9f2ff, #fdfefe);}
    .stage .ground{position:absolute; left:0; right:0; bottom:0; height:120px; background:linear-gradient(180deg,#cfe4ff,#a9d0ff); border-top-left-radius:40px;border-top-right-radius:40px}
    .pet-sprite{position:relative; z-index:2; width:220px; height:220px; display:flex; align-items:center; justify-content:center}

    /* small controls */
    .controls{display:flex; gap:10px; flex-wrap:wrap}
    .btn{background:var(--accent); color:white; border:none; padding:10px 12px; border-radius:10px; font-weight:600; cursor:pointer; box-shadow: 0 6px 12px rgba(80,120,240,0.12)}
    .btn.secondary{background:transparent; color:var(--accent); border:1px solid rgba(91,141,239,0.12); box-shadow:none}
    .btn.ghost{background:transparent; color:var(--muted); border-radius:8px; padding:8px}
    .grow{transition:transform .18s ease}
    .grow:active{transform:scale(.98)}

    /* bottom timeline / activities */
    .activity-row{display:flex; gap:10px; align-items:center; overflow:auto; padding-bottom:6px}
    .card{background:var(--glass); border-radius:12px; padding:10px; min-width:120px; display:flex; flex-direction:column; gap:6px}

    /* modals */
    .overlay{position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:60}
    .overlay.show{display:flex}
    .modal{width:min(720px,94%); max-height:86vh; overflow:auto; border-radius:12px; background:var(--card); padding:18px; box-shadow:0 20px 60px rgba(20,30,60,0.25)}
    .modal h3{margin:0 0 6px 0}
    .modal .row{display:flex; gap:10px; flex-wrap:wrap}

    /* progress bars */
    .bar{height:10px; background:linear-gradient(90deg, rgba(11,18,32,0.06), rgba(11,18,32,0.02)); border-radius:999px; overflow:hidden}
    .bar > i{display:block; height:100%; background:linear-gradient(90deg,var(--accent),#7ac2ff); width:40%}

    /* small responsive tweaks */
    @media (max-width:480px){:root{--pad:12px; --gap:8px} .avatar{width:86px;height:86px} .pet-sprite{width:160px;height:160px}}

    /* subtle animations */
    .pet-bounce{animation:pet-bob 3s ease-in-out infinite}
    @keyframes pet-bob{0%{transform:translateY(0)}50%{transform:translateY(-8px)}100%{transform:translateY(0)}}

    /* small utility */
    .muted{color:var(--muted)}
    .right{margin-left:auto}
    .center{text-align:center}
    .small{font-size:12px}
  </style>
</head>
<body>
  <div class="app" role="application" aria-label="Virtual pet app">
    <aside class="panel" aria-hidden="false">
      <div class="pet-card">
        <div class="avatar" id="avatar"><div class="face">üê∂</div></div>
        <div class="pet-meta">
          <div class="pet-name" id="petName">Buddy</div>
          <div class="pet-sub" id="petAge">Age: 0d ‚Ä¢ Breed: Happy</div>
        </div>
      </div>

      <div class="stats">
        <div class="stat">
          <div class="label">Hunger</div>
          <div class="value" id="hungerVal">50</div>
          <div class="bar" aria-hidden="true"><i id="hungerBar" style="width:50%"></i></div>
        </div>
        <div class="stat">
          <div class="label">Energy</div>
          <div class="value" id="energyVal">80</div>
          <div class="bar"><i id="energyBar" style="width:80%"></i></div>
        </div>
        <div class="stat">
          <div class="label">Happiness</div>
          <div class="value" id="happyVal">70</div>
          <div class="bar"><i id="happyBar" style="width:70%"></i></div>
        </div>
        <div class="stat">
          <div class="label">Health</div>
          <div class="value" id="healthVal">100</div>
          <div class="bar"><i id="healthBar" style="width:100%"></i></div>
        </div>
      </div>

      <div style="display:flex; gap:8px; align-items:center; margin-top:6px">
        <div class="money">¬£<span id="moneyVal">100</span></div>
        <button class="btn secondary" id="btnSave">Save</button>
        <button class="btn ghost" id="btnReset">Reset</button>
      </div>

      <div style="margin-top:8px" class="small muted">Last saved: <span id="lastSaved">never</span></div>

      <div style="margin-top:10px">
        <div class="small muted">Quick actions</div>
        <div class="controls" style="margin-top:6px">
          <button class="btn" id="feedBtn" aria-label="Feed your pet">Feed</button>
          <button class="btn" id="playBtn" aria-label="Play with your pet">Play</button>
          <button class="btn" id="napBtn" aria-label="Let your pet nap">Nap</button>
          <button class="btn" id="healBtn" aria-label="Take your pet to the vet">Heal</button>
        </div>
      </div>

      <div style="margin-top:12px">
        <div class="small muted">Places</div>
        <div class="controls" style="margin-top:6px">
          <button class="btn secondary" id="shopBtn" aria-label="Open shop">Shop</button>
          <button class="btn secondary" id="parkBtn" aria-label="Go to park">Park</button>
          <button class="btn secondary" id="vetBtn" aria-label="Open vet">Vet</button>
        </div>
      </div>

    </aside>

    <main class="main">
      <div class="stage" id="stage" tabindex="0">
        <div class="ground"></div>
        <div class="pet-sprite pet-bounce" id="petSprite" aria-hidden="false">
          <svg width="220" height="220" viewBox="0 0 220 220" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="pet">
            <defs>
              <linearGradient id="g1" x1="0" x2="0" y1="0" y2="1">
                <stop offset="0%" stop-color="#fff"></stop>
                <stop offset="100%" stop-color="#eaf5ff"></stop>
              </linearGradient>
            </defs>
            <rect x="18" y="30" width="184" height="140" rx="28" fill="url(#g1)" stroke="#dbeeff"/>
            <g transform="translate(58,58)">
              <circle cx="28" cy="20" r="18" fill="#fff"/>
              <circle cx="78" cy="20" r="18" fill="#fff"/>
              <circle cx="28" cy="20" r="6" fill="#1f2937"/>
              <circle cx="78" cy="20" r="6" fill="#1f2937"/>
              <path d="M33 48 q18 18 40 0" stroke="#1f2937" stroke-width="3" fill="none" stroke-linecap="round"/>
            </g>
          </svg>
        </div>
      </div>

      <div class="activity-row" id="activities">
        <div class="card small center">
          <div class="muted">Daily Streak</div>
          <div id="streakVal" style="font-weight:700;font-size:18px">0</div>
        </div>
        <div class="card small center">
          <div class="muted">Level</div>
          <div id="levelVal" style="font-weight:700;font-size:18px">1</div>
        </div>
        <div class="card small center">
          <div class="muted">Tasks</div>
          <div id="tasksVal" style="font-weight:700;font-size:18px">0</div>
        </div>
        <div class="card small center" style="min-width:160px">
          <div class="muted">Mini-Game</div>
          <div style="display:flex; gap:6px; justify-content:center; margin-top:6px">
            <button class="btn" id="miniTap" aria-label="Play tap fetch mini game">Tap Fetch</button>
            <button class="btn secondary" id="miniRhythm" aria-label="Play rhythm mini game">Rhythm</button>
          </div>
        </div>
      </div>

    </main>
  </div>

  <!-- modals -->
  <div class="overlay" id="overlay">
    <div class="modal" role="dialog" aria-modal="true" aria-label="modal">
      <div style="display:flex;gap:8px;align-items:center;justify-content:space-between">
        <h3 id="modalTitle">Shop</h3>
        <div><button class="btn ghost" id="closeModal">Close</button></div>
      </div>
      <div id="modalBody" style="margin-top:12px"></div>
    </div>
  </div>
  <!-- aria live region for announcements -->
  <div id="announcer" aria-live="polite" style="position:fixed;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden"></div>

  <script>
    // Minimal single-file virtual pet
    const DEFAULT = {
      name: 'Buddy', money:100, hunger:50, energy:80, happy:70, health:100, level:1, streak:0, tasks:0, lastSaved: null, created:Date.now(), ageDays:0, lastTick: Date.now()
    };
    const LS_KEY = 'vg_pet_v1';
    let state = load();

    // DOM refs
    const hungerVal = document.getElementById('hungerVal'), energyVal = document.getElementById('energyVal'), happyVal = document.getElementById('happyVal'), healthVal = document.getElementById('healthVal');
    const hungerBar = document.getElementById('hungerBar'), energyBar = document.getElementById('energyBar'), happyBar = document.getElementById('happyBar'), healthBar = document.getElementById('healthBar');
    const moneyVal = document.getElementById('moneyVal'), lastSaved = document.getElementById('lastSaved');
    const petName = document.getElementById('petName'), petAge = document.getElementById('petAge');
    const avatar = document.getElementById('avatar');

  function load(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if(raw){
          const parsed = JSON.parse(raw);
          // upgrade missing fields
      return Object.assign({}, DEFAULT, parsed);
        }
      }catch(e){console.warn('load err',e)}
      return Object.assign({}, DEFAULT);
    }
    function save(){
      state.lastSaved = Date.now();
      localStorage.setItem(LS_KEY, JSON.stringify(state));
      lastSaved.textContent = timeAgo(state.lastSaved);
    }

  // UI updates
    function render(){
      petName.textContent = state.name;
      const ageDays = Math.floor((Date.now() - state.created)/(1000*60*60*24));
      petAge.textContent = `Age: ${ageDays}d ‚Ä¢ Level ${state.level}`;

      hungerVal.textContent = Math.max(0, Math.min(100, Math.round(state.hunger)));
      energyVal.textContent = Math.max(0, Math.min(100, Math.round(state.energy)));
      happyVal.textContent = Math.max(0, Math.min(100, Math.round(state.happy)));
      healthVal.textContent = Math.max(0, Math.min(100, Math.round(state.health)));

      hungerBar.style.width = clamp(state.hunger)+'%';
      energyBar.style.width = clamp(state.energy)+'%';
      happyBar.style.width = clamp(state.happy)+'%';
      healthBar.style.width = clamp(state.health)+'%';

      moneyVal.textContent = Math.max(0, Math.round(state.money));
      lastSaved.textContent = state.lastSaved ? timeAgo(state.lastSaved) : 'never';
      document.getElementById('streakVal').textContent = state.streak;
      document.getElementById('levelVal').textContent = state.level;
      document.getElementById('tasksVal').textContent = state.tasks;

      // avatar mood
      const mood = state.happy > 70 ? 'üòÑ' : state.happy > 40 ? 'üôÇ' : state.happy > 20 ? 'üòï' : 'üò¢';
      avatar.querySelector('.face').textContent = mood;

      // pet sprite size/filters change with health
      const petSprite = document.getElementById('petSprite');
      petSprite.style.filter = `grayscale(${state.health<40?0.6:0})`;

      // small reward animation when high
      if(state.happy>90) petSprite.classList.add('grow'); else petSprite.classList.remove('grow');
    }

    function clamp(v){ return Math.max(0, Math.min(100, Math.round(v))); }

    // core dynamics tick every 10s (fast for demo). In real game use 60s+ and background time catch-up
    const TICK = 10000;
    let tickTimer = null;

    // Apply decay for a given elapsed fraction (seconds). This supports catch-up when the tab is inactive.
    function applyDecayForFraction(fraction){
      // original per-TICK changes (per 10s): hunger +3, energy -2, happy -1.5, money +0.2
      state.hunger += 3 * fraction;
      state.energy -= 2 * fraction;
      state.happy -= 1.5 * fraction;
      state.money += 0.2 * fraction;

      // clamp basics first
      state.hunger = clamp(state.hunger);
      state.energy = clamp(state.energy);
      state.happy = clamp(state.happy);

      // health decays proportionally to thresholds
      if(state.hunger > 80) state.health -= (state.hunger - 80) * 0.02 * fraction;
      if(state.energy < 20) state.health -= (20 - state.energy) * 0.03 * fraction;
      state.health = clamp(state.health);
    }

    function tick(saveAndRender = true){
      // normal tick does one full TICK worth of decay
      applyDecayForFraction(1);

      // age & level progression
      const days = Math.floor((Date.now() - state.created)/(1000*60*60*24));
      state.ageDays = days;
      state.level = 1 + Math.floor(days/3) + Math.floor(state.streak/7);

      // bookkeeping
      state.lastTick = Date.now();

      if(saveAndRender) save();
      if(saveAndRender) render();
    }

    // start periodic ticking but first catch up any missed time
    (function startTicker(){
      // catch-up based on lastTick
      try{
        const now = Date.now();
        const last = state.lastTick || state.created || now;
        const elapsed = Math.max(0, now - last);
        // full ticks
        const full = Math.floor(elapsed / TICK);
        for(let i=0;i<full;i++) tick(false);
        // remainder fraction
        const rem = elapsed - full * TICK;
        if(rem>0) applyDecayForFraction(rem / TICK);
      }catch(e){console.warn('ticker catchup err', e)}

      // now start interval
      if(tickTimer) clearInterval(tickTimer);
      tickTimer = setInterval(()=>tick(true), TICK);
      // initial render after catch-up
      render();
      save();
    })();

    // actions
    function feed(){
      if(state.money < 2){ toast('Not enough money to buy food'); return; }
      state.money -= 2; state.hunger -= 20; state.happy += 6; state.health += 2; render(); save(); joy('You fed your pet.');
    }
    function play(){
      state.energy -= 12; state.happy += 14; state.hunger += 6; state.money += 0.5; render(); save(); joy('You played with your pet.');
    }
    function nap(){
      state.energy += 30; state.happy += 4; state.hunger += 6; render(); save(); joy('Pet took a nap.');
    }
    function heal(){
      if(state.money < 20){ toast('Vet costs ¬£20'); return; }
      state.money -= 20; state.health = Math.min(100, state.health + 40); state.happy += 4; render(); save(); joy('Vet visit complete.');
    }

    // mini-games
    function tapFetch(){
      // quick tap 5 times in 3s to win coins and happiness
      openModal('Tap Fetch', `Tap the big button quickly 5 times in 4 seconds to fetch a coin! <div style="text-align:center;margin-top:12px"><button id="tapBig" class="btn" style="font-size:22px;padding:16px 20px">TAP</button></div>`);
      let taps=0; let done=false;
      const btn = document.getElementById('tapBig');
      const onTap = ()=>{
        if(done) return; taps++; state.happy += 1; render();
        if(taps>=5){ done=true; closeModal(); state.money += 5; state.happy += 8; save(); joy('Fetched a coin! +¬£5'); }
      }
      registerModalListener(btn, 'click', onTap);
      // timeout (store id for cleanup)
  const timerId = setTimeout(()=>{ if(!done){ closeModal(); toast('Too slow!'); } }, 4000);
  registerModalListener(window, 'cleanupTimer', timerId);
    }

    function rhythmGame(){
      openModal('Rhythm Mini-game', `<div class="small muted">Press Space or Tap when the beat ring reaches the marker. 3 rounds.</div><div style="height:36px;margin-top:12px;display:flex;align-items:center;justify-content:center"><div id="rhythmTrack" style="width:280px;height:12px;background:linear-gradient(90deg,#eee,#fff);border-radius:8px;position:relative"><div id="ring" style="position:absolute;left:0;top:-6px;width:24px;height:24px;border-radius:50%;background:linear-gradient(180deg,#ffde7a,#ffd06a);transform:translateX(0)"></div></div></div><div style="text-align:center;margin-top:12px"><button id="startRhythm" class="btn">Start</button></div>`);
  let ring = document.getElementById('ring'); let track = document.getElementById('rhythmTrack'); let rounds=3; let current=0; let anim=null; let running=false;
      function startRound(){
        running = true; current++; let duration=1600 - current*120; let start=Date.now();
        function step(){
          const p = ((Date.now()-start)%duration)/duration; ring.style.transform = `translateX(${p*256}px)`; anim = requestAnimationFrame(step);
        }
        anim = requestAnimationFrame(step);
      }
      function stopAnim(){ if(anim) cancelAnimationFrame(anim); anim=null; running=false; }
      const startBtn = document.getElementById('startRhythm');
      registerModalListener(startBtn, 'click', ()=>{ if(!running) startRound(); });
      function scoreHit(){ if(!running) return; stopAnim(); state.happy += 6; state.money += 2; render(); if(current>=rounds){ closeModal(); save(); joy('Great rhythm!'); } else { startRound(); } }
  const onKey = (e)=>{ if(e.code==='Space') scoreHit(); };
  const onTap = (e)=>{ if(e.target.id==='ring' || e.target.id==='startRhythm') return; scoreHit(); };
  // register on document but through registry so we can cleanup
  registerModalListener(document, 'keydown', onKey);
  registerModalListener(document, 'click', onTap);
  // register cleanup to stop animation if modal closes early
  registerModalListener(window, 'cleanupTimer', ()=>{ stopAnim(); });
    }

    // modal helpers
    const overlay = document.getElementById('overlay'); const modalTitle = document.getElementById('modalTitle'); const modalBody = document.getElementById('modalBody'); const announcer = document.getElementById('announcer');
    function announce(msg){ announcer.textContent = msg; }
    let _prevFocused = null;
    function openModal(title, inner){
      _prevFocused = document.activeElement;
      overlay.classList.add('show'); modalTitle.textContent = title; modalBody.innerHTML = inner; announce(title + ' opened');
      // prevent background scrolling
      document.body.style.overflow = 'hidden';
      // focus first focusable inside modal
      setTimeout(()=>{
        const focusable = overlay.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
        if(focusable) focusable.focus();
      }, 10);
      // minimal trap: keep tab within modal
      registerModalListener(document, 'keydown', function trapTab(e){
        if(e.key !== 'Tab') return;
        const focusables = Array.from(overlay.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])')).filter(Boolean);
        if(focusables.length===0) return;
        const idx = focusables.indexOf(document.activeElement);
        if(e.shiftKey){
          if(idx<=0){ focusables[focusables.length-1].focus(); e.preventDefault(); }
        } else {
          if(idx===focusables.length-1){ focusables[0].focus(); e.preventDefault(); }
        }
      });
    }
    function closeModal(){ overlay.classList.remove('show'); modalBody.innerHTML=''; announce('Closed'); document.body.style.overflow = ''; cleanupModalListeners(); if(_prevFocused && typeof _prevFocused.focus==='function') _prevFocused.focus(); _prevFocused = null; }
    document.getElementById('closeModal').addEventListener('click', closeModal);
    // close modal by clicking backdrop
    overlay.addEventListener('click', function(e){ if(e.target===overlay) closeModal(); });

    // store references to ad-hoc listeners we add inside modals so we can remove them when closing
    const modalListenerRegistry = [];
    function registerModalListener(target, type, handler, options){
      // allow a special type 'cleanupTimer' to store timeouts/interval ids
      if(type === 'cleanupTimer'){ modalListenerRegistry.push({target,type,handler,options}); return; }
      target.addEventListener(type, handler, options); modalListenerRegistry.push({target,type,handler,options});
    }
    function cleanupModalListeners(){ while(modalListenerRegistry.length){ const r = modalListenerRegistry.pop(); try{ if(r.type === 'cleanupTimer'){ clearTimeout(r.handler); clearInterval(r.handler); } else { r.target.removeEventListener(r.type, r.handler, r.options); } }catch(e){} } }

    // places
    function openShop(){
      openModal('Shop', `<div class="row"><div style="flex:1"><div class="small muted">Food Bag</div><div style="font-weight:700">¬£2</div><div style="margin-top:8px"><button class="btn" id="buyFood">Buy</button></div></div><div style="flex:1"><div class="small muted">Toy</div><div style="font-weight:700">¬£8</div><div style="margin-top:8px"><button class="btn" id="buyToy">Buy</button></div></div><div style="flex:1"><div class="small muted">Bed</div><div style="font-weight:700">¬£25</div><div style="margin-top:8px"><button class="btn" id="buyBed">Buy</button></div></div></div>`);
  registerModalListener(document.getElementById('buyFood'), 'click', ()=>{ if(state.money<2){ toast('Need ¬£2'); return;} state.money-=2; state.hunger-=18; state.happy+=6; save(); render(); closeModal(); joy('Bought food.'); });
  registerModalListener(document.getElementById('buyToy'), 'click', ()=>{ if(state.money<8){ toast('Need ¬£8'); return;} state.money-=8; state.happy+=18; save(); render(); closeModal(); joy('Bought a toy.'); });
  registerModalListener(document.getElementById('buyBed'), 'click', ()=>{ if(state.money<25){ toast('Need ¬£25'); return;} state.money-=25; state.energy+=22; save(); render(); closeModal(); joy('Bought a comfy bed.'); });
    }
    function openPark(){
      openModal('Park', `<div class="small muted">Take a walk in the park. You might find coins or meet other pets.</div><div style="display:flex;gap:8px;margin-top:12px"><button class="btn" id="walkBtn">Walk (cost: ¬£0)</button><button class="btn secondary" id="searchBtn">Search</button></div>`);
  registerModalListener(document.getElementById('walkBtn'), 'click', ()=>{ state.energy -= 8; state.happy += 10; state.hunger += 6; save(); render(); closeModal(); joy('Nice walk!'); });
  registerModalListener(document.getElementById('searchBtn'), 'click', ()=>{ const found = Math.random() < 0.45; if(found){ const amt = 1+Math.floor(Math.random()*8); state.money+=amt; joy('Found ¬£'+amt); } else { toast('Nothing found'); } save(); render(); closeModal(); });
    }
    function openVet(){
      openModal('Vet', `<div class="small muted">The vet can heal your pet. Cost: ¬£20</div><div style="margin-top:12px"><button class="btn" id="payVet">Pay ¬£20</button></div>`);
  registerModalListener(document.getElementById('payVet'), 'click', ()=>{ heal(); closeModal(); });
    }

    // UI helpers
  function toast(msg){ openModal('Notice', `<div class="small muted">${msg}</div><div style="margin-top:14px;text-align:right"><button class="btn ghost" id="okToast">OK</button></div>`); const ok = document.getElementById('okToast'); if(ok) registerModalListener(ok, 'click', closeModal); }
    function joy(msg){ const el = document.createElement('div'); el.className='temp-joy'; el.textContent = msg; el.style.position='fixed'; el.style.right='18px'; el.style.bottom='18px'; el.style.background='linear-gradient(90deg,#5b8def,#7ac2ff)'; el.style.color='white'; el.style.padding='10px 14px'; el.style.borderRadius='10px'; el.style.boxShadow='0 8px 22px rgba(30,60,120,0.2)'; document.body.appendChild(el); setTimeout(()=>el.style.opacity='0',1600); setTimeout(()=>el.remove(),2200);
    }

    // small utilities
    function timeAgo(ts){ if(!ts) return 'never'; const s = Math.floor((Date.now()-ts)/1000); if(s<60) return s+'s ago'; if(s<3600) return Math.floor(s/60)+'m ago'; if(s<86400) return Math.floor(s/3600)+'h ago'; return Math.floor(s/86400)+'d ago'; }

    // wire buttons
    document.getElementById('feedBtn').addEventListener('click', feed);
    document.getElementById('playBtn').addEventListener('click', play);
    document.getElementById('napBtn').addEventListener('click', nap);
    document.getElementById('healBtn').addEventListener('click', ()=> openVet());
    document.getElementById('shopBtn').addEventListener('click', openShop);
    document.getElementById('parkBtn').addEventListener('click', openPark);
    document.getElementById('vetBtn').addEventListener('click', openVet);
    document.getElementById('btnSave').addEventListener('click', save);
    document.getElementById('btnReset').addEventListener('click', ()=>{ if(confirm('Reset pet data?')){ localStorage.removeItem(LS_KEY); state = Object.assign({}, DEFAULT, {money:100}); save(); render(); } });
    document.getElementById('miniTap').addEventListener('click', tapFetch);
    document.getElementById('miniRhythm').addEventListener('click', rhythmGame);

    // keyboard shortcuts
    window.addEventListener('keydown', (e)=>{
      if(e.key==='f') feed(); if(e.key==='p') play(); if(e.key==='n') nap(); if(e.key==='s') save();
    });

    // initial render
    render();
    // save on unload
    window.addEventListener('beforeunload', save);

    // scale app to viewport with padding while keeping crisp layout
    (function autoScale(){
      const app = document.querySelector('.app');
      function rescale(){
        const pad = 24; const vw = window.innerWidth-pad; const vh = window.innerHeight-pad;
        const maxW = 1100; const maxH = 900; const naturalW = Math.min(maxW, vw); const naturalH = Math.min(maxH, vh);
        const scale = Math.min(vw/naturalW, vh/naturalH, 1);
        app.style.transform = `scale(${scale})`;
      }
      window.addEventListener('resize', rescale); rescale();
    })();

    // Brainstorm notes for long-term engagement persisted in state for demonstration
    state._brainstorm = state._brainstorm || {
      loops: [
        'Daily check-in streaks with small coin rewards',
        'Limited-time events and seasonal items',
        'Progression: levels unlock cosmetics and new mini-games',
        'Companion collection: trade or befriend other pets via park',
        'Quests: chores to earn money and boost stats',
        'RNG drops in park and rare items in shop',
        'Cosmetic skins & animations purchasable for fun microtransactions (opt-in)',
      ]
    };

  </script>
</body>
</html>
