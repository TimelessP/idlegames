<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="referrer" content="strict-origin-when-cross-origin">
  <meta name="description" content="A curated collection of relaxing idle and puzzle games, plus useful web tools.">
  
  <!-- Open Graph / Twitter -->
  <meta property="og:title" content="Idle Games Collection">
  <meta property="og:description" content="Relaxing idle games, puzzles, and tools.">
  <meta property="og:image" content="assets/appicons/idle-games-512x512px.png">
  <meta name="twitter:card" content="summary_large_image">

  <title>Idle Games Collection</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#667eea">
  <script type="module" src="assets/js/pwa.js" defer></script>

  <style>
    :root {
      --bg-body: #f8f9fa;
      --bg-card: #ffffff;
      --bg-header: #ffffff;
      --text-main: #2d3748;
      --text-muted: #718096;
      --border-color: #e2e8f0;
      --accent-primary: #667eea;
      --accent-secondary: #764ba2;
      --accent-hover: #5a67d8;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --radius-md: 0.5rem;
      --radius-lg: 0.75rem;
      --radius-xl: 1rem;
    }

    [data-theme="dark"] {
      --bg-body: #1a1a2e;
      --bg-card: #16213e;
      --bg-header: #16213e;
      --text-main: #eee;
      --text-muted: #a0aec0;
      --border-color: #2a3f5f;
      --accent-primary: #0f3460;
      --accent-secondary: #1565c0;
      --accent-hover: #1565c0;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.5);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.6);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.6);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: var(--bg-body);
      color: var(--text-main);
      line-height: 1.5;
      transition: background-color 0.3s ease, color 0.3s ease;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Header */
    .app-header {
      background: var(--bg-header);
      border-bottom: 1px solid var(--border-color);
      position: sticky;
      top: 0;
      z-index: 50;
      padding: 0.75rem 1rem;
      box-shadow: var(--shadow-sm);
    }
    .header-inner {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      flex-wrap: wrap;
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      text-decoration: none;
      color: var(--text-main);
    }
    .brand-logo {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      object-fit: cover;
    }
    .brand-text h1 {
      font-size: 1.25rem;
      font-weight: 700;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .brand-text small {
      font-size: 0.75rem;
      color: var(--text-muted);
      display: block;
      line-height: 1;
    }

    /* Controls */
    .controls {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .btn-icon {
      background: transparent;
      border: 1px solid var(--border-color);
      color: var(--text-main);
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 1.2rem;
    }
    .btn-icon:hover {
      background: var(--bg-body);
      transform: translateY(-1px);
    }
    .btn-icon.active {
      background: var(--accent-primary);
      color: white;
      border-color: var(--accent-primary);
    }

    /* Search & Filter Bar */
    .toolbar {
      max-width: 1200px;
      margin: 1.5rem auto 0;
      padding: 0 1rem;
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      align-items: center;
    }
    .search-box {
      flex: 1;
      min-width: 280px;
      position: relative;
    }
    .search-input {
      width: 100%;
      padding: 0.75rem 1rem 0.75rem 2.5rem;
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-color);
      background: var(--bg-card);
      color: var(--text-main);
      font-size: 1rem;
      transition: border-color 0.2s;
    }
    .search-input:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    .search-icon {
      position: absolute;
      left: 0.875rem;
      top: 50%;
      transform: translateY(-50%);
      opacity: 0.5;
    }

    .filter-group {
      display: flex;
      gap: 0.5rem;
      overflow-x: auto;
      padding-bottom: 4px;
      -webkit-overflow-scrolling: touch;
    }
    .filter-select {
      padding: 0.5rem 2rem 0.5rem 1rem;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-color);
      background: var(--bg-card);
      color: var(--text-main);
      font-size: 0.9rem;
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23718096' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 0.75rem center;
    }

    /* Grid */
    .main-content {
      flex: 1;
      max-width: 1200px;
      margin: 0 auto;
      padding: 1.5rem 1rem;
      width: 100%;
    }
    .games-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 1.5rem;
    }

    /* Card */
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-xl);
      overflow: hidden;
      transition: transform 0.2s, box-shadow 0.2s;
      position: relative;
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    .card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
    }
    .card-preview {
      height: 160px;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 4rem;
      position: relative;
      text-decoration: none;
    }
    .card-preview::after {
      content: '';
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.1);
    }
    .card-body {
      padding: 1.25rem;
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 0.5rem;
    }
    .card-title {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--text-main);
      margin: 0;
    }
    .card-desc {
      font-size: 0.9rem;
      color: var(--text-muted);
      margin-bottom: 1rem;
      flex: 1;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .card-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .tag {
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
      border-radius: 999px;
      background: var(--bg-body);
      color: var(--text-muted);
      border: 1px solid var(--border-color);
    }
    .card-actions {
      display: flex;
      gap: 0.75rem;
      margin-top: auto;
    }
    .btn-play {
      flex: 1;
      background: var(--accent-primary);
      color: white;
      text-decoration: none;
      padding: 0.6rem;
      border-radius: var(--radius-md);
      text-align: center;
      font-weight: 600;
      transition: background 0.2s;
    }
    .btn-play:hover {
      background: var(--accent-hover);
    }
    .btn-fave {
      width: 42px;
      border: 1px solid var(--border-color);
      background: transparent;
      border-radius: var(--radius-md);
      cursor: pointer;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      transition: all 0.2s;
    }
    .btn-fave:hover {
      background: var(--bg-body);
      color: #e53e3e;
    }
    .btn-fave.is-fave {
      color: #e53e3e;
      border-color: #e53e3e;
      background: rgba(229, 62, 62, 0.1);
    }

    /* Badges */
    .badge {
      position: absolute;
      top: 1rem;
      right: 1rem;
      padding: 0.25rem 0.75rem;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      box-shadow: var(--shadow-sm);
      z-index: 10;
    }
    .badge-new { background: #48bb78; color: white; }
    .badge-beta { background: #ed8936; color: white; }
    .badge-leaving { background: #f56565; color: white; }

    /* Footer */
    .app-footer {
      background: var(--bg-card);
      border-top: 1px solid var(--border-color);
      padding: 2rem 1rem;
      margin-top: auto;
    }
    .footer-content {
      max-width: 1200px;
      margin: 0 auto;
      text-align: center;
      color: var(--text-muted);
    }
    .footer-links {
      display: flex;
      justify-content: center;
      gap: 1.5rem;
      margin-bottom: 1rem;
    }
    .footer-link {
      color: var(--text-muted);
      text-decoration: none;
      font-size: 0.9rem;
    }
    .footer-link:hover { color: var(--accent-primary); }

    /* Empty State */
    .empty-state {
      grid-column: 1 / -1;
      text-align: center;
      padding: 4rem 1rem;
      color: var(--text-muted);
    }
    .empty-icon { font-size: 3rem; margin-bottom: 1rem; display: block; }

    @media (max-width: 640px) {
      .toolbar { flex-direction: column; align-items: stretch; }
      .filter-group { width: 100%; }
      .search-box { width: 100%; }
    }
  </style>
</head>
<body>

  <header class="app-header">
    <div class="header-inner">
      <a href="#" class="brand">
        <img src="assets/appicons/idle-games-512x512px.png" alt="Logo" class="brand-logo">
        <div class="brand-text">
          <h1>Idle Games</h1>
          <small id="version-display">Collection</small>
        </div>
      </a>
      
      <div class="controls">
        <button class="btn-icon" id="theme-toggle" title="Toggle Theme">üåì</button>
        <button class="btn-icon" id="fave-filter-btn" title="Show Favorites Only">‚ù§Ô∏è</button>
        <button class="btn-icon" id="parental-btn" title="Parental Controls">üîí</button>
      </div>
    </div>
  </header>

  <div class="toolbar">
    <div class="search-box">
      <span class="search-icon">üîç</span>
      <input type="text" class="search-input" id="search-input" placeholder="Search games, tools, tags...">
    </div>
    
    <div class="filter-group">
      <select class="filter-select" id="sort-select">
        <option value="newest">Newest First</option>
        <option value="updated">Recently Updated</option>
        <option value="name">Name (A-Z)</option>
      </select>
      
      <select class="filter-select" id="category-select">
        <option value="all">All Categories</option>
        <option value="game">Games</option>
        <option value="tool">Tools</option>
        <!-- Populated dynamically -->
      </select>
    </div>
  </div>

  <main class="main-content">
    <div id="games-grid" class="games-grid">
      <!-- Cards injected here -->
    </div>
  </main>

  <footer class="app-footer">
    <div class="footer-content">
      <div class="footer-links">
        <a href="#" class="footer-link" onclick="toggleFooterPanel('privacy'); return false;">Privacy</a>
        <a href="#" class="footer-link" onclick="toggleFooterPanel('terms'); return false;">Terms</a>
        <a href="#" class="footer-link" onclick="toggleFooterPanel('a11y'); return false;">Accessibility</a>
        <a href="https://github.com/TimelessP/idlegames" class="footer-link">GitHub</a>
      </div>
      <p>&copy; <span id="year"></span> Timeless Prototype. Built with ‚ù§Ô∏è.</p>
      <div id="footer-details" style="display:none; margin-top: 1rem; text-align: left; background: var(--bg-body); padding: 1rem; border-radius: 8px;">
        <!-- Dynamic footer content -->
      </div>
    </div>
  </footer>

  <script type="module">
    import { APP_VERSION } from './assets/js/version.js';
    document.getElementById('version-display').textContent = `v${APP_VERSION}`;
  </script>

  <script>
    // --- DATA ---
    // Enriched with dates for sorting
    const DATA = [
      {
        id: 'freecell', type: 'game', emoji: '‚ô£Ô∏è', title: 'FreeCell Solitaire', href: 'freecell.html',
        desc: 'Strategic solitaire game where almost every deal is winnable. Use free cells to maneuver cards and build foundations.',
        tags: ['Cards', 'Puzzle', 'Classic'],
        date_added: '2025-11-30', date_updated: '2025-11-30',
        is_new: true
      },
      {
        id: 'klondike', type: 'game', emoji: '‚ô¶Ô∏è', title: 'Klondike Solitaire', href: 'klondike.html',
        desc: 'The classic "Microsoft Solitaire". Build foundations from Ace to King. Features Draw 1/Draw 3 modes and Vegas scoring.',
        tags: ['Cards', 'Puzzle', 'Classic'],
        date_added: '2025-11-30', date_updated: '2025-11-30',
        is_new: true
      },
      {
        id: 'spider', type: 'game', emoji: 'üï∑Ô∏è', title: 'Spider Solitaire', href: 'spider.html',
        desc: 'Classic Spider Solitaire with 1, 2, or 4 suit modes. Features smooth animations, pinch-to-zoom, and auto-save. Build sequences from King to Ace!',
        tags: ['Cards', 'Puzzle', 'Classic'],
        date_added: '2025-11-30', date_updated: '2025-11-30',
        is_new: true
      },
      {
        id: 'kungfu', type: 'game', emoji: 'ü•ã', title: 'Iron Fist Arena', href: 'kungfu.html',
        desc: 'A classic 1v1 fighting game. Master martial arts, defeat opponents, and become the champion. Supports keyboard and gamepad.',
        tags: ['Action', 'Fighting', 'Arcade'],
        date_added: '2025-11-30', date_updated: '2025-11-30',
        is_new: true
      },
      {
        id: 'strange-pebbles', type: 'game', emoji: 'üü£', title: 'Strange Pebbles', href: 'strange-pebbles.html',
        desc: 'A physics sandbox with curious pebbles. Discover their interactions, build complex machines, or just enjoy the chaos.',
        tags: ['Physics', 'Sandbox', 'Simulation'],
        date_added: '2025-11-28', date_updated: '2025-11-28',
        is_new: true
      },
      {
        id: 'tree', type: 'game', emoji: 'üéÑ', title: 'Tree Decorator', href: 'tree.html',
        desc: 'A cozy, fractal-based Christmas tree decorating game. Draw glowing lights, place ornaments, and enjoy the festive atmosphere.',
        tags: ['Creative', 'Relaxing', 'Seasonal'],
        date_added: '2025-11-20', date_updated: '2025-11-20',
        is_new: true,
        available_from: '2025-11-20T00:00:00Z', available_to: '2026-02-13T23:59:59Z'
      },
      {
        id: 'advent', type: 'game', emoji: 'üéÑ', title: 'Festive Advent', href: 'advent.html',
        desc: 'Unlock daily festive surprises, each hiding a cheerful mini-game or cozy activity. Progress is saved locally.',
        tags: ['Seasonal', 'Mini-games'],
        date_added: '2025-11-01', date_updated: '2025-11-29',
        is_new: true,
        available_from: '2025-11-01T00:00:00Z', available_to: '2026-01-31T23:59:59Z'
      },
      {
        id: 'lumen-drift', type: 'game', emoji: 'üèÆ', title: 'Lumen Drift', href: 'lumen-drift.html',
        desc: 'Guide an astral lantern through drifting currents, collect glints, dodge dusk shadows, and chase ever-longer drifts.',
        tags: ['Relaxing', 'Arcade', 'Atmospheric'],
        date_added: '2024-01-10', date_updated: '2024-06-15'
      },
      {
        id: 'space-trader', type: 'game', emoji: 'üõ∏', title: 'Space Trader', href: 'space-trader.html',
        desc: 'Retro space trading adventure in a deterministic procedural galaxy. Trade, haggle, refuel, and travel across systems.',
        tags: ['Trading', 'Procedural', 'Space', 'Retro'],
        date_added: '2023-12-01', date_updated: '2024-08-20'
      },
      {
        id: 'sheepdog', type: 'game', emoji: 'üêï', title: 'Sheepdog', href: 'sheepdog.html',
        desc: 'Guide your border collie to herd fluffy sheep into their paddocks. Sort black and white sheep, manage stubborn ones.',
        tags: ['Herding', 'Puzzle', 'Cute'],
        date_added: '2025-10-05', date_updated: '2025-10-05',
        is_new: true
      },
      {
        id: 'ballistic', type: 'game', emoji: 'üéØ', title: 'Ballistic Warfare', href: 'ballistic.html',
        desc: 'Turn-based artillery duel featuring rolling grenades, homing missiles, destructible terrain, and mobile-friendly controls.',
        tags: ['Artillery', 'Physics', 'Multiplayer'],
        date_added: '2024-03-15', date_updated: '2024-03-15'
      },
      {
        id: 'fit-shapes', type: 'game', emoji: 'üß©', title: 'Fit the Shapes', href: 'fit-the-shapes.html',
        desc: 'Tetris-inspired puzzle game with special diamond and lava pieces. Place shapes strategically to clear rows.',
        tags: ['Puzzle', 'Strategy'],
        date_added: '2024-02-20', date_updated: '2024-02-20'
      },
      {
        id: 'jigsaw', type: 'game', emoji: 'üß©', title: 'Jigsaw Puzzle', href: 'jigsaw.html',
        desc: 'Import an image and solve a satisfying jigsaw with interlocking pieces. Drag, snap, pan, and pinch-zoom.',
        tags: ['Puzzle', 'Touch'],
        date_added: '2024-04-10', date_updated: '2024-04-10'
      },
      {
        id: 'garden', type: 'game', emoji: 'üå∏', title: 'Garden Grower', href: 'garden-grower.html',
        desc: 'A calm, plant-themed memory match game. Flip cards, find matching garden symbols, and clear the board.',
        tags: ['Memory', 'Puzzle', 'Relaxing'],
        date_added: '2024-05-01', date_updated: '2024-05-01'
      },
      {
        id: 'scroller', type: 'game', emoji: 'üöÄ', title: 'Space Scroller', href: 'space-scroller.html',
        desc: 'Navigate through space in this endless scrolling adventure. Dodge obstacles, collect power-ups.',
        tags: ['Action', 'Endless', 'Space'],
        date_added: '2024-01-20', date_updated: '2024-01-20'
      },
      {
        id: 'yahtzee', type: 'game', emoji: 'üé≤', title: 'Yahtzee', href: 'yahtzee.html',
        desc: 'Classic dice game with a challenging twist! Roll for combinations, score strategically, and aim for the perfect Yahtzee.',
        tags: ['Dice', 'Strategy', 'Classic'],
        date_added: '2024-07-01', date_updated: '2024-07-01'
      },
      {
        id: 'fossil', type: 'game', emoji: 'ü¶¥', title: 'Fossil Hunter', href: 'fossil.html',
        desc: 'Archaeological discovery game with realistic sand brushing mechanics. Excavate ancient fossils.',
        tags: ['Archaeology', 'Discovery', 'Educational'],
        date_added: '2024-09-10', date_updated: '2024-09-10'
      },
      {
        id: 'am-radio', type: 'tool', emoji: 'üìª', title: 'AM Radio Console', href: 'am-radio.html',
        desc: 'Load any audio loop into a vintage AM receiver with tuning static, fine-grain touch control, and animated gauges.',
        tags: ['Audio', 'Retro', 'Visualizer'],
        date_added: '2025-08-15', date_updated: '2025-08-15',
        is_new: true
      },
      {
        id: 'starmap', type: 'tool', emoji: 'üõ∞Ô∏è', title: 'Space Trader Starmap', href: 'space-trader-db.html',
        desc: 'Explore the procedural galaxy from Space Trader with zoomable starmaps, orbit lighting, and search.',
        tags: ['Space', 'Atlas', 'Reference'],
        date_added: '2025-09-01', date_updated: '2025-09-01',
        is_new: true
      },
      {
        id: 'dictaphone', type: 'tool', emoji: 'üéôÔ∏è', title: 'Dictaphone', href: 'dictaphone.html',
        desc: 'Professional audio recording tool with real-time position seeking, volume control, and export capabilities.',
        tags: ['Audio', 'Recording', 'Utility'],
        date_added: '2024-02-01', date_updated: '2024-02-01'
      },
      {
        id: 'feedcycle', type: 'tool', emoji: 'üåÄ', title: 'Feed Cycle', href: 'feedcycle.html',
        desc: 'Local-first RSS/Atom reader with OPML tools, media playback, smart tagging, filters, and themes.',
        tags: ['Reader', 'Utility', 'Local'],
        date_added: '2023-11-01', date_updated: '2025-01-15'
      },
      {
        id: 'spinners', type: 'tool', emoji: 'üé°', title: 'Smart Spinners', href: 'spinners.html',
        desc: 'Create unlimited customizable spin wheels with per-wheel palettes, advanced spin physics, and accessible inline results.',
        tags: ['Randomizer', 'Classroom', 'Utility'],
        date_added: '2025-10-20', date_updated: '2025-10-20',
        is_new: true
      },
      {
        id: 'timers', type: 'tool', emoji: '‚è±Ô∏è', title: 'Timers Studio', href: 'timers.html',
        desc: 'Run infinite countdown timers with customizable durations, per-timer sound/notification overrides.',
        tags: ['Productivity', 'Utility'],
        date_added: '2025-10-25', date_updated: '2025-10-25',
        is_new: true
      },
      {
        id: 'voxel', type: 'tool', emoji: 'üßä', title: 'Voxel Paint Studio', href: 'voxel-paint.html',
        desc: 'Create illuminated 3D voxel dioramas with lighting controls, SSAO, nav cube navigation, and export tools.',
        tags: ['3D', 'Creative', 'Tool'],
        date_added: '2024-05-15', date_updated: '2024-05-15'
      },
      {
        id: 'po', type: 'tool', emoji: 'üóÇÔ∏è', title: 'Personal Organiser', href: 'po.html',
        desc: 'Complete productivity suite with accessible material UI. Manage notes, calendar events, tasks, cards.',
        tags: ['Productivity', 'Utility', 'Local'],
        date_added: '2024-01-05', date_updated: '2024-08-10'
      },
      {
        id: 'rpm', type: 'tool', emoji: 'üíø', title: 'RPM Disc Encoder', href: 'rpm.html',
        desc: 'Encode short audio clips into a visual "RPM" disc PNG and decode them back.',
        tags: ['Audio', 'Tool', 'Experimental'],
        date_added: '2024-03-01', date_updated: '2024-03-01'
      },
      {
        id: 'qrloop', type: 'tool', emoji: 'üîÑ', title: 'QR Loop', href: 'qrloop.html',
        desc: 'Advanced file transfer via chunked QR codes. Transfer files of any size by automatically cycling through QR codes.',
        tags: ['QR Code', 'Utility', 'Transfer'],
        date_added: '2024-06-01', date_updated: '2024-06-01'
      }
    ];

    // --- STATE ---
    const STATE = {
      search: '',
      sort: 'newest', // newest, updated, name
      category: 'all',
      favoritesOnly: false,
      favorites: new Set(),
      parentalAllowed: {}
    };

    // --- INIT ---
    function init() {
      document.getElementById('year').textContent = new Date().getFullYear();
      
      // Load Favorites
      try {
        const saved = JSON.parse(localStorage.getItem('idlegames-favorites') || '[]');
        // Filter out invalid IDs (cleanup)
        const validIds = new Set(DATA.map(d => d.id));
        const cleanFaves = saved.filter(id => validIds.has(id));
        STATE.favorites = new Set(cleanFaves);
        if (cleanFaves.length !== saved.length) {
          saveFavorites();
        }
      } catch (e) { console.error('Error loading favorites', e); }

      // Load UI State
      try {
        const savedUI = JSON.parse(localStorage.getItem('idlegames-ui-state') || '{}');
        if (savedUI.sort) STATE.sort = savedUI.sort;
        if (savedUI.category) STATE.category = savedUI.category;
        if (savedUI.favoritesOnly !== undefined) STATE.favoritesOnly = savedUI.favoritesOnly;
      } catch (e) { console.error('Error loading UI state', e); }

      // Load Theme
      const savedTheme = localStorage.getItem('launcher-theme') || 'system';
      // Find index
      currentThemeIndex = THEMES.indexOf(savedTheme);
      if (currentThemeIndex === -1) currentThemeIndex = 0;
      applyTheme(savedTheme);

      // Populate Categories
      const categories = new Set(DATA.flatMap(d => d.tags));
      const catSelect = document.getElementById('category-select');
      [...categories].sort().forEach(cat => {
        const opt = document.createElement('option');
        opt.value = cat;
        opt.textContent = cat;
        catSelect.appendChild(opt);
      });

      // Apply UI State to Controls
      document.getElementById('sort-select').value = STATE.sort;
      
      // Check if category exists
      const catExists = [...catSelect.options].some(o => o.value === STATE.category);
      if (catExists) {
        catSelect.value = STATE.category;
      } else {
        STATE.category = 'all';
        catSelect.value = 'all';
      }

      if (STATE.favoritesOnly) {
        document.getElementById('fave-filter-btn').classList.add('active');
      }

      // Event Listeners
      document.getElementById('search-input').addEventListener('input', (e) => { STATE.search = e.target.value; render(); });
      document.getElementById('sort-select').addEventListener('change', (e) => { 
        STATE.sort = e.target.value; 
        saveUIState();
        render(); 
      });
      document.getElementById('category-select').addEventListener('change', (e) => { 
        STATE.category = e.target.value; 
        saveUIState();
        render(); 
      });
      document.getElementById('fave-filter-btn').addEventListener('click', toggleFavoritesFilter);
      document.getElementById('theme-toggle').addEventListener('click', cycleTheme);

      // Initial Render
      render();
      
      // Load Parental Script
      loadParental();
    }

    // --- LOGIC ---
    function saveFavorites() {
      localStorage.setItem('idlegames-favorites', JSON.stringify([...STATE.favorites]));
    }

    function saveUIState() {
      const uiState = {
        sort: STATE.sort,
        category: STATE.category,
        favoritesOnly: STATE.favoritesOnly
      };
      localStorage.setItem('idlegames-ui-state', JSON.stringify(uiState));
    }

    function toggleFavorite(id, btn) {
      if (STATE.favorites.has(id)) {
        STATE.favorites.delete(id);
        btn.classList.remove('is-fave');
        btn.innerHTML = '‚ô°';
      } else {
        STATE.favorites.add(id);
        btn.classList.add('is-fave');
        btn.innerHTML = '‚ù§Ô∏è';
      }
      saveFavorites();
      // If we are in favorites-only mode, re-render to remove the item
      if (STATE.favoritesOnly) render();
    }

    function toggleFavoritesFilter() {
      STATE.favoritesOnly = !STATE.favoritesOnly;
      const btn = document.getElementById('fave-filter-btn');
      btn.classList.toggle('active', STATE.favoritesOnly);
      saveUIState();
      render();
    }

    // --- THEME MANAGEMENT ---
    const THEMES = ['system', 'light', 'dark'];
    let currentThemeIndex = 0;

    function applyTheme(theme) {
      const root = document.documentElement;
      if (theme === 'system') {
        const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        root.setAttribute('data-theme', isDark ? 'dark' : 'light');
      } else {
        root.setAttribute('data-theme', theme);
      }
      localStorage.setItem('launcher-theme', theme);
      updateThemeButton(theme);
    }

    function updateThemeButton(theme) {
      const btn = document.getElementById('theme-toggle');
      const icons = { system: 'üåì', light: '‚òÄÔ∏è', dark: 'üåô' };
      const titles = { system: 'System Theme', light: 'Light Mode', dark: 'Dark Mode' };
      btn.textContent = icons[theme];
      btn.title = titles[theme];
    }

    function cycleTheme() {
      currentThemeIndex = (currentThemeIndex + 1) % THEMES.length;
      const theme = THEMES[currentThemeIndex];
      applyTheme(theme);
    }

    function getFilteredData() {
      let items = DATA.filter(item => {
        // Search
        if (STATE.search) {
          const q = STATE.search.toLowerCase();
          const match = item.title.toLowerCase().includes(q) || 
                        item.desc.toLowerCase().includes(q) || 
                        item.tags.some(t => t.toLowerCase().includes(q));
          if (!match) return false;
        }
        // Category
        if (STATE.category !== 'all') {
          if (STATE.category === 'game' && item.type !== 'game') return false;
          if (STATE.category === 'tool' && item.type !== 'tool') return false;
          if (STATE.category !== 'game' && STATE.category !== 'tool' && !item.tags.includes(STATE.category)) return false;
        }
        // Favorites
        if (STATE.favoritesOnly && !STATE.favorites.has(item.id)) return false;
        
        // Parental
        if (isParentalLocked(item.href)) return false; // Or show locked state? Let's hide for now or show locked card
        
        return true;
      });

      // Sort
      items.sort((a, b) => {
        if (STATE.sort === 'newest') return new Date(b.date_added) - new Date(a.date_added);
        if (STATE.sort === 'updated') return new Date(b.date_updated) - new Date(a.date_updated);
        if (STATE.sort === 'name') return a.title.localeCompare(b.title);
        return 0;
      });

      return items;
    }

    function isParentalLocked(href) {
      // Check if parental controls are active and this item is disallowed
      // This logic mirrors the original index.html
      try {
        if (window.parental && window.parental.isEnabled && window.parental.isEnabled()) {
          if (!window.parental.isLoggedIn()) {
             const allowed = window.parental.getAllowedMap() || {};
             if (allowed[href] === false) return true;
          }
        }
      } catch(e) {}
      return false;
    }

    function render() {
      const grid = document.getElementById('games-grid');
      const items = getFilteredData();
      
      grid.innerHTML = '';
      
      if (items.length === 0) {
        grid.innerHTML = `
          <div class="empty-state">
            <span class="empty-icon">üèúÔ∏è</span>
            <h3>No items found</h3>
            <p>Try adjusting your filters or search terms.</p>
          </div>`;
        return;
      }

      items.forEach(item => {
        const isFave = STATE.favorites.has(item.id);
        const card = document.createElement('div');
        card.className = 'card';
        
        // Availability Check
        let availabilityLabel = '';
        let isAvailable = true;
        if (item.available_from || item.available_to) {
           const now = new Date();
           const from = item.available_from ? new Date(item.available_from) : null;
           const to = item.available_to ? new Date(item.available_to) : null;
           
           if (from && now < from) {
             isAvailable = false;
             availabilityLabel = `Opens ${from.toLocaleDateString()}`;
           } else if (to && now > to) {
             isAvailable = false;
             availabilityLabel = `Ended ${to.toLocaleDateString()}`;
           }
        }

        let badgeHtml = '';
        if (item.is_new) badgeHtml = '<span class="badge badge-new">New</span>';
        else if (item.is_beta) badgeHtml = '<span class="badge badge-beta">Beta</span>';
        
        if (!isAvailable) {
           badgeHtml = `<span class="badge badge-leaving">${availabilityLabel}</span>`;
           card.style.opacity = '0.7';
        }

        card.innerHTML = `
          ${badgeHtml}
          <a href="${item.href}" class="card-preview" aria-label="Open ${item.title}">
            ${item.emoji}
          </a>
          <div class="card-body">
            <div class="card-header">
              <h3 class="card-title">${item.title}</h3>
            </div>
            <p class="card-desc">${item.desc}</p>
            <div class="card-meta">
              ${item.tags.map(t => `<span class="tag">${t}</span>`).join('')}
            </div>
            <div class="card-actions">
              <button class="btn-fave ${isFave ? 'is-fave' : ''}" onclick="toggleFavorite('${item.id}', this)" title="Toggle Favorite">
                ${isFave ? '‚ù§Ô∏è' : '‚ô°'}
              </button>
              ${isAvailable 
                ? `<a href="${item.href}" class="btn-play">Open</a>` 
                : `<span class="btn-play" style="background:var(--text-muted);cursor:not-allowed">Locked</span>`
              }
            </div>
          </div>
        `;
        
        // Parental Admin Checkbox Injection
        if (window.parental && window.parental.isLoggedIn && window.parental.isLoggedIn()) {
           const adminDiv = document.createElement('div');
           adminDiv.style.marginTop = '0.5rem';
           adminDiv.style.fontSize = '0.8rem';
           const allowed = window.parental.getAllowedMap();
           const isAllowed = allowed[item.href] !== false;
           adminDiv.innerHTML = `<label><input type="checkbox" ${isAllowed ? 'checked' : ''} onchange="window.parental.setAllowedFor('${item.href}', this.checked)"> Visible when Locked</label>`;
           card.querySelector('.card-body').appendChild(adminDiv);
        }

        grid.appendChild(card);
      });
    }

    // --- PARENTAL CONTROLS ---
    // Copied and adapted from index.html
    function loadParental() {
      const s = document.createElement('script');
      s.src = 'parental.js';
      s.defer = true;
      s.onload = () => {
        // Re-render when parental script loads to apply locks
        setTimeout(render, 100);
      };
      document.body.appendChild(s);
      
      // Setup Modal (Simplified for index2)
      setupParentalModal();
    }

    function setupParentalModal() {
      // Create modal HTML
      const modal = document.createElement('div');
      modal.id = 'parental-modal';
      modal.style.cssText = 'position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.5);z-index:100;backdrop-filter:blur(4px);';
      modal.innerHTML = `
        <div style="background:var(--bg-card); padding:2rem; border-radius:var(--radius-xl); max-width:400px; width:90%; box-shadow:var(--shadow-lg); border:1px solid var(--border-color);">
          <h3 style="margin-bottom:1rem; color:var(--text-main);">Parental Controls</h3>
          <div id="p-content"></div>
          <div style="margin-top:1.5rem; text-align:right;">
            <button onclick="document.getElementById('parental-modal').style.display='none'" style="padding:0.5rem 1rem; background:transparent; border:1px solid var(--border-color); border-radius:var(--radius-md); cursor:pointer; color:var(--text-main);">Close</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);

      document.getElementById('parental-btn').addEventListener('click', () => {
        const content = document.getElementById('p-content');
        const isEnabled = window.parental && window.parental.isEnabled();
        const isLoggedIn = window.parental && window.parental.isLoggedIn();

        if (!isEnabled) {
          content.innerHTML = `
            <p style="margin-bottom:1rem; color:var(--text-muted);">Set a password to enable parental controls.</p>
            <input type="password" id="p-pass1" placeholder="Password" style="width:100%; padding:0.5rem; margin-bottom:0.5rem; border:1px solid var(--border-color); border-radius:var(--radius-md);">
            <input type="password" id="p-pass2" placeholder="Confirm Password" style="width:100%; padding:0.5rem; margin-bottom:1rem; border:1px solid var(--border-color); border-radius:var(--radius-md);">
            <button id="p-enable-btn" style="width:100%; padding:0.75rem; background:var(--accent-primary); color:white; border:none; border-radius:var(--radius-md); cursor:pointer;">Enable Controls</button>
          `;
          document.getElementById('p-enable-btn').onclick = async () => {
            const p1 = document.getElementById('p-pass1').value;
            const p2 = document.getElementById('p-pass2').value;
            if (p1 && p1 === p2) {
              await window.parental.setPassword(p1);
              modal.style.display = 'none';
              render();
            } else {
              alert('Passwords must match');
            }
          };
        } else if (!isLoggedIn) {
          content.innerHTML = `
            <p style="margin-bottom:1rem; color:var(--text-muted);">Enter password to manage settings.</p>
            <input type="password" id="p-login-pass" placeholder="Password" style="width:100%; padding:0.5rem; margin-bottom:1rem; border:1px solid var(--border-color); border-radius:var(--radius-md);">
            <button id="p-login-btn" style="width:100%; padding:0.75rem; background:var(--accent-primary); color:white; border:none; border-radius:var(--radius-md); cursor:pointer;">Unlock Admin Mode</button>
          `;
          document.getElementById('p-login-btn').onclick = async () => {
            const pass = document.getElementById('p-login-pass').value;
            if (await window.parental.verifyPassword(pass)) {
              modal.style.display = 'none';
              render();
            } else {
              alert('Incorrect password');
            }
          };
        } else {
          content.innerHTML = `
            <p style="margin-bottom:1rem; color:var(--text-muted);">Admin Mode Active. You can now toggle visibility on each game card.</p>
            <div style="display:flex; gap:0.5rem; flex-direction:column;">
              <button id="p-lock-btn" style="width:100%; padding:0.75rem; background:var(--accent-secondary); color:white; border:none; border-radius:var(--radius-md); cursor:pointer;">Lock & Exit Admin</button>
              <button id="p-disable-btn" style="width:100%; padding:0.75rem; background:#e53e3e; color:white; border:none; border-radius:var(--radius-md); cursor:pointer;">Disable Controls</button>
            </div>
          `;
          document.getElementById('p-lock-btn').onclick = () => {
            window.parental.signOut();
            modal.style.display = 'none';
            render();
          };
          document.getElementById('p-disable-btn').onclick = () => {
            if(confirm('Disable all controls?')) {
              window.parental.disable();
              modal.style.display = 'none';
              render();
            }
          };
        }
        
        modal.style.display = 'flex';
      });
    }

    // Footer Panel Logic
    window.toggleFooterPanel = function(panelId) {
      const details = document.getElementById('footer-details');
      const contentMap = {
        'privacy': '<h3>Privacy Policy</h3><p>This site is local-first. We do not collect analytics or track you. Data is stored in your browser\'s LocalStorage.</p>',
        'terms': '<h3>Terms of Use</h3><p>Provided as-is for entertainment. No warranties.</p>',
        'a11y': '<h3>Accessibility</h3><p>We strive for WCAG compliance with keyboard navigation, high contrast, and screen reader support.</p>'
      };
      
      if (details.style.display === 'block' && details.dataset.active === panelId) {
        details.style.display = 'none';
      } else {
        details.innerHTML = contentMap[panelId] || '';
        details.style.display = 'block';
        details.dataset.active = panelId;
      }
    }

    // Start
    init();
  </script>
</body>
</html>
