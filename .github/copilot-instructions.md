# IdleGames project instructions

_A quick orientation for AI agents contributing to this repo._

## Repo at a glance
- **Type:** static HTML5/CSS3/Vanilla JS Progressive Web App with many self-contained mini games/utilities, each shipped as its own `.html` file at the repo root.
- **Key runtime folders:**
  - `assets/`
    - `appicons/` – PWA icon set referenced by `manifest.webmanifest` and individual pages.
    - `audio/` – shared sound FX/music snippets.
    - `fonts/` – contains Inter + DSEG7 font assets; `assets/js/version.js` imports from here during build.
    - `js/pwa.js` – registers/upgrades the versioned service worker and handles in-app refresh prompts. `version.js` is generated by the build; never edit by hand.
  - `scripts/` – build tooling:
    - `build-sw.mjs` copies the site into `dist/`, vendors third-party libs (Three.js, QRious, jsQR, Transformers.js), copies fonts, and emits a precache list + service worker by templating `sw.template.js`.
  - `dist/` – generated build output identical to what ships to GitHub Pages/any static host. Safe to delete; recreated by the build.
- **Other important files:** `manifest.webmanifest`, `package.json` (Node 18+/20 LTS), `feedcycle.*` (largest SPA), `parental.js` (launcher parental controls), `build.sh` (helper wrapper that just runs the npm build pipeline).

## Build & serve workflow
1. Install dependencies: `npm install`
2. Build distributable: `npm run build`
   - Runs `copy-fonts`, writes `assets/js/version.js` with the `package.json` version, wipes/recreates `dist/`, copies all HTML/assets (excluding tooling directories), rewrites bare `three` imports, vendors fonts + JS dependencies, and generates `dist/sw.js` with a fresh precache list.
3. Optional clean: `npm run clean` (removes `dist/`).
4. Preview with service worker behaviour: `npm run serve` (builds, then serves `dist/` on port 4173 via `http-server`).

> **Note:** Because `version.js` is regenerated at build time, avoid committing manual edits to it. Update the version via `package.json` instead.

## Authoring guidelines
- Pages are plain HTML modules; no bundler. Keep `<script type="module">` entries self-contained or import shared helpers from `assets/js/`.
- Prefer vendoring third-party libs through the build pipeline rather than CDN URLs. If you need a new dependency, add it to `package.json` and extend `scripts/build-sw.mjs` so it’s copied into `dist/assets/vendor/`.
- Each new HTML mini-app should include the common favicon/meta block and, when it needs offline support, the `assets/js/pwa.js` loader.
- Long-lived state should use `localStorage` (existing pages follow namespaced keys like `idlegames-*`).
- When touching service-worker-adjacent code, ensure the version handshake (`idle-games-sw-version` messages) stays intact so users receive update prompts.

## Parental controls integration
- `index.html` owns the parental-control configuration (password modal copy, allowed/blocked flags, and the list of game IDs). Update the data there when adding or removing entries so the launcher exposes the correct toggles.
- Enforcement logic lives in `parental.js`. Every playable HTML page includes this script in its tail section (usually the last few lines) so hidden titles stay inaccessible even if a user opens the page directly.
- When creating a new page, copy the existing pattern: load your game scripts, then finish with `<script src="parental.js" defer></script>` (and `assets/js/pwa.js` if needed) so the parental gating and launcher stay in sync.

## ⚠️ CRITICAL: Service Worker URL Handling
**This section exists because of a production outage that stranded users with broken PWAs.**

### The Problem
Users share and bookmark the site as `https://timelessp.github.io/idlegames/` (trailing slash, no `index.html`). When the PWA launches, it requests this exact URL. If the service worker can't find it in cache, the app shows a blank screen — and because the SW blocks loading, users can never receive the fix.

### The Solution (Already Implemented)
The service worker in `scripts/sw.template.js` **normalizes directory URLs** to their index file before cache lookup:
```javascript
// Normalize /idlegames/ → /idlegames/index.html
if (requestURL.pathname.endsWith('/')) {
  const indexUrl = new URL(requestURL.href);
  indexUrl.pathname = requestURL.pathname + 'index.html';
  normalizedRequest = new Request(indexUrl.href, ...);
}
```

### Rules to Prevent Future Breakage
1. **NEVER remove or break the URL normalization logic** in `sw.template.js`. It's load-bearing.
2. **Test PWA cold starts** with the exact URL users have bookmarked (`/idlegames/`, not `/idlegames/index.html`).
3. **Test with Chrome completely closed** on mobile, then launch the PWA icon — this is the "cold start" scenario.
4. Service worker bugs are **unrecoverable for end users** — the broken SW prevents the fix from loading. Triple-check any SW changes.
5. The `manifest.webmanifest` has `"start_url": "./index.html"` but Android/Chrome may still request the directory URL on launch.

### Testing Checklist for SW Changes
- [ ] `npm run build && npm run serve`
- [ ] Open `http://localhost:4173/` (trailing slash) — should load
- [ ] Open `http://localhost:4173/index.html` — should load  
- [ ] Install as PWA, close browser completely, tap PWA icon — should load
- [ ] Airplane mode after install — should load from cache

## Deployment/release expectations
1. **Bump Version:** Update `package.json` version (+0.0.1).
2. **Build:** Run `npm install && npm run build`. This updates `package-lock.json` and regenerates `assets/js/version.js`.
3. **Push:** Commit *all* changed files and push to `main`. The GitHub Action `build-and-deploy.yml` handles the rest.

**Pro Tip:** We use the **"GitHub Actions"** source setting in GitHub Pages (not "Deploy from a branch"). This prevents the default Pages workflow from racing with our custom PWA build. If deployments break, check that this setting hasn't reverted!

## Tips for future contributors
- The repo intentionally avoids frameworks; stick to minimal dependencies to keep load times low for slow devices.
- Many HTML files share CSS variables/utility classes; check each file’s `<style>` block before adding duplicate styles.
- Accessibility/theme toggles: follow the pattern established in pages like `feedcycle.html` (prefers `prefers-color-scheme` + persistent choice).
- For new audio, keep file sizes small and place them under `assets/audio/`; reference via relative paths so the service worker precaches them automatically.
- If you need to update icons or manifest data, ensure `manifest.webmanifest` stays in sync with actual files under `assets/appicons/`.

Use this document as a living reference—update it whenever repo conventions evolve so future agents can ramp up quickly.

## Skills

- **pwa-development**
  - **Use when:** creating or refining offline-capable PWAs, service worker caching/versioning behavior, and install/manifest flows for this repo.
  - **File:** `.github/skills/pwa-development/SKILL.md`

- **game-menu-system**
  - **Use when:** building data-driven, attribute-controlled, non-blocking game menus that preserve simulation and support in-place value updates.
  - **File:** `.github/skills/game-menu-system/SKILL.md`

- **sidescroller-spa-game-dev**
  - **Use when:** building or refining production-quality side-scroller SPA games in this repo (single-file HTML/CSS/JS, SVG camera systems, robust controls, modal UX, and mobile/PWA polish).
  - **File:** `.github/skills/sidescroller-spa-game-dev/SKILL.md`
