<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <link rel="manifest" href="manifest.webmanifest">
    <meta name="application-name" content="IdleGames">
    <script src="assets/js/pwa.js" defer></script>
    <meta name="theme-color" content="#667eea">
    <title>Memory Game</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <style>
        :root {
            color-scheme: light dark;
            --bg-body: #f8f9fa;
            --bg-secondary: #ffffff;
            --text-main: #2d3748;
            --text-muted: #718096;
            --border-color: #e2e8f0;
            --accent-primary: #667eea;
            --accent-hover: #5a67d8;
            --card-bg: #ffffff;
            --card-fg: #2d3748;
            --card-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            --modal-bg: rgba(0, 0, 0, 0.5);
            --success-color: #10b981;
            --error-color: #ef4444;
            --celebrate-amp: 3deg;
            --pulse-color: rgba(102, 126, 234, 0.35);
            --pulse-color-strong: rgba(102, 126, 234, 0.55);
            --pulse-color-soft: rgba(102, 126, 234, 0.18);
        }

        [data-theme="light"] {
            --bg-body: #f8f9fa;
            --bg-secondary: #ffffff;
            --text-main: #2d3748;
            --text-muted: #718096;
            --border-color: #e2e8f0;
            --accent-primary: #667eea;
            --accent-hover: #5a67d8;
            --card-bg: #ffffff;
            --card-fg: #2d3748;
            --card-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            --modal-bg: rgba(0, 0, 0, 0.5);
        }

        [data-theme="dark"] {
            --bg-body: #1a1a2e;
            --bg-secondary: #16213e;
            --text-main: #eee;
            --text-muted: #a0aec0;
            --border-color: #2a3f5f;
            --accent-primary: #667eea;
            --accent-hover: #5a67d8;
            --card-bg: #0f3460;
            --card-fg: #eee;
            --card-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            --modal-bg: rgba(0, 0, 0, 0.8);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            width: 100%;
            height: 100%;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: var(--bg-body);
            color: var(--text-main);
            line-height: 1.5;
            transition: background-color 0.3s ease, color 0.3s ease;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            gap: 1rem;
            flex-shrink: 0;
        }

        .header-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-main);
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Buttons */
        button {
            font-family: inherit;
            color: inherit;
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 200ms ease, transform 150ms ease;
            user-select: none;
            -webkit-user-select: none;
        }

        button:not(.menu-item):not(.card):hover {
            background: var(--accent-primary);
            color: white;
        }

        button:active {
            transform: scale(0.95);
        }

        button:focus-visible {
            outline: 2px solid var(--accent-primary);
            outline-offset: 2px;
        }

        .icon-button {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
        }

        /* Main game area */
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 1rem;
            gap: 1rem;
            overflow: hidden;
            min-height: 0;
        }

        .stats {
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 1.25rem;
            font-weight: 600;
        }

        /* Game board */
        .board-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            min-height: 0;
            padding: 0;
            width: 100%;
            height: 100%;
        }

        .board {
            display: grid;
            gap: 0.5rem;
            grid-template-columns: repeat(var(--grid-size, 2), minmax(0, 1fr));
            grid-auto-rows: 1fr;
            width: 100%;
            height: 100%;
            padding: 0.25rem;
            max-width: 100%;
            max-height: 100%;
            box-sizing: border-box;
        }

        @media (max-width: 480px) {
            .board {
                gap: 0.35rem;
            }
        }

        .card {
            aspect-ratio: 1;
            border: none;
            border-radius: 0.5rem;
            box-shadow: var(--card-shadow);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: calc(var(--tile-size, 48px) * 0.65);
            font-family: "Apple Color Emoji", "Segoe UI Emoji", "Noto Color Emoji", "Twemoji Mozilla", system-ui, sans-serif;
            font-variant-emoji: emoji;
            cursor: pointer;
            transition: all 150ms ease;
            padding: 0;
            line-height: 1;
            perspective: 900px;
            background: transparent;
            position: relative;
            z-index: 0;
        }

        .card-inner {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 380ms ease;
            border-radius: 0.5rem;
        }

        .card-spin {
            width: 100%;
            height: 100%;
            transform-style: preserve-3d;
            border-radius: 0.5rem;
        }

        .card.flipped .card-inner,
        .card.matched .card-inner {
            transform: rotateY(180deg);
        }

        .card-face {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.5rem;
            backface-visibility: hidden;
            box-shadow: var(--card-shadow);
        }

        .card-front {
            background: var(--accent-primary);
            color: white;
            transform: rotateY(180deg);
        }

        @keyframes card-jiggle {
            0% { transform: rotateZ(0deg); }
            25% { transform: rotateZ(2deg); }
            50% { transform: rotateZ(0deg); }
            75% { transform: rotateZ(-2deg); }
            100% { transform: rotateZ(0deg); }
        }

        @keyframes card-pulse {
            0% { box-shadow: none; opacity: 0; }
            50% {
                opacity: 1;
                box-shadow:
                    0 0 0 calc(var(--pulse-size, 6px) * 0.35) var(--pulse-color-strong, rgba(102, 126, 234, 0.55)),
                    0 0 0 calc(var(--pulse-size, 6px) * 0.7) var(--pulse-color),
                    0 0 0 calc(var(--pulse-size, 6px) * 1.1) var(--pulse-color-soft, rgba(102, 126, 234, 0.18)),
                    0 0 0 calc(var(--pulse-size, 6px) * 1.45) rgba(0, 0, 0, 0);
            }
            100% { box-shadow: none; opacity: 0; }
        }

        @keyframes card-celebrate {
            0% { transform: rotateZ(calc(var(--celebrate-offset, 0deg) + var(--celebrate-amp))); }
            50% { transform: rotateZ(calc(var(--celebrate-offset, 0deg) - var(--celebrate-amp))); }
            100% { transform: rotateZ(calc(var(--celebrate-offset, 0deg) + var(--celebrate-amp))); }
        }

        @keyframes card-spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .card.jiggle {
            animation: card-jiggle 400ms ease-in-out 0s 5;
        }

        .card.pulse::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 0.7rem;
            background: transparent;
            pointer-events: none;
            opacity: 0;
            animation: card-pulse 1100ms ease-out 0s 1;
        }

        .card.pulse {
            z-index: 2;
        }

        .board.celebrate .card {
            animation: card-celebrate 600ms ease-in-out infinite;
        }

        .board.celebrate .card-spin {
            animation: card-spin 150ms linear 1;
        }

        .card-back {
            background-color: var(--card-back, #e5e7eb);
            background-image: var(--card-pattern, none);
            background-repeat: repeat;
            background-size: var(--card-pattern-size, 80px) var(--card-pattern-size, 80px);
            background-position: center;
            background-clip: content-box;
            background-origin: content-box;
            padding: 0.35rem;
        }

        .card:hover:not(.matched):not(.flipped) {
            box-shadow: var(--card-shadow);
        }

        .card.flipped {
            color: white;
        }

        .card.matched {
            cursor: default;
        }

        .card.flipped.matched {
            background: var(--success-color);
        }

        /* Menu */
        .menu-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--modal-bg);
            display: none;
            z-index: 999;
            flex-direction: column;
        }

        .menu-container.open {
            display: flex;
        }

        .menu-panel {
            position: absolute;
            top: 0;
            left: 0;
            width: min(100%, 320px);
            height: 100%;
            background: var(--bg-secondary);
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.2);
            overflow-y: auto;
            animation: slideIn 300ms ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(-100%);
            }
            to {
                transform: translateX(0);
            }
        }

        .menu-close {
            align-self: flex-end;
            margin: 1rem;
        }

        .menu-title {
            font-size: 1.25rem;
            font-weight: 700;
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .menu-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .menu-section {
            margin-bottom: 1.5rem;
        }

        .menu-section-title {
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-muted);
            letter-spacing: 0.5px;
            margin-bottom: 0.75rem;
        }

        .menu-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .menu-group-spaced {
            margin-bottom: 0.75rem;
        }

        .menu-item {
            padding: 0.75rem 1rem;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: background 200ms ease;
            text-align: left;
            font-size: 0.95rem;
            background: none;
            border: none;
            width: 100%;
            color: inherit;
        }

        .menu-item[disabled] {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .menu-item[disabled]:hover {
            background: none;
        }

        .menu-item:hover {
            background: var(--bg-body);
            color: var(--text-main);
        }

        .menu-item-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }

        /* Checkbox */
        .checkbox {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }

        .checkbox input {
            width: 1.125rem;
            height: 1.125rem;
            cursor: pointer;
        }

        .checkbox input:focus-visible {
            outline: 2px solid var(--accent-primary);
            outline-offset: 2px;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--modal-bg);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
        }

        .modal.open {
            display: flex;
        }

        .modal-content {
            background: var(--bg-secondary);
            border-radius: 0.75rem;
            padding: 2rem 1.5rem;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--text-main);
        }

        .modal-body {
            font-size: 0.95rem;
            line-height: 1.6;
            color: var(--text-main);
            margin-bottom: 1.5rem;
        }

        .modal-body p {
            margin-bottom: 1rem;
        }

        .modal-body a {
            color: var(--accent-primary);
            text-decoration: none;
        }

        .modal-body a:hover {
            text-decoration: underline;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .copy-status {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-right: auto;
        }

        .primary-button {
            background: var(--accent-primary);
            color: white;
            padding: 0.65rem 1.5rem;
            border-radius: 0.375rem;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: background 200ms ease, transform 150ms ease;
            font-family: inherit;
        }

        .primary-button:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
        }

        .primary-button:active {
            transform: translateY(0);
        }

        .primary-button:focus-visible {
            outline: 2px solid var(--accent-primary);
            outline-offset: 2px;
        }

        #newGameHeaderBtn {
            padding: 0.6rem 1.25rem;
            font-size: 0.9rem;
            font-weight: 700;
        }

        /* Game over modal */
        .completion-message {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .score-display {
            font-size: 2rem;
            font-weight: 700;
            color: var(--success-color);
            margin: 1rem 0;
        }

        /* BMAC link */
        .bmac-link {
            display: flex;
            justify-content: center;
            margin-top: 1.5rem;
        }

        .bmac-button {
            display: inline-block;
        }

        .bmac-button img {
            height: 40px;
            width: auto;
            border-radius: 4px;
            transition: transform 200ms ease;
        }

        .bmac-button:hover img {
            transform: scale(1.05);
        }

        /* Theme selector */
        .theme-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
        }

        .theme-btn {
            padding: 0.65rem;
            border: 2px solid var(--border-color);
            background: var(--card-bg);
            border-radius: 0.375rem;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 200ms ease;
        }

        .theme-btn:hover {
            border-color: var(--accent-primary);
        }

        .theme-btn.active {
            border-color: var(--accent-primary);
            background: var(--accent-primary);
            color: white;
        }

        /* Board size selector */
        .size-selector {
            display: flex;
            gap: 0.5rem;
        }

        .size-btn {
            flex: 1;
            padding: 0.65rem;
            border: 2px solid var(--border-color);
            background: var(--card-bg);
            border-radius: 0.375rem;
            cursor: pointer;
            font-weight: 600;
            transition: all 200ms ease;
            font-size: 0.85rem;
        }

        .size-btn:hover {
            border-color: var(--accent-primary);
        }

        .size-btn.active {
            border-color: var(--accent-primary);
            background: var(--accent-primary);
            color: white;
        }

        /* Accessibility */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        /* Responsive */
        @media (max-width: 480px) {
            .header {
                padding: 0.75rem;
                gap: 0.5rem;
            }

            .header-title {
                font-size: 1.25rem;
            }

            #newGameHeaderBtn {
                padding: 0.5rem 1rem;
                font-size: 0.8rem;
            }

            .main {
                padding: 0.75rem;
                gap: 0.75rem;
            }

            .stats {
                padding: 0.75rem;
            }

            .stat-value {
                font-size: 1rem;
            }

            .modal-content {
                padding: 1.5rem 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <h1 class="header-title">Memory Game</h1>
        <div class="header-controls">
            <button class="primary-button" id="newGameHeaderBtn" aria-label="Start new game" title="Start new game">New Game</button>
            <button class="icon-button" id="themeToggle" aria-label="Toggle theme" title="Toggle theme">
                <svg id="themeIcon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <!-- Sun icon (light mode) -->
                    <circle cx="12" cy="12" r="5"/>
                    <line x1="12" y1="1" x2="12" y2="3"/>
                    <line x1="12" y1="21" x2="12" y2="23"/>
                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                    <line x1="1" y1="12" x2="3" y2="12"/>
                    <line x1="21" y1="12" x2="23" y2="12"/>
                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                </svg>
            </button>
            <button class="icon-button" id="menuToggle" aria-label="Open menu" title="Menu">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="3" y1="12" x2="21" y2="12"/>
                    <line x1="3" y1="6" x2="21" y2="6"/>
                    <line x1="3" y1="18" x2="21" y2="18"/>
                </svg>
            </button>
        </div>
    </header>

    <!-- Main game area -->
    <main class="main">
        <div class="stats">
            <div class="stat-item">
                <span class="stat-label">Moves</span>
                <span class="stat-value" id="movesCount">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Matches</span>
                <span class="stat-value" id="matchesCount">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Time</span>
                <span class="stat-value" id="timeCount">0s</span>
            </div>
        </div>
        <div class="board-container">
            <div class="board" id="gameBoard" role="main" aria-label="Game board"></div>
        </div>
    </main>

    <!-- Menu -->
    <div class="menu-container" id="menuContainer" role="dialog" aria-modal="true" aria-label="Navigation menu">
        <div class="menu-panel">
            <button class="icon-button menu-close" id="menuClose" aria-label="Close menu">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
            <div class="menu-title">Menu</div>
            <div class="menu-content">
                <!-- Settings Section -->
                <div class="menu-section">
                    <div class="menu-section-title">Display</div>
                    <div class="menu-group">
                        <label class="checkbox">
                            <input type="checkbox" id="systemTheme" checked>
                            <span>System Theme</span>
                        </label>
                    </div>
                </div>

                <!-- Board Size Section -->
                <div class="menu-section">
                    <div class="menu-section-title">Board Size</div>
                    <div class="size-selector">
                        <button class="size-btn active" data-size="2" title="2x2 board">2√ó2</button>
                        <button class="size-btn" data-size="3" title="3x2 board">3√ó2</button>
                        <button class="size-btn" data-size="4" title="4x4 board">4√ó4</button>
                        <button class="size-btn" data-size="5" title="5x4 board">5√ó4</button>
                        <button class="size-btn" data-size="6" title="6x6 board">6√ó6</button>
                    </div>
                </div>

                <!-- Game Themes Section -->
                <div class="menu-section">
                    <div class="menu-section-title">Game Themes</div>
                    <div class="menu-group menu-group-spaced">
                        <label class="checkbox">
                            <input type="checkbox" id="toggleAllThemes">
                            <span id="toggleAllLabel">Select all themes</span>
                        </label>
                    </div>
                    <div class="menu-group" id="themesContainer"></div>
                </div>

                <!-- Actions -->
                <div class="menu-section">
                    <button class="menu-item" id="newGameBtn">
                        <div class="menu-item-label">
                            <span>New Game</span>
                            <span>üéÆ</span>
                        </div>
                    </button>
                    <button class="menu-item" id="showScoreBtn" disabled>
                        <div class="menu-item-label">
                            <span>Show Score</span>
                            <span>üèÜ</span>
                        </div>
                    </button>
                    <button class="menu-item" id="aboutBtn">
                        <div class="menu-item-label">
                            <span>About</span>
                            <span>‚ÑπÔ∏è</span>
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Game Over Modal -->
    <div class="modal" id="gameOverModal" role="dialog" aria-modal="true" aria-label="Game completed">
        <div class="modal-content">
            <div class="modal-header">Congratulations!</div>
            <div class="modal-body">
                <div class="completion-message">
                    <p>You've matched all pairs!</p>
                    <div class="score-display" id="finalScore">Score: 0</div>
                    <p id="finalStats"></p>
                </div>
            </div>
            <div class="modal-footer">
                <span class="copy-status" id="copyStatus" aria-live="polite"></span>
                <button class="primary-button" id="copyScoreBtn">Copy</button>
                <button class="primary-button" id="closeGameOverBtn">Close</button>
                <button class="primary-button" id="playAgainBtn">Play Again</button>
            </div>
        </div>
    </div>

    <!-- About Modal -->
    <div class="modal" id="aboutModal" role="dialog" aria-modal="true" aria-label="About Memory Game">
        <div class="modal-content">
            <div class="modal-header">About Memory Game</div>
            <div class="modal-body">
                <p>Test your memory by flipping cards and matching pairs. The fewer moves you make, the better your score!</p>
                <p><strong>How to play:</strong></p>
                <ul style="margin-left: 1.25rem; margin-bottom: 1rem;">
                    <li>Click cards to flip them and reveal the emoji</li>
                    <li>Try to remember the position of each emoji</li>
                    <li>Match all pairs to complete the game</li>
                    <li>Your score is based on the number of moves</li>
                </ul>
                <p>Created with ‚ù§Ô∏è as part of the Idle Games collection.</p>
                <div class="bmac-link">
                    <a href="https://buymeacoffee.com/timelessp" target="_blank" rel="noopener noreferrer" class="bmac-button" title="Buy us a coffee">
                        <img src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" alt="Buy Me A Coffee" style="height: 40px; width: auto; display: block;">
                    </a>
                </div>
            </div>
            <div class="modal-footer">
                <button class="primary-button" id="closeAboutBtn">Close</button>
            </div>
        </div>
    </div>

    <!-- No Themes Selected Warning Modal -->
    <div class="modal" id="noThemesModal" role="dialog" aria-modal="true" aria-label="No themes selected">
        <div class="modal-content">
            <div class="modal-header">‚ö†Ô∏è No Game Themes Selected</div>
            <div class="modal-body">
                <p>You need to select at least one game theme to play. Please open the menu and enable one or more game themes under "Game Themes".</p>
                <p>Non-seasonal themes (Simple Light, Simple Dark, Travel Destinations, Vehicles, Animals, People, Colours & Shapes) are always available.</p>
            </div>
            <div class="modal-footer">
                <button class="primary-button" id="openSettingsBtn">Open Settings</button>
            </div>
        </div>
    </div>

    <script type="module">
        // ========================================
        // GAME STATE & CONFIG
        // ========================================

        const SEASONS = {
            CHRISTMAS: { name: 'Xmas', start: [12, 1], end: [12, 31], emojis: ['üéÑ', 'üéÖ', 'ü§∂', 'üéÅ', '‚õÑ', 'üîî', '‚ùÑÔ∏è', 'üïØÔ∏è'] },
            EASTER: { name: 'Easter', start: [3, 15], end: [4, 30], emojis: ['üê∞', 'ü•ö', 'üê£', 'üå∑', 'üå∏', 'üêî', 'üê•', 'üåº'] },
            HALLOWEEN: { name: 'Halloween', start: [10, 1], end: [10, 31], emojis: ['üéÉ', 'üëª', 'ü¶á', 'üï∑Ô∏è', 'üï∏Ô∏è', 'üßô', 'üßõ', 'üíÄ'] },
        };

        const GAME_THEMES = {
            simple_light: { name: 'Simple Light', emojis: ['üåü', 'üí´', '‚ú®', '‚≠ê', 'üå†', 'üí•', 'üéÜ', 'üéá'] },
            simple_dark: { name: 'Simple Dark', emojis: ['üåô', 'üåÉ', 'üåå', 'üåâ', 'üåÜ', 'üåá', 'üåë', '‚≠ê'] },
            travel: { name: 'Travel Destinations', emojis: ['üóº', 'üóΩ', 'üóø', 'üé°', 'üè∞', 'üïå', 'üõï', '‚õ©Ô∏è'] },
            vehicles: { name: 'Vehicles', emojis: ['üöó', 'üöï', 'üöô', 'üöå', 'üöé', 'üèéÔ∏è', 'üöì', 'üöë'] },
            animals: { name: 'Animals', emojis: ['üê∂', 'üê±', 'üê≠', 'üêπ', 'üê∞', 'ü¶ä', 'üêª', 'üêº'] },
            people: { name: 'People', emojis: ['üë®', 'üë©', 'üë¶', 'üëß', 'üë∂', 'üßë', 'üë¥', 'üëµ'] },
            colours: { name: 'Colours & Shapes', emojis: ['üî¥', 'üîµ', 'üü¢', 'üü°', 'üü£', 'üü†', '‚¨õ', '‚¨ú'] },
            plants: { name: 'Plants', emojis: ['üåø', 'üçÉ', 'üåµ', 'üå±', 'üå≤', 'üå≥', 'üå¥', 'üçÄ'] },
            ocean: { name: 'Ocean Life', emojis: ['üê≥', 'üê¨', 'üêü', 'ü¶à', 'üêô', 'ü™º', 'ü¶Ä', 'ü¶û'] },
            fruits: { name: 'Fruits', emojis: ['üçé', 'üçå', 'üçá', 'üçì', 'üçë', 'üçí', 'üçç', 'ü•ù'] },
            weather: { name: 'Weather', emojis: ['‚òÄÔ∏è', '‚õÖ', '‚òÅÔ∏è', 'üåßÔ∏è', '‚õàÔ∏è', '‚ùÑÔ∏è', 'üåà', 'üå™Ô∏è'] },
        };

        let gameState = {
            cards: [],
            flipped: [],
            matched: new Set(),
            moves: 0,
            matches: 0,
            startTime: 0,
            elapsedSeconds: 0,
            gameActive: true,
            boardSize: 2,
            nextBoardSize: 2,
            selectedThemes: new Set(),
            currentTheme: 'simple_light',
            gameCompleted: false,
            lastShareText: '',
            timerRunning: false,
            resolvingMismatch: false,
            pendingFlip: null,
            nextFlipped: [],
            mismatchPair: [],
            mismatchTimeoutId: null
        };

        // ========================================
        // THEME MANAGEMENT
        // ========================================

        function getSeasonalThemes() {
            const today = new Date();
            const month = today.getMonth() + 1;
            const day = today.getDate();
            const active = new Set();

            for (const [key, season] of Object.entries(SEASONS)) {
                const [startMonth, startDay] = season.start;
                const [endMonth, endDay] = season.end;

                if (startMonth === endMonth) {
                    if (month === startMonth && day >= startDay && day <= endDay) {
                        active.add(key.toLowerCase());
                    }
                } else {
                    if ((month === startMonth && day >= startDay) || (month === endMonth && day <= endDay)) {
                        active.add(key.toLowerCase());
                    }
                }
            }
            return active;
        }

        function getSavedSelectedThemes() {
            const saved = localStorage.getItem('idlegames-memory-themes');
            if (saved) {
                return new Set(JSON.parse(saved));
            }
            // Default to all non-seasonal themes on first load
            return new Set(['simple_light', 'simple_dark', 'travel', 'vehicles', 'animals', 'people', 'colours', 'plants', 'ocean', 'fruits', 'weather']);
        }

        function saveSelectedThemes() {
            localStorage.setItem('idlegames-memory-themes', JSON.stringify([...gameState.selectedThemes]));
        }

        // Initialize theme on load
        function initializeThemes() {
            const seasonal = getSeasonalThemes();
            const saved = getSavedSelectedThemes();

            // Check for new seasonal themes
            for (const theme of seasonal) {
                if (!saved.has(theme)) {
                    saved.add(theme);
                }
            }

            gameState.selectedThemes = saved;
            saveSelectedThemes();
            console.log('Initialized themes:', [...gameState.selectedThemes]);
            renderThemeSettings();
        }

        // ========================================
        // THEME SWITCHER
        // ========================================

        const themeToggle = document.getElementById('themeToggle');
        const themeIcon = document.getElementById('themeIcon');
        const systemThemeCheckbox = document.getElementById('systemTheme');

        let displayMode = 'system'; // system, light, or dark

        function getSystemTheme() {
            return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        }

        function updateThemeIcon() {
            const sunSVG = '<circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>';
            const moonSVG = '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>';
            const systemSVG = '<circle cx="9" cy="9" r="8"/><line x1="1" y1="15" x2="17" y2="15"/>';

            if (displayMode === 'system') {
                themeIcon.innerHTML = systemSVG;
                themeToggle.setAttribute('title', 'System theme (click to switch)');
            } else if (displayMode === 'light') {
                themeIcon.innerHTML = sunSVG;
                themeToggle.setAttribute('title', 'Light theme (click to switch)');
            } else {
                themeIcon.innerHTML = moonSVG;
                themeToggle.setAttribute('title', 'Dark theme (click to switch)');
            }
        }

        function applyTheme(theme) {
            if (theme === 'system') {
                theme = getSystemTheme();
            }
            document.documentElement.setAttribute('data-theme', theme);
            if (gameState.currentTheme) {
                setCardBackPattern(gameState.currentTheme);
            }
        }

        function loadDisplayTheme() {
            const saved = localStorage.getItem('idlegames-memory-displayMode') || 'system';
            displayMode = saved;
            systemThemeCheckbox.checked = displayMode === 'system';
            applyTheme(displayMode);
            updateThemeIcon();
        }

        themeToggle.addEventListener('click', () => {
            // Cycle: system -> light -> dark -> system
            if (displayMode === 'system') {
                displayMode = 'light';
            } else if (displayMode === 'light') {
                displayMode = 'dark';
            } else {
                displayMode = 'system';
            }

            localStorage.setItem('idlegames-memory-displayMode', displayMode);
            systemThemeCheckbox.checked = displayMode === 'system';
            applyTheme(displayMode);
            updateThemeIcon();
        });

        systemThemeCheckbox.addEventListener('change', () => {
            displayMode = systemThemeCheckbox.checked ? 'system' : 'light';
            localStorage.setItem('idlegames-memory-displayMode', displayMode);
            applyTheme(displayMode);
            updateThemeIcon();
        });

        // Listen for system theme changes
        window.matchMedia('(prefers-color-scheme: dark)').addListener(() => {
            if (displayMode === 'system') {
                applyTheme('system');
            }
        });

        loadDisplayTheme();

        // ========================================
        // MENU & MODALS
        // ========================================

        const menuToggle = document.getElementById('menuToggle');
        const menuClose = document.getElementById('menuClose');
        const menuContainer = document.getElementById('menuContainer');
        const newGameBtn = document.getElementById('newGameBtn');
        const newGameHeaderBtn = document.getElementById('newGameHeaderBtn');
        const aboutBtn = document.getElementById('aboutBtn');
        const gameOverModal = document.getElementById('gameOverModal');
        const aboutModal = document.getElementById('aboutModal');
        const noThemesModal = document.getElementById('noThemesModal');
        const playAgainBtn = document.getElementById('playAgainBtn');
        const closeGameOverBtn = document.getElementById('closeGameOverBtn');
        const closeAboutBtn = document.getElementById('closeAboutBtn');
        const openSettingsBtn = document.getElementById('openSettingsBtn');
        const showScoreBtn = document.getElementById('showScoreBtn');
        const copyScoreBtn = document.getElementById('copyScoreBtn');
        const copyStatus = document.getElementById('copyStatus');
        const toggleAllThemes = document.getElementById('toggleAllThemes');
        const toggleAllLabel = document.getElementById('toggleAllLabel');

        function toggleMenu() {
            menuContainer.classList.toggle('open');
        }

        function closeMenu() {
            menuContainer.classList.remove('open');
        }

        function closeModal(modal) {
            modal.classList.remove('open');
        }

        menuToggle.addEventListener('click', toggleMenu);
        menuClose.addEventListener('click', closeMenu);
        menuContainer.addEventListener('click', (e) => {
            if (e.target === menuContainer) closeMenu();
        });

        newGameHeaderBtn.addEventListener('click', () => {
            startNewGame();
        });

        newGameBtn.addEventListener('click', () => {
            closeMenu();
            startNewGame();
        });

        showScoreBtn.addEventListener('click', () => {
            if (!gameState.gameCompleted) {
                return;
            }
            closeMenu();
            gameOverModal.classList.add('open');
        });

        aboutBtn.addEventListener('click', () => {
            closeMenu();
            aboutModal.classList.add('open');
        });

        closeAboutBtn.addEventListener('click', () => closeModal(aboutModal));
        playAgainBtn.addEventListener('click', () => {
            closeModal(gameOverModal);
            startNewGame();
        });

        closeGameOverBtn.addEventListener('click', () => closeModal(gameOverModal));

        copyScoreBtn.addEventListener('click', async () => {
            const text = gameState.lastShareText || buildShareText();
            try {
                await navigator.clipboard.writeText(text);
                copyStatus.textContent = 'Copied!';
            } catch (error) {
                copyStatus.textContent = 'Copy failed. Select and copy manually.';
            }
            setTimeout(() => {
                copyStatus.textContent = '';
            }, 2000);
        });

        openSettingsBtn.addEventListener('click', () => {
            closeModal(noThemesModal);
            toggleMenu();
        });

        aboutModal.addEventListener('click', (e) => {
            if (e.target === aboutModal) closeModal(aboutModal);
        });

        gameOverModal.addEventListener('click', (e) => {
            if (e.target === gameOverModal) closeModal(gameOverModal);
        });

        noThemesModal.addEventListener('click', (e) => {
            if (e.target === noThemesModal) closeModal(noThemesModal);
        });

        // Close menu on escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeMenu();
                closeModal(gameOverModal);
                closeModal(aboutModal);
                closeModal(noThemesModal);
            }
        });

        function showNoThemesWarning() {
            noThemesModal.classList.add('open');
        }

        function buildShareText() {
            const { cols, rows } = getGridDimensions();
            const rowsText = [];
            for (let r = 0; r < rows; r++) {
                const row = [];
                for (let c = 0; c < cols; c++) {
                    const idx = r * cols + c;
                    row.push(gameState.cards[idx] || '‚¨ú');
                }
                rowsText.push(row.join(' '));
            }
            const score = calculateScore();
            return `Memory Match\nScore: ${score}\nMoves: ${gameState.moves}\nTime: ${gameState.elapsedSeconds}s\nBoard: ${cols}x${rows}\n\n${rowsText.join('\n')}`;
        }

        function setCardBackPattern(theme) {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const lightFill = '#f1f5f9';
            const palette = {
                simple_light: { stroke: isDark ? '#334155' : '#94a3b8', fill: isDark ? '#0b1120' : lightFill, pulse: isDark ? 'rgba(129, 140, 248, 0.35)' : 'rgba(102, 126, 234, 0.35)' },
                simple_dark: { stroke: isDark ? '#475569' : '#94a3b8', fill: isDark ? '#0b1120' : lightFill, pulse: isDark ? 'rgba(148, 163, 184, 0.35)' : 'rgba(99, 102, 241, 0.35)' },
                travel: { stroke: isDark ? '#334155' : '#94a3b8', fill: isDark ? '#0b1120' : lightFill, pulse: isDark ? 'rgba(59, 130, 246, 0.35)' : 'rgba(59, 130, 246, 0.35)' },
                vehicles: { stroke: isDark ? '#334155' : '#94a3b8', fill: isDark ? '#0b1120' : lightFill, pulse: isDark ? 'rgba(249, 115, 22, 0.35)' : 'rgba(249, 115, 22, 0.35)' },
                animals: { stroke: isDark ? '#334155' : '#94a3b8', fill: isDark ? '#0b1120' : lightFill, pulse: isDark ? 'rgba(34, 197, 94, 0.35)' : 'rgba(34, 197, 94, 0.35)' },
                people: { stroke: isDark ? '#334155' : '#94a3b8', fill: isDark ? '#0b1120' : lightFill, pulse: isDark ? 'rgba(244, 114, 182, 0.35)' : 'rgba(244, 114, 182, 0.35)' },
                colours: { stroke: isDark ? '#334155' : '#94a3b8', fill: isDark ? '#0b1120' : lightFill, pulse: isDark ? 'rgba(139, 92, 246, 0.35)' : 'rgba(139, 92, 246, 0.35)' },
                plants: { stroke: isDark ? '#334155' : '#94a3b8', fill: isDark ? '#0b1120' : lightFill, pulse: isDark ? 'rgba(34, 197, 94, 0.35)' : 'rgba(34, 197, 94, 0.35)' },
                ocean: { stroke: isDark ? '#334155' : '#94a3b8', fill: isDark ? '#0b1120' : lightFill, pulse: isDark ? 'rgba(14, 165, 233, 0.35)' : 'rgba(14, 165, 233, 0.35)' },
                fruits: { stroke: isDark ? '#334155' : '#94a3b8', fill: isDark ? '#0b1120' : lightFill, pulse: isDark ? 'rgba(239, 68, 68, 0.35)' : 'rgba(239, 68, 68, 0.35)' },
                weather: { stroke: isDark ? '#334155' : '#94a3b8', fill: isDark ? '#0b1120' : lightFill, pulse: isDark ? 'rgba(56, 189, 248, 0.35)' : 'rgba(56, 189, 248, 0.35)' },
                christmas: { stroke: isDark ? '#334155' : '#94a3b8', fill: isDark ? '#0b1120' : lightFill, pulse: isDark ? 'rgba(34, 197, 94, 0.35)' : 'rgba(34, 197, 94, 0.35)' },
                easter: { stroke: isDark ? '#334155' : '#94a3b8', fill: isDark ? '#0b1120' : lightFill, pulse: isDark ? 'rgba(168, 85, 247, 0.35)' : 'rgba(168, 85, 247, 0.35)' },
                halloween: { stroke: isDark ? '#334155' : '#94a3b8', fill: isDark ? '#0b1120' : lightFill, pulse: isDark ? 'rgba(249, 115, 22, 0.35)' : 'rgba(249, 115, 22, 0.35)' }
            };

            const colors = palette[theme] || { stroke: '#94a3b8', fill: '#e2e8f0' };
            const svgMarkup = `<svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 80 80">` +
                `<rect width="80" height="80" fill="${colors.fill}" fill-opacity="0.18"/>` +
                `<path d="M0 20 Q10 10 20 20 T40 20 T60 20 T80 20" fill="none" stroke="${colors.stroke}" stroke-width="8" stroke-linecap="round" stroke-opacity="0.35"/>` +
                `<path d="M0 60 Q10 50 20 60 T40 60 T60 60 T80 60" fill="none" stroke="${colors.stroke}" stroke-width="8" stroke-linecap="round" stroke-opacity="0.35"/>` +
                `</svg>`;
            const encodedSvg = `data:image/svg+xml,${encodeURIComponent(svgMarkup)}`;

            document.documentElement.style.setProperty('--card-back', colors.fill);
            document.documentElement.style.setProperty('--card-pattern', `url("${encodedSvg}")`);
            document.documentElement.style.setProperty('--card-pattern-size', '80px');
            const pulseBase = colors.pulse || 'rgba(102, 126, 234, 0.35)';
            const pulseStrong = pulseBase.replace('0.35', '0.55');
            const pulseSoft = pulseBase.replace('0.35', '0.18');
            document.documentElement.style.setProperty('--pulse-color', pulseBase);
            document.documentElement.style.setProperty('--pulse-color-strong', pulseStrong);
            document.documentElement.style.setProperty('--pulse-color-soft', pulseSoft);
        }

        // ========================================
        // THEME SETTINGS
        // ========================================

        function renderThemeSettings() {
            const container = document.getElementById('themesContainer');
            container.innerHTML = '';

            const seasonal = getSeasonalThemes();
            const allThemes = { ...GAME_THEMES };

            for (const [key, season] of Object.entries(SEASONS)) {
                const lowerKey = key.toLowerCase();
                allThemes[lowerKey] = {
                    name: season.name + (seasonal.has(lowerKey) ? ' (In Season)' : ' (Out of Season)'),
                    emojis: season.emojis
                };
            }

            for (const [key, theme] of Object.entries(allThemes)) {
                const isDisabled = SEASONS[key.toUpperCase()] && !seasonal.has(key);
                const label = document.createElement('label');
                label.className = 'checkbox';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.dataset.theme = key;
                checkbox.checked = gameState.selectedThemes.has(key);
                checkbox.disabled = isDisabled;

                const span = document.createElement('span');
                span.textContent = theme.name;
                if (isDisabled) {
                    span.style.opacity = '0.5';
                }

                label.appendChild(checkbox);
                label.appendChild(span);
                container.appendChild(label);

                checkbox.addEventListener('change', () => {
                    if (checkbox.checked) {
                        gameState.selectedThemes.add(key);
                    } else {
                        gameState.selectedThemes.delete(key);
                    }
                    saveSelectedThemes();
                    updateToggleAllState();
                });
            }
            updateToggleAllState();
        }

        function updateToggleAllState() {
            const container = document.getElementById('themesContainer');
            const enabledCheckboxes = Array.from(container.querySelectorAll('input[type="checkbox"]')).filter(cb => !cb.disabled);
            const checkedCount = enabledCheckboxes.filter(cb => cb.checked).length;

            if (enabledCheckboxes.length === 0) {
                toggleAllThemes.checked = false;
                toggleAllThemes.indeterminate = false;
                toggleAllLabel.textContent = 'Select all themes';
                return;
            }

            if (checkedCount === 0) {
                toggleAllThemes.checked = false;
                toggleAllThemes.indeterminate = false;
                toggleAllLabel.textContent = 'Select all themes';
            } else if (checkedCount === enabledCheckboxes.length) {
                toggleAllThemes.checked = true;
                toggleAllThemes.indeterminate = false;
                toggleAllLabel.textContent = 'Deselect all themes';
            } else {
                toggleAllThemes.checked = false;
                toggleAllThemes.indeterminate = true;
                toggleAllLabel.textContent = 'Select all themes';
            }
        }

        toggleAllThemes.addEventListener('change', () => {
            const container = document.getElementById('themesContainer');
            const enabledCheckboxes = Array.from(container.querySelectorAll('input[type="checkbox"]')).filter(cb => !cb.disabled);
            const shouldSelectAll = toggleAllThemes.checked;

            enabledCheckboxes.forEach(cb => {
                cb.checked = shouldSelectAll;
                const themeKey = cb.dataset.theme;
                if (shouldSelectAll) {
                    gameState.selectedThemes.add(themeKey);
                } else {
                    gameState.selectedThemes.delete(themeKey);
                }
            });

            saveSelectedThemes();
            updateToggleAllState();
        });

        // ========================================
        // BOARD SIZE
        // ========================================

        document.querySelectorAll('.size-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                gameState.nextBoardSize = parseInt(btn.dataset.size);
                localStorage.setItem('idlegames-memory-boardSize', gameState.nextBoardSize);
            });
        });

        // Load saved board size
        const savedSize = localStorage.getItem('idlegames-memory-boardSize');
        if (savedSize) {
            gameState.nextBoardSize = parseInt(savedSize);
            gameState.boardSize = gameState.nextBoardSize;
            document.querySelector(`.size-btn[data-size="${savedSize}"]`)?.classList.add('active');
            document.querySelector(`.size-btn[data-size="2"]`)?.classList.remove('active');
        }

        // ========================================
        // GAME LOGIC
        // ========================================

        function getGridDimensions() {
            const cols = gameState.boardSize;
            const rows = cols % 2 === 0 ? cols : Math.max(1, cols - 1);
            return { cols, rows };
        }

        function getPairCount() {
            const { cols, rows } = getGridDimensions();
            return (cols * rows) / 2;
        }

        function selectRandomTheme() {
            const selected = [...gameState.selectedThemes];
            if (selected.length === 0) {
                console.warn('No themes selected! Showing warning to user.');
                showNoThemesWarning();
                return false;
            }
            // Pick a random theme from selected
            const randomTheme = selected[Math.floor(Math.random() * selected.length)];
            gameState.currentTheme = randomTheme;
            console.log(`Selected theme: ${randomTheme}`);
            return true;
        }

        function getGameEmojis() {
            const theme = gameState.currentTheme;
            const pairCount = getPairCount();

            const unique = new Set();
            const orderedPools = [];

            const currentEmojis = GAME_THEMES[theme]?.emojis || SEASONS[Object.keys(SEASONS).find(k => k.toLowerCase() === theme)]?.emojis || [];
            orderedPools.push(currentEmojis);

            const selectedThemes = [...gameState.selectedThemes].filter(t => t !== theme);
            for (const selectedTheme of selectedThemes) {
                const pool = GAME_THEMES[selectedTheme]?.emojis || SEASONS[Object.keys(SEASONS).find(k => k.toLowerCase() === selectedTheme)]?.emojis || [];
                orderedPools.push(pool);
            }

            const fallbackThemes = Object.keys(GAME_THEMES).filter(t => !gameState.selectedThemes.has(t) && t !== theme);
            for (const fallbackTheme of fallbackThemes) {
                orderedPools.push(GAME_THEMES[fallbackTheme].emojis);
            }

            const shuffledPools = orderedPools.map(pool => [...pool].sort(() => Math.random() - 0.5));
            for (const pool of shuffledPools) {
                for (const emoji of pool) {
                    if (unique.size >= pairCount) {
                        break;
                    }
                    unique.add(emoji);
                }
                if (unique.size >= pairCount) {
                    break;
                }
            }

            const result = [...unique];
            if (result.length < pairCount) {
                const safeFallback = GAME_THEMES.simple_light.emojis;
                for (const emoji of safeFallback) {
                    if (result.length >= pairCount) {
                        break;
                    }
                    if (!result.includes(emoji)) {
                        result.push(emoji);
                    }
                }
            }

            return result.slice(0, pairCount);
        }

        function createCards() {
            const emojis = getGameEmojis();
            const cardEmojis = [...emojis, ...emojis];

            // Fisher-Yates shuffle
            for (let i = cardEmojis.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [cardEmojis[i], cardEmojis[j]] = [cardEmojis[j], cardEmojis[i]];
            }

            gameState.cards = cardEmojis;
            console.log(`Created ${cardEmojis.length} cards from theme "${gameState.currentTheme}"`);
        }

        function resizeBoard() {
            const board = document.getElementById('gameBoard');
            const container = document.querySelector('.board-container');
            if (!board || !container) {
                return;
            }
            const rect = container.getBoundingClientRect();
            const styles = getComputedStyle(board);
            const gap = parseFloat(styles.gap) || 0;
            const paddingX = (parseFloat(styles.paddingLeft) || 0) + (parseFloat(styles.paddingRight) || 0);
            const paddingY = (parseFloat(styles.paddingTop) || 0) + (parseFloat(styles.paddingBottom) || 0);

            const { cols, rows } = getGridDimensions();
            const availableWidth = Math.max(0, rect.width - paddingX - gap * (cols - 1));
            const availableHeight = Math.max(0, rect.height - paddingY - gap * (rows - 1));
            const cellSize = Math.max(0, Math.floor(Math.min(availableWidth / cols, availableHeight / rows)));

            const boardWidth = cellSize * cols + gap * (cols - 1) + paddingX;
            const boardHeight = cellSize * rows + gap * (rows - 1) + paddingY;
            board.style.width = `${boardWidth}px`;
            board.style.height = `${boardHeight}px`;
            board.style.setProperty('--tile-size', `${cellSize}px`);
            board.style.setProperty('--pulse-size', `${Math.max(4, Math.round(cellSize * 0.12))}px`);
        }

        function renderBoard() {
            const board = document.getElementById('gameBoard');
            if (!board) {
                console.error('Game board element not found');
                return;
            }
            
            board.innerHTML = '';
            const { cols, rows } = getGridDimensions();
            board.style.setProperty('--grid-size', cols);
            board.style.gridTemplateColumns = `repeat(${cols}, minmax(0, 1fr))`;
            board.style.gridTemplateRows = `repeat(${rows}, minmax(0, 1fr))`;
            resizeBoard();

            gameState.cards.forEach((emoji, index) => {
                const card = document.createElement('button');
                card.className = 'card';
                card.dataset.index = index;
                card.setAttribute('aria-label', `Card ${index + 1}`);

                const inner = document.createElement('div');
                inner.className = 'card-inner';

                const spin = document.createElement('div');
                spin.className = 'card-spin';

                const back = document.createElement('div');
                back.className = 'card-face card-back';

                const front = document.createElement('div');
                front.className = 'card-face card-front';
                front.textContent = emoji;

                spin.appendChild(back);
                spin.appendChild(front);
                inner.appendChild(spin);
                card.appendChild(inner);

                if (gameState.matched.has(index)) {
                    card.classList.add('matched', 'flipped');
                } else if (gameState.flipped.includes(index)) {
                    card.classList.add('flipped');
                }

                card.addEventListener('click', () => flipCard(index, card));
                card.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        flipCard(index, card);
                    }
                });

                board.appendChild(card);
            });
        }

        function startTimerIfNeeded() {
            if (gameState.timerRunning) return;
            gameState.startTime = Date.now();
            gameState.timerRunning = true;
            if (gameState.timerInterval) {
                clearInterval(gameState.timerInterval);
            }
            startTimer();
        }

        function handleResolvedPair() {
            if (gameState.flipped.length !== 2) return;

            gameState.gameActive = false;
            gameState.moves++;
            updateStats();

            const [idx1, idx2] = gameState.flipped;
            if (gameState.cards[idx1] === gameState.cards[idx2]) {
                setTimeout(() => {
                    gameState.matched.add(idx1);
                    gameState.matched.add(idx2);
                    gameState.matches++;
                    gameState.flipped = [];
                    gameState.gameActive = true;
                    updateStats();
                    renderBoard();

                    requestAnimationFrame(() => {
                        const first = document.querySelector(`.card[data-index="${idx1}"]`);
                        const second = document.querySelector(`.card[data-index="${idx2}"]`);
                        if (first) {
                            first.classList.add('jiggle');
                            first.classList.add('pulse');
                            setTimeout(() => first.classList.remove('jiggle'), 2200);
                            setTimeout(() => first.classList.remove('pulse'), 1100);
                        }
                        if (second) {
                            second.classList.add('jiggle');
                            second.classList.add('pulse');
                            setTimeout(() => second.classList.remove('jiggle'), 2200);
                            setTimeout(() => second.classList.remove('pulse'), 1100);
                        }
                    });

                    if (gameState.matched.size === gameState.cards.length) {
                        endGame();
                        return;
                    }

                    if (gameState.nextFlipped.length > 0) {
                        gameState.flipped = [...gameState.nextFlipped];
                        gameState.nextFlipped = [];
                        renderBoard();
                        handleResolvedPair();
                    }
                }, 500);
            } else {
                gameState.resolvingMismatch = true;
                gameState.mismatchPair = [idx1, idx2];
                if (gameState.mismatchTimeoutId) {
                    clearTimeout(gameState.mismatchTimeoutId);
                }
                gameState.mismatchTimeoutId = setTimeout(() => {
                    gameState.resolvingMismatch = false;
                    gameState.mismatchPair = [];
                    gameState.mismatchTimeoutId = null;
                    gameState.flipped = [];
                    gameState.gameActive = true;
                    renderBoard();

                    if (gameState.nextFlipped.length > 0) {
                        gameState.flipped = [...gameState.nextFlipped];
                        gameState.nextFlipped = [];
                        renderBoard();
                        handleResolvedPair();
                    }
                }, 1000);
            }
        }

        function restartMismatchTimeout() {
            if (!gameState.resolvingMismatch || gameState.mismatchPair.length !== 2) {
                return;
            }
            if (gameState.mismatchTimeoutId) {
                clearTimeout(gameState.mismatchTimeoutId);
            }
            gameState.mismatchTimeoutId = setTimeout(() => {
                gameState.resolvingMismatch = false;
                gameState.mismatchPair = [];
                gameState.mismatchTimeoutId = null;
                gameState.flipped = [];
                gameState.gameActive = true;
                renderBoard();

                if (gameState.nextFlipped.length > 0) {
                    gameState.flipped = [...gameState.nextFlipped];
                    gameState.nextFlipped = [];
                    renderBoard();
                    handleResolvedPair();
                }
            }, 1000);
        }

        function flipCard(index, cardElement) {
            if (gameState.matched.has(index)) return;
            if (gameState.flipped.includes(index)) return;
            if (gameState.resolvingMismatch && gameState.mismatchPair.includes(index)) {
                restartMismatchTimeout();
                return;
            }

            startTimerIfNeeded();

            if (gameState.resolvingMismatch) {
                if (gameState.nextFlipped.includes(index) || gameState.nextFlipped.length >= 2) return;
                gameState.nextFlipped.push(index);
                cardElement.classList.add('flipped');
                return;
            }

            if (gameState.flipped.length >= 2) return;

            gameState.flipped.push(index);
            cardElement.classList.add('flipped');

            if (gameState.flipped.length === 2) {
                handleResolvedPair();
            }
        }

        function startNewGame() {
            // Close any open modals
            closeMenu();
            closeModal(gameOverModal);
            closeModal(aboutModal);

            const board = document.getElementById('gameBoard');
            if (board) {
                board.classList.remove('celebrate');
                board.querySelectorAll('.card').forEach(card => card.style.removeProperty('--celebrate-start'));
            }

            gameState.cards = [];
            gameState.flipped = [];
            gameState.matched.clear();
            gameState.moves = 0;
            gameState.matches = 0;
            gameState.elapsedSeconds = 0;
            gameState.gameActive = true;
            gameState.startTime = 0;
            gameState.gameCompleted = false;
            gameState.lastShareText = '';
            gameState.timerRunning = false;
            gameState.resolvingMismatch = false;
            gameState.pendingFlip = null;
            gameState.nextFlipped = [];
            gameState.mismatchPair = [];
            if (gameState.mismatchTimeoutId) {
                clearTimeout(gameState.mismatchTimeoutId);
            }
            gameState.mismatchTimeoutId = null;
            showScoreBtn.disabled = true;
            copyStatus.textContent = '';

            console.log('Starting new game...');
            gameState.boardSize = gameState.nextBoardSize || gameState.boardSize;
            // Select a random theme - if none selected, show warning
            if (!selectRandomTheme()) {
                return; // Don't start game if no themes selected
            }
            setCardBackPattern(gameState.currentTheme);
            
            createCards();
            renderBoard();
            updateStats();
            console.log('New game started');

            if (gameState.timerInterval) {
                clearInterval(gameState.timerInterval);
            }
        }

        function startTimer() {
            gameState.timerInterval = setInterval(() => {
                gameState.elapsedSeconds = Math.floor((Date.now() - gameState.startTime) / 1000);
                updateStats();
            }, 100);
        }

        function updateStats() {
            document.getElementById('movesCount').textContent = gameState.moves;
            document.getElementById('matchesCount').textContent = gameState.matches;
            document.getElementById('timeCount').textContent = gameState.elapsedSeconds + 's';
        }

        function calculateScore() {
            // Lower is better: base 1000 points, minus moves and time
            const baseScore = 1000;
            const movesPenalty = gameState.moves * 10;
            const timePenalty = Math.floor(gameState.elapsedSeconds / 2);
            return Math.max(0, baseScore - movesPenalty - timePenalty);
        }

        function endGame() {
            if (gameState.timerInterval) {
                clearInterval(gameState.timerInterval);
            }
            gameState.gameActive = false;
            gameState.timerRunning = false;
            gameState.gameCompleted = true;
            showScoreBtn.disabled = false;

            const board = document.getElementById('gameBoard');
            if (board) {
                board.classList.add('celebrate');
                const cards = board.querySelectorAll('.card');
                cards.forEach((card) => {
                    const offset = (Math.random() * 12 - 6).toFixed(2);
                    card.style.setProperty('--celebrate-offset', `${offset}deg`);
                });
            }

            const score = calculateScore();
            document.getElementById('finalScore').textContent = `Score: ${score}`;
            document.getElementById('finalStats').innerHTML = `
                <strong>${gameState.moves} moves in ${gameState.elapsedSeconds}s</strong>
            `;
            gameState.lastShareText = buildShareText();

            setTimeout(() => {
                gameOverModal.classList.add('open');
            }, 2200);
        }

        // ========================================
        // INITIALIZATION
        // ========================================

        function init() {
            // Make sure DOM elements exist
            const gameBoard = document.getElementById('gameBoard');
            if (!gameBoard) {
                console.error('Game board element not found');
                return;
            }

            initializeThemes();
            startNewGame();
            resizeBoard();

            const container = document.querySelector('.board-container');
            if (container && window.ResizeObserver) {
                const observer = new ResizeObserver(() => {
                    requestAnimationFrame(resizeBoard);
                });
                observer.observe(container);
            }
        }

        // Always use DOMContentLoaded to ensure all elements are available
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            // If script runs after DOM is loaded (e.g., in tests), call init immediately
            setTimeout(init, 0);
        }

        window.addEventListener('resize', () => {
            requestAnimationFrame(resizeBoard);
        });
    </script>
    <script src="parental.js" defer></script>
</body>
</html>
