<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Library Cabinet</title>
	<style>
		:root {
			--bg-deep: #090709;
			--bg-sheen: rgba(61, 37, 53, 0.4);
			--bg-glow: rgba(255, 211, 172, 0.16);
			--shelf-wood: #5e3523;
			--shelf-sheen: rgba(255, 255, 255, 0.22);
			--shelf-shadow: rgba(0, 0, 0, 0.55);
			--text-primary: #f8f1e4;
			--text-muted: rgba(248, 241, 228, 0.7);
			--book-depth: 26px;
			--noise-texture: none;
			--paper-texture: none;
			--paper-highlight: rgba(255, 255, 255, 0.7);
			--paper-shadow: rgba(0, 0, 0, 0.25);
			--transition-snappy: cubic-bezier(0.22, 0.61, 0.36, 1);
		}

		* {
			box-sizing: border-box;
		}

		body {
			margin: 0;
			min-height: 100vh;
			font-family: "Libre Baskerville", "Palatino", "Book Antiqua", serif;
			background: var(--bg-deep);
			color: var(--text-primary);
			overflow-x: hidden;
			position: relative;
			display: flex;
			flex-direction: column;
		}

		body::before,
		body::after {
			content: "";
			position: fixed;
			inset: 0;
			pointer-events: none;
		}

		body::before {
			background: radial-gradient(circle at 20% 15%, rgba(255, 206, 142, 0.25), transparent 46%),
				radial-gradient(circle at 70% 10%, rgba(255, 248, 229, 0.18), transparent 52%),
				linear-gradient(135deg, rgba(32, 19, 36, 0.9), rgba(13, 8, 18, 0.96));
			mix-blend-mode: screen;
			opacity: 0.85;
		}

		body::after {
			background: var(--noise-texture);
			opacity: 0.18;
			mix-blend-mode: soft-light;
		}

		main {
			flex: 1;
			display: flex;
			flex-direction: column;
			padding: 5vh 6vw 8vh;
		}

		header {
			display: flex;
			align-items: baseline;
			justify-content: space-between;
			margin-bottom: 3rem;
		}

		h1 {
			font-size: clamp(2.8rem, 4vw, 4.2rem);
			letter-spacing: 0.1em;
			text-transform: uppercase;
			margin: 0;
			color: var(--text-primary);
			text-shadow: 0 0 18px rgba(255, 201, 131, 0.45), 0 8px 24px rgba(0, 0, 0, 0.6);
		}

		.tagline {
			font-size: 1rem;
			letter-spacing: 0.4em;
			text-transform: uppercase;
			color: var(--text-muted);
			align-self: flex-start;
		}

		.shelf-wrapper {
			position: relative;
			flex: 1;
			perspective: 2000px;
			perspective-origin: 50% 35%;
		}

		.shelf-structure {
			position: relative;
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
			gap: 4rem 2.5rem;
			padding: 3rem 2.5rem 5rem;
			background:
				linear-gradient(180deg, rgba(255, 255, 255, 0.12), transparent 11%),
				linear-gradient(120deg, rgba(255, 230, 193, 0.22), transparent 35%),
				var(--shelf-wood);
			border-radius: 28px;
			box-shadow:
				inset 0 20px 40px rgba(0, 0, 0, 0.35),
				inset 0 -40px 60px rgba(0, 0, 0, 0.25),
				0 70px 160px rgba(0, 0, 0, 0.65);
			transform: rotateX(8deg) rotateY(-6deg);
		}

		.shelf-structure::before,
		.shelf-structure::after {
			content: "";
			position: absolute;
			inset: 0;
			border-radius: 28px;
			pointer-events: none;
		}

		.shelf-structure::before {
			background: linear-gradient(180deg, transparent, rgba(0, 0, 0, 0.55));
			mix-blend-mode: multiply;
		}

		.shelf-structure::after {
			background: linear-gradient(120deg, rgba(255, 255, 255, 0.25), transparent 60%);
			opacity: 0.6;
		}

		.book-slot {
			position: relative;
			width: 100%;
			height: 300px;
			display: flex;
			align-items: flex-end;
			justify-content: center;
			perspective: 1400px;
		}

		.book {
			--cover-hue: 20;
			--cover-sat: 56%;
			--cover-light: 34%;
			--book-depth: 24px;
			position: relative;
			width: 140px;
			height: 240px;
			border: none;
			padding: 0;
			background: transparent;
			cursor: pointer;
			transform-style: preserve-3d;
			transform: translateZ(0) rotateY(-12deg) translateY(0);
			transition: transform 0.6s var(--transition-snappy), box-shadow 0.6s var(--transition-snappy), filter 0.6s var(--transition-snappy);
			outline: none;
		}

		.book:focus-visible {
			box-shadow: 0 0 0 4px rgba(255, 216, 155, 0.45);
		}

		.book:hover {
			transform: translateZ(30px) rotateY(-6deg) translateY(-6px);
			filter: brightness(1.04);
		}

		.book.book--active {
			transform: translateZ(110px) rotateY(0deg) translateY(-16px) scale(1.05);
			z-index: 50;
		}

		.book .block {
			position: absolute;
			inset: 0;
			transform-style: preserve-3d;
		}

		.book .face {
			position: absolute;
			inset: 0;
			border-radius: 6px;
			background: var(--paper-texture), linear-gradient(180deg, rgba(255, 255, 255, 0.35), transparent 30%), linear-gradient(0deg, rgba(0, 0, 0, 0.14), transparent 70%);
			background-repeat: no-repeat, no-repeat, no-repeat;
			background-size: 100% 100%, 100% 100%, 100% 100%;
			background-blend-mode: multiply;
			backface-visibility: hidden;
		}

		.book .face.cover-front {
			background:
				var(--noise-texture),
				linear-gradient(145deg, rgba(255, 255, 255, 0.22), transparent 55%),
				hsl(var(--cover-hue) var(--cover-sat) var(--cover-light));
			background-repeat: no-repeat, no-repeat, no-repeat;
			background-size: 100% 100%, 100% 100%, 100% 100%;
			mix-blend-mode: screen;
			transform: translateZ(calc(var(--book-depth) / 2));
			display: flex;
			flex-direction: column;
			justify-content: space-between;
			padding: 26px 20px;
			box-shadow: inset 0 0 35px rgba(0, 0, 0, 0.36);
		}

		.book .face.cover-back {
			transform: rotateY(180deg) translateZ(calc(var(--book-depth) / 2));
			background:
				var(--noise-texture),
				linear-gradient(185deg, rgba(255, 255, 255, 0.14), rgba(0, 0, 0, 0.25)),
				hsl(calc(var(--cover-hue) + 12) calc(var(--cover-sat) - 6%) calc(var(--cover-light) - 4%));
			background-repeat: no-repeat, no-repeat, no-repeat;
			background-size: 100% 100%, 100% 100%, 100% 100%;
		}

		.book .face.cover-front .title {
			font-size: clamp(0.72rem, 0.6rem + 0.75vw, 1rem);
			text-transform: uppercase;
			letter-spacing: clamp(0.12em, 0.08em + 0.4vw, 0.24em);
			line-height: 1.35;
			text-align: left;
			color: rgba(20, 4, 4, 0.94);
			text-shadow: 0 2px 6px rgba(255, 255, 255, 0.25);
			word-break: break-word;
			overflow-wrap: anywhere;
			hyphens: auto;
		}

		.book .face.cover-front .author {
			font-size: clamp(0.62rem, 0.52rem + 0.55vw, 0.82rem);
			letter-spacing: clamp(0.1em, 0.05em + 0.25vw, 0.2em);
			color: rgba(20, 4, 4, 0.7);
			word-break: break-word;
			overflow-wrap: anywhere;
			hyphens: auto;
		}

		.book .face.cover-front .mark {
			font-size: clamp(0.55rem, 0.45rem + 0.35vw, 0.68rem);
			letter-spacing: clamp(0.18em, 0.12em + 0.25vw, 0.32em);
			opacity: 0.6;
		}

		.book .spine {
			position: absolute;
			width: var(--book-depth);
			height: 100%;
			left: calc(var(--book-depth) / -2);
			top: 0;
			transform: rotateY(-90deg);
			transform-origin: center;
			background:
				var(--noise-texture),
				linear-gradient(90deg, rgba(255, 255, 255, 0.22), transparent 40%),
				linear-gradient(-90deg, rgba(0, 0, 0, 0.5), transparent 60%),
				hsl(calc(var(--cover-hue) + 6) calc(var(--cover-sat) + 4%) calc(var(--cover-light) - 12%));
			background-repeat: no-repeat, no-repeat, no-repeat, no-repeat;
			background-size: 100% 100%, 100% 100%, 100% 100%, 100% 100%;
			border-radius: 6px 0 0 6px;
			display: flex;
			align-items: center;
			justify-content: center;
			padding: 0 4px;
		}

		.book .spine span {
			writing-mode: vertical-rl;
			transform: rotate(180deg);
			font-size: 0.82rem;
			letter-spacing: 0.12em;
			color: rgba(255, 230, 194, 0.76);
		}

		.book .edge {
			position: absolute;
			background:
				var(--paper-texture),
				repeating-linear-gradient(90deg, rgba(255, 255, 255, 0.5) 0 3px, rgba(222, 212, 190, 0.8) 3px 6px);
			background-repeat: no-repeat, repeat;
			background-size: 100% 100%, auto;
			filter: brightness(1.05);
		}

		.book .edge.edge-top {
			height: var(--book-depth);
			width: 100%;
			top: calc(var(--book-depth) / -2);
			transform: rotateX(90deg);
			transform-origin: top;
			border-radius: 6px 6px 0 0;
			box-shadow: inset 0 10px 20px rgba(0, 0, 0, 0.35);
		}

		.book .edge.edge-bottom {
			height: var(--book-depth);
			width: 100%;
			bottom: calc(var(--book-depth) / -2);
			transform: rotateX(-90deg);
			border-radius: 0 0 6px 6px;
			box-shadow: inset 0 -10px 20px rgba(0, 0, 0, 0.35);
		}

		.book .edge.edge-side {
			width: var(--book-depth);
			height: 100%;
			right: calc(var(--book-depth) / -2);
			transform: rotateY(90deg);
			border-radius: 0 6px 6px 0;
			box-shadow: inset 10px 0 22px rgba(0, 0, 0, 0.22);
		}

		.ambient-dust {
			position: fixed;
			inset: 0;
			pointer-events: none;
			background-image: radial-gradient(4px 4px at 20% 30%, rgba(255, 255, 255, 0.2) 0, transparent 70%),
				radial-gradient(6px 6px at 80% 10%, rgba(255, 255, 255, 0.1) 0, transparent 65%),
				radial-gradient(3px 3px at 60% 70%, rgba(255, 255, 255, 0.16) 0, transparent 70%);
			mix-blend-mode: screen;
			animation: dust-drift 18s infinite linear;
			opacity: 0.5;
		}

		@keyframes dust-drift {
			from { transform: translateY(0); }
			to { transform: translateY(-40px); }
		}

		.reader-overlay {
			position: fixed;
			inset: 0;
			display: flex;
			align-items: center;
			justify-content: center;
			background: radial-gradient(circle at 50% 50%, rgba(12, 6, 9, 0.92), rgba(5, 3, 6, 0.96));
			opacity: 0;
			pointer-events: none;
			transition: opacity 0.6s ease;
			z-index: 200;
		}

		.reader-overlay.reader-overlay--visible {
			opacity: 1;
			pointer-events: auto;
		}

		.reader-stage {
			position: relative;
			width: min(1200px, 80vw);
			aspect-ratio: 3 / 2;
			display: flex;
			flex-direction: column;
			gap: 1.5rem;
		}

		.reader-header {
			display: flex;
			align-items: baseline;
			justify-content: space-between;
			color: var(--text-muted);
			letter-spacing: 0.2em;
			text-transform: uppercase;
			font-size: 0.72rem;
		}

		.reader-header strong {
			font-size: 1.2rem;
			color: var(--text-primary);
			letter-spacing: 0.18em;
		}

		.reader-book {
			flex: 1;
			position: relative;
			perspective: 2200px;
			perspective-origin: 50% 50%;
		}

		.reader-book .book-frame {
			position: absolute;
			inset: 0;
			transform-style: preserve-3d;
			transition: transform 0.8s var(--transition-snappy);
		}

		.reader-book .cover-shadow {
			content: "";
			position: absolute;
			inset: -80px -140px;
			background: radial-gradient(circle, rgba(0, 0, 0, 0.6), transparent 70%);
			transform: translateZ(-200px);
			filter: blur(40px);
			opacity: 0.7;
			pointer-events: none;
		}

		.reader-book .page {
			position: absolute;
			top: 0;
			bottom: 0;
			width: 50%;
			padding: 40px 36px;
			background:
				var(--paper-texture),
				linear-gradient(120deg, rgba(255, 255, 255, 0.8), rgba(245, 230, 198, 0.9));
			background-repeat: no-repeat, no-repeat;
			background-size: 100% 100%, 100% 100%;
			background-blend-mode: multiply;
			color: #24150c;
			box-shadow: inset 0 0 80px rgba(255, 255, 255, 0.35), inset 0 0 200px rgba(255, 250, 241, 0.5);
			border-radius: 10px;
			transform-style: preserve-3d;
		}

		.reader-book .page::before {
			content: "";
			position: absolute;
			inset: 0;
			border-radius: 10px;
			background: var(--noise-texture);
			background-repeat: no-repeat;
			background-size: 100% 100%;
			mix-blend-mode: multiply;
			opacity: 0.22;
			pointer-events: none;
		}

		.page-left {
			left: 0;
			transform: rotateY(6deg) translateZ(2px);
			box-shadow: 20px 0 60px rgba(0, 0, 0, 0.4);
		}

		.page-right {
			right: 0;
			transform: rotateY(-6deg) translateZ(2px);
			box-shadow: -20px 0 60px rgba(0, 0, 0, 0.4);
		}

		.page-content {
			position: relative;
			width: 100%;
			height: 100%;
			overflow: hidden;
			font-size: 1.05rem;
			line-height: 1.58;
			column-count: 1;
		}

		.page-content p {
			margin: 0 0 1.1em;
			text-indent: 1.5em;
		}

		.page-content p:first-child {
			text-indent: 0;
		}

		.page-content .chapter-title {
			font-size: 1.2rem;
			letter-spacing: 0.16em;
			text-transform: uppercase;
			text-align: center;
			margin: 1em 0;
		}

		.page-turn {
			position: absolute;
			top: 0;
			width: 50%;
			height: 100%;
			transform-style: preserve-3d;
			pointer-events: none;
			opacity: 0;
		}

		.page-turn .page-face {
			position: absolute;
			inset: 0;
			backface-visibility: hidden;
			background:
				var(--paper-texture),
				linear-gradient(120deg, rgba(255, 255, 255, 0.85), rgba(247, 232, 208, 0.95));
			background-repeat: no-repeat, no-repeat;
			background-size: 100% 100%, 100% 100%;
			border-radius: 10px;
			padding: 40px 36px;
			box-shadow: inset 0 0 60px rgba(255, 255, 255, 0.45);
		}

		.page-turn .page-face::after {
			content: "";
			position: absolute;
			inset: 0;
			background: var(--noise-texture);
			background-repeat: no-repeat;
			background-size: 100% 100%;
			opacity: 0.2;
			mix-blend-mode: multiply;
		}

		.page-turn .page-face.back {
			transform: rotateY(180deg);
		}

		.page-turn.turning {
			opacity: 1;
		}

		.page-turn[data-side="right"] {
			left: 50%;
			transform-origin: left center;
		}

		.page-turn[data-side="left"] {
			left: 0;
			transform-origin: right center;
		}

		.page-turn.turn-forward {
			animation: page-flip-forward 0.9s var(--transition-snappy) forwards;
		}

		.page-turn.turn-backward {
			animation: page-flip-backward 0.9s var(--transition-snappy) forwards;
		}

		@keyframes page-flip-forward {
			0% { transform: rotateY(0deg); }
			48% { transform: rotateY(-95deg); }
			100% { transform: rotateY(-180deg); opacity: 0; }
		}

		@keyframes page-flip-backward {
			0% { transform: rotateY(0deg); }
			48% { transform: rotateY(95deg); }
			100% { transform: rotateY(180deg); opacity: 0; }
		}

		.reader-controls {
			display: flex;
			align-items: center;
			justify-content: space-between;
			font-size: 0.9rem;
			letter-spacing: 0.16em;
			text-transform: uppercase;
			color: var(--text-muted);
		}

		.reader-controls button {
			background: rgba(255, 236, 210, 0.12);
			color: var(--text-primary);
			border: 1px solid rgba(255, 236, 210, 0.25);
			padding: 0.7rem 1.4rem;
			letter-spacing: 0.24em;
			text-transform: uppercase;
			border-radius: 999px;
			cursor: pointer;
			transition: transform 0.4s ease, background 0.4s ease, border 0.4s ease;
		}

		.reader-controls button:hover {
			background: rgba(255, 236, 210, 0.22);
			transform: translateY(-2px);
		}

		.reader-controls button:disabled {
			opacity: 0.3;
			cursor: default;
			transform: none;
		}

		.reader-close {
			position: absolute;
			top: 2.5rem;
			right: 2.5rem;
			border: none;
			background: rgba(0, 0, 0, 0.4);
			color: var(--text-primary);
			font-size: 0.9rem;
			letter-spacing: 0.3em;
			text-transform: uppercase;
			padding: 0.6rem 1.4rem;
			cursor: pointer;
			border-radius: 999px;
			transition: background 0.3s ease;
		}

		.reader-close:hover {
			background: rgba(0, 0, 0, 0.55);
		}

		.page-indicator {
			font-size: 0.78rem;
			letter-spacing: 0.4em;
			text-transform: uppercase;
			color: var(--text-muted);
		}

		.loading-indicator {
			position: absolute;
			inset: 0;
			display: flex;
			align-items: center;
			justify-content: center;
			background: rgba(9, 6, 10, 0.86);
			border-radius: 12px;
			letter-spacing: 0.4em;
			text-transform: uppercase;
			color: var(--text-muted);
			font-size: 0.78rem;
			opacity: 0;
			pointer-events: none;
			transition: opacity 0.3s ease;
		}

		.loading-indicator.active {
			opacity: 1;
		}

		@media (prefers-reduced-motion: reduce) {
			*, *::before, *::after {
				animation-duration: 0.01ms !important;
				animation-iteration-count: 1 !important;
				transition-duration: 0.01ms !important;
				scroll-behavior: auto !important;
			}
		}
	</style>
</head>
<body>
	<div class="ambient-dust"></div>
	<main>
		<header>
			<h1>The Illuminated Stack</h1>
			<div class="tagline">Click a volume to unfurl its leaves</div>
		</header>
		<div class="shelf-wrapper">
			<div class="shelf-structure" id="shelf"></div>
		</div>
	</main>

	<div class="reader-overlay" id="reader">
		<button class="reader-close" id="readerClose">Close</button>
		<div class="reader-stage">
			<div class="reader-header">
				<div><strong id="readerTitle"></strong> · <span id="readerAuthor"></span></div>
				<div>Keyboard: ← → turn · Esc close</div>
			</div>
			<div class="reader-book">
				<div class="cover-shadow"></div>
				<div class="book-frame">
					<div class="page page-left" id="pageLeft">
						<div class="page-content"></div>
					</div>
					<div class="page page-right" id="pageRight">
						<div class="page-content"></div>
					</div>
					<div class="page-turn" id="pageTurn">
						<div class="page-face front"><div class="page-content"></div></div>
						<div class="page-face back"><div class="page-content"></div></div>
					</div>
					<div class="loading-indicator" id="readerLoading">Summoning folios…</div>
				</div>
			</div>
			<div class="reader-controls">
				<button id="prevPage">Prev</button>
				<div class="page-indicator" id="pageIndicator">–</div>
				<button id="nextPage">Next</button>
			</div>
		</div>
	</div>

	<script>
		const BOOKS = [
			{
				id: "alice",
				title: "Alice's Adventures",
				author: "Lewis Carroll",
				path: "assets/books/alice-in-wonderland.txt",
				hue: 14,
				sat: "62%",
				light: "42%",
				thickness: 28,
				pageEstimate: 1700
			},
			{
				id: "pride",
				title: "Pride & Prejudice",
				author: "Jane Austen",
				path: "assets/books/pride-and-prejudice.txt",
				hue: 338,
				sat: "48%",
				light: "32%",
				thickness: 32,
				pageEstimate: 1600
			},
			{
				id: "dracula",
				title: "Dracula",
				author: "Bram Stoker",
				path: "assets/books/dracula.txt",
				hue: 342,
				sat: "36%",
				light: "30%",
				thickness: 34,
				pageEstimate: 1800
			},
			{
				id: "frankenstein",
				title: "Frankenstein",
				author: "Mary Shelley",
				path: "assets/books/frankenstein.txt",
				hue: 85,
				sat: "28%",
				light: "40%",
				thickness: 26,
				pageEstimate: 1300
			},
			{
				id: "mobydick",
				title: "Moby-Dick",
				author: "Herman Melville",
				path: "assets/books/moby-dick.txt",
				hue: 205,
				sat: "44%",
				light: "32%",
				thickness: 38,
				pageEstimate: 2400
			},
			{
				id: "sherlock",
				title: "Sherlock Holmes",
				author: "Arthur Conan Doyle",
				path: "assets/books/sherlock-holmes.txt",
				hue: 28,
				sat: "22%",
				light: "38%",
				thickness: 30,
				pageEstimate: 1500
			},
			{
				id: "doriangray",
				title: "Dorian Gray",
				author: "Oscar Wilde",
				path: "assets/books/dorian-gray.txt",
				hue: 318,
				sat: "34%",
				light: "36%",
				thickness: 29,
				pageEstimate: 1400
			},
			{
				id: "timemachine",
				title: "The Time Machine",
				author: "H. G. Wells",
				path: "assets/books/time-machine.txt",
				hue: 196,
				sat: "28%",
				light: "46%",
				thickness: 25,
				pageEstimate: 1100
			},
			{
				id: "warworlds",
				title: "War of the Worlds",
				author: "H. G. Wells",
				path: "assets/books/war-of-the-worlds.txt",
				hue: 14,
				sat: "44%",
				light: "34%",
				thickness: 30,
				pageEstimate: 1500
			},
			{
				id: "wizardofoz",
				title: "Wizard of Oz",
				author: "L. Frank Baum",
				path: "assets/books/wizard-of-oz.txt",
				hue: 108,
				sat: "50%",
				light: "44%",
				thickness: 27,
				pageEstimate: 1200
			},
			{
				id: "callwild",
				title: "Call of the Wild",
				author: "Jack London",
				path: "assets/books/call-of-the-wild.txt",
				hue: 42,
				sat: "38%",
				light: "36%",
				thickness: 26,
				pageEstimate: 1250
			}
		];

		const state = {
			activeElement: null,
			pulling: false,
			readerOpen: false,
			currentBook: null,
			currentIndex: 0,
			isTurning: false
		};

		const shelfEl = document.getElementById("shelf");
		const readerEl = document.getElementById("reader");
		const readerClose = document.getElementById("readerClose");
		const readerTitle = document.getElementById("readerTitle");
		const readerAuthor = document.getElementById("readerAuthor");
		const pageLeft = document.getElementById("pageLeft").querySelector(".page-content");
		const pageRight = document.getElementById("pageRight").querySelector(".page-content");
		const pageTurn = document.getElementById("pageTurn");
		const pageTurnFront = pageTurn.querySelector(".front .page-content");
		const pageTurnBack = pageTurn.querySelector(".back .page-content");
		const pageIndicator = document.getElementById("pageIndicator");
		const prevButton = document.getElementById("prevPage");
		const nextButton = document.getElementById("nextPage");
		const readerLoading = document.getElementById("readerLoading");

		const textures = createTextures();
		applyTextures(textures);
		buildShelf();
		bindReader();

		function createTextures() {
			const noise = generateNoise(220, 42);
			const paper = generatePaperTexture(260);
			return { noise, paper };
		}

		function applyTextures({ noise, paper }) {
			document.documentElement.style.setProperty("--noise-texture", `url(${noise})`);
			document.documentElement.style.setProperty("--paper-texture", `url(${paper})`);
		}

		function generateNoise(size, opacity) {
			const canvas = document.createElement("canvas");
			canvas.width = canvas.height = size;
			const ctx = canvas.getContext("2d");
			const imageData = ctx.createImageData(size, size);
			for (let i = 0; i < imageData.data.length; i += 4) {
				const shade = Math.floor(Math.random() * 255);
				imageData.data[i] = shade;
				imageData.data[i + 1] = shade;
				imageData.data[i + 2] = shade;
				imageData.data[i + 3] = opacity;
			}
			ctx.putImageData(imageData, 0, 0);
			return canvas.toDataURL();
		}

		function generatePaperTexture(size) {
			const canvas = document.createElement("canvas");
			canvas.width = canvas.height = size;
			const ctx = canvas.getContext("2d");

			const baseGradient = ctx.createLinearGradient(0, 0, size, size);
			baseGradient.addColorStop(0, "#f6f1e6");
			baseGradient.addColorStop(1, "#e8ddc6");
			ctx.fillStyle = baseGradient;
			ctx.fillRect(0, 0, size, size);

			ctx.globalAlpha = 0.22;
			for (let i = 0; i < 4800; i++) {
				const x = Math.random() * size;
				const y = Math.random() * size;
				const radius = Math.random() * 1.2;
				ctx.fillStyle = `rgba(182, 166, 140, ${Math.random() * 0.4})`;
				ctx.beginPath();
				ctx.arc(x, y, radius, 0, Math.PI * 2);
				ctx.fill();
			}

			ctx.globalAlpha = 0.16;
			for (let i = 0; i < 2800; i++) {
				const x = Math.random() * size;
				const y = Math.random() * size;
				const w = Math.random() * 2.4 + 0.2;
				const h = Math.random() * 10 + 0.4;
				ctx.fillStyle = `rgba(128, 108, 92, ${Math.random() * 0.2})`;
				ctx.fillRect(x, y, w, h);
			}

			return canvas.toDataURL();
		}

		function buildShelf() {
			BOOKS.forEach((meta, index) => {
				const slot = document.createElement("div");
				slot.className = "book-slot";
				const button = createBook(meta, index);
				slot.appendChild(button);
				shelfEl.appendChild(slot);
			});
		}

		function createBook(meta, index) {
			const button = document.createElement("button");
			button.className = "book";
			button.setAttribute("type", "button");
			button.dataset.index = index;
			button.style.setProperty("--cover-hue", meta.hue);
			button.style.setProperty("--cover-sat", meta.sat);
			button.style.setProperty("--cover-light", meta.light);
			button.style.setProperty("--book-depth", `${meta.thickness}px`);

			const block = document.createElement("div");
			block.className = "block";

			const front = document.createElement("div");
			front.className = "face cover-front";
			front.innerHTML = `
				<div class="mark">Project Gutenberg Edition</div>
				<div class="title">${meta.title}</div>
				<div class="author">${meta.author}</div>
			`;

			const back = document.createElement("div");
			back.className = "face cover-back";

			const spine = document.createElement("div");
			spine.className = "spine";
			spine.innerHTML = `<span>${meta.title}</span>`;

			const edgeTop = document.createElement("div");
			edgeTop.className = "edge edge-top";

			const edgeBottom = document.createElement("div");
			edgeBottom.className = "edge edge-bottom";

			const edgeSide = document.createElement("div");
			edgeSide.className = "edge edge-side";

			block.appendChild(front);
			block.appendChild(back);
			block.appendChild(spine);
			block.appendChild(edgeTop);
			block.appendChild(edgeBottom);
			block.appendChild(edgeSide);

			button.appendChild(block);

			button.addEventListener("click", () => pullOutBook(button, meta));

			return button;
		}

		function pullOutBook(element, meta) {
			if (state.pulling) return;
			state.pulling = true;
			if (state.activeElement && state.activeElement !== element) {
				state.activeElement.classList.remove("book--active");
			}
			element.classList.add("book--active");
			state.activeElement = element;
			setTimeout(() => {
				openReader(meta);
				state.pulling = false;
			}, 640);
		}

		function bindReader() {
			readerClose.addEventListener("click", closeReader);
			prevButton.addEventListener("click", () => turnPage(-1));
			nextButton.addEventListener("click", () => turnPage(1));
			pageTurn.addEventListener("animationend", handleTurnEnd);
			document.addEventListener("keydown", handleKey);
			readerEl.addEventListener("click", evt => {
				if (evt.target === readerEl) closeReader();
			});
		}

		function openReader(meta) {
			state.readerOpen = true;
			state.currentBook = meta;
			readerEl.classList.add("reader-overlay--visible");
			readerTitle.textContent = meta.title;
			readerAuthor.textContent = meta.author;
			if (!meta.pages) {
				loadBook(meta);
			} else {
				loadPages(meta);
			}
		}

		async function loadBook(meta) {
			readerLoading.classList.add("active");
			try {
				const response = await fetch(meta.path);
				if (!response.ok) throw new Error(`Unable to fetch ${meta.path}`);
				const text = await response.text();
				meta.pages = paginate(text, meta.pageEstimate || 1600);
			} catch (error) {
				meta.pages = [
					`<p>We could not retrieve this text right now.</p><p>${escapeHTML(String(error))}</p>`
				];
			}
			readerLoading.classList.remove("active");
			loadPages(meta);
		}

		function loadPages(meta) {
			state.currentIndex = 0;
			updateSpread();
		}

		function closeReader() {
			if (!state.readerOpen) return;
			state.readerOpen = false;
			readerEl.classList.remove("reader-overlay--visible");
			if (state.activeElement) {
				state.activeElement.classList.remove("book--active");
				state.activeElement = null;
			}
		}

		function paginate(rawText, approxChars) {
			const clean = rawText.replace(/\r/g, "").trim();
			const paragraphs = clean.split(/\n\s*\n/).map(p => p.replace(/\s+/g, " ").trim()).filter(Boolean);
			const pages = [];
			let buffer = [];
			let charCount = 0;
			paragraphs.forEach(paragraph => {
				const safe = escapeHTML(paragraph);
				const htmlParagraph = `<p>${safe}</p>`;
				if (charCount + paragraph.length > approxChars && buffer.length) {
					pages.push(buffer.join(""));
					buffer = [];
					charCount = 0;
				}
				buffer.push(htmlParagraph);
				charCount += paragraph.length;
			});
			if (buffer.length) {
				pages.push(buffer.join(""));
			}
			return pages;
		}

		function escapeHTML(input) {
			return input
				.replace(/&/g, "&amp;")
				.replace(/</g, "&lt;")
				.replace(/>/g, "&gt;")
				.replace(/"/g, "&quot;")
				.replace(/'/g, "&#39;");
		}

		function updateSpread() {
			const meta = state.currentBook;
			if (!meta || !meta.pages) return;
			const leftIndex = state.currentIndex;
			const rightIndex = leftIndex + 1;
			pageLeft.innerHTML = meta.pages[leftIndex] || "";
			pageRight.innerHTML = meta.pages[rightIndex] || "";
			prevButton.disabled = leftIndex <= 0;
			nextButton.disabled = rightIndex >= meta.pages.length;
			const formattedLeft = leftIndex + 1;
			const formattedRight = Math.min(meta.pages.length, rightIndex + 1);
			pageIndicator.textContent = `${formattedLeft.toString().padStart(3, "0")}` +
				" · " + `${formattedRight.toString().padStart(3, "0")}`;
		}

		function turnPage(direction) {
			const meta = state.currentBook;
			if (!meta || !meta.pages || state.isTurning) return;
			const target = state.currentIndex + direction * 2;
			if (target < 0 || target >= meta.pages.length) return;
			state.isTurning = true;
			pageTurn.classList.remove("turn-forward", "turn-backward", "turning");
			void pageTurn.offsetWidth;
			if (direction > 0) {
				pageTurn.dataset.side = "right";
				pageTurnFront.innerHTML = meta.pages[state.currentIndex + 1] || "";
				pageTurnBack.innerHTML = meta.pages[target] || "";
				pageTurn.classList.add("turning", "turn-forward");
			} else {
				pageTurn.dataset.side = "left";
				pageTurnFront.innerHTML = meta.pages[state.currentIndex] || "";
				pageTurnBack.innerHTML = meta.pages[target + 1] || "";
				pageTurn.classList.add("turning", "turn-backward");
			}
			pageTurn.dataset.targetIndex = String(target);
		}

		function handleTurnEnd() {
			const meta = state.currentBook;
			state.isTurning = false;
			pageTurn.classList.remove("turn-forward", "turn-backward", "turning");
			if (!meta) return;
			const target = Number(pageTurn.dataset.targetIndex || state.currentIndex);
			state.currentIndex = Math.max(0, Math.min(target, meta.pages.length - 1));
			if (state.currentIndex % 2 === 1) state.currentIndex -= 1;
			updateSpread();
		}

		function handleKey(event) {
			if (!state.readerOpen) return;
			if (event.key === "ArrowRight") {
				event.preventDefault();
				turnPage(1);
			} else if (event.key === "ArrowLeft") {
				event.preventDefault();
				turnPage(-1);
			} else if (event.key === "Escape") {
				event.preventDefault();
				closeReader();
			}
		}
	</script>
</body>
</html>
