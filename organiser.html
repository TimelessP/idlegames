<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <title>Personal Organiser</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            /* UI scaling unit – set by JS to min(clientWidth, clientHeight)/100 * userScale */
            --u: 8px;
            /* base length unit, updated by JS */
            --bw-thick: calc(0.8 * var(--u));
            /* thick comic outline */
            --bw: calc(0.45 * var(--u));
            /* inner comic lines */
            --radius: calc(2.0 * var(--u));
            --radius-sm: calc(1.0 * var(--u));
            --fs: calc(2.4 * var(--u));
            /* base font size (1.5x increase) */
            --fs-sm: calc(1.95 * var(--u));
            --fs-lg: calc(3.0 * var(--u));

            /* Palette – bright pastel yet earthy/cute */
            --peach: #ffc9a9;
            --peach-2: #ffb88f;
            --mint: #b9f5c6;
            --mint-2: #a8e6cf;
            --teal: #9ee7e5;
            --leaf: #a0d468;
            --sun: #ffd86b;
            --berry: #ff6fa7;
            --lav: #cdb4ff;

            --page: #ffffff;
            /* page white inside */
            --ink: #000000;
            /* black outline */
            --ink-80: rgba(0, 0, 0, 0.8);
            --ink-60: rgba(0, 0, 0, 0.6);
        }

        * {
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
        }

        /* Ensure form controls inherit the global font for uniform sizing */
        button,
        input,
        select,
        textarea {
            font: inherit;
        }

        option {
            font: inherit;
        }

        input::file-selector-button {
            font: inherit;
        }

        code,
        pre,
        kbd,
        samp {
            font-family: inherit;
            font-size: inherit;
        }

        /* Placeholders should match the same font and size */
        ::placeholder {
            font: inherit;
            color: var(--ink-60);
            opacity: 1;
            /* avoid extra dimming on some browsers */
        }

        body {
            margin: 0;
            font-family: 'Noto Sans', 'Noto Color Emoji', 'Segoe UI Emoji', 'Apple Color Emoji', 'Segoe UI', system-ui, sans-serif;
            font-size: var(--fs);
            line-height: 1.2;
            background:
                radial-gradient(120% 120% at 10% 20%, rgba(255, 216, 107, 0.55), transparent 55%),
                radial-gradient(120% 120% at 90% 10%, rgba(158, 231, 229, 0.6), transparent 50%),
                radial-gradient(120% 120% at 20% 90%, rgba(185, 245, 198, 0.6), transparent 45%),
                linear-gradient(135deg, #ffe3d5 0%, #e0ffd8 100%);
            /* slightly-more-saturated-than pastel peach and greens */
            display: grid;
            place-items: center;
            touch-action: manipulation;
        }

        /* Organiser outer shell */
        .organiser {
            width: min(94vw, 1200px);
            height: min(100svh, 900px);
            /* better on mobile vertical; avoids browser UI cutting content */
            background: var(--page);
            border: var(--bw-thick) solid var(--ink);
            border-radius: var(--radius);
            box-shadow:
                calc(0.6 * var(--u)) calc(0.6 * var(--u)) 0 0 var(--ink),
                0 0 0 calc(0.25 * var(--u)) var(--ink);
            display: grid;
            grid-template-rows: auto auto 1fr auto;
            /* titlebar, tabbar, content, footer */
            overflow: hidden;
            position: relative;
        }

        .titlebar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: calc(1.0 * var(--u));
            padding: calc(1.0 * var(--u)) calc(1.4 * var(--u));
            background: linear-gradient(90deg, var(--peach) 0%, var(--sun) 50%, var(--mint) 100%);
            border-bottom: var(--bw) solid var(--ink);
        }

        .titlebar .title {
            display: flex;
            align-items: center;
            gap: calc(1.0 * var(--u));
            font-weight: 900;
            letter-spacing: 0.02em;
            color: var(--ink);
            text-shadow: 0 calc(0.15 * var(--u)) 0 var(--page);
        }

        .titlebar .controls {
            display: flex;
            align-items: center;
            gap: calc(0.8 * var(--u));
        }

        .btn {
            appearance: none;
            border: var(--bw) solid var(--ink);
            border-radius: var(--radius-sm);
            background: var(--sun);
            color: var(--ink);
            padding: calc(0.5 * var(--u)) calc(1.0 * var(--u));
            font-weight: 800;
            cursor: pointer;
            box-shadow: 0 calc(0.25 * var(--u)) 0 0 var(--ink);
            transform: translateY(0);
            transition: transform 80ms ease, box-shadow 80ms ease, filter 120ms ease;
            user-select: none;
            touch-action: manipulation;
        }

        .btn:hover {
            filter: brightness(1.05);
        }

        .btn:active {
            transform: translateY(calc(0.25 * var(--u)));
            box-shadow: 0 0 0 0 var(--ink);
        }

        .btn.peach {
            background: var(--peach-2);
        }

        .btn.mint {
            background: var(--mint-2);
        }

        .btn.teal {
            background: var(--teal);
        }

        .btn.berry {
            background: var(--berry);
            color: #000;
        }

        .btn.lav {
            background: var(--lav);
        }

        .tabbar {
            display: flex;
            gap: calc(0.6 * var(--u));
            padding: calc(0.6 * var(--u)) calc(1.0 * var(--u));
            background: var(--page);
            border-bottom: var(--bw) solid var(--ink);
            align-items: center;
            /* prevent tabs from stretching vertically */
            flex-wrap: wrap;
            /* allow tabs to wrap to new lines on small screens */
        }

        .tabbar::-webkit-scrollbar {
            display: none;
        }

        .tab {
            border: var(--bw) solid var(--ink);
            border-bottom-width: calc(0.5 * var(--bw));
            border-radius: var(--radius-sm);
            padding: calc(0.5 * var(--u)) calc(1.0 * var(--u));
            background: var(--mint);
            font-weight: 800;
            cursor: pointer;
            box-shadow: 0 calc(0.25 * var(--u)) 0 0 var(--ink);
            user-select: none;
            flex: 0 1 auto;
            /* allow wrapping and shrinking if needed */
        }

        .tab[aria-selected="true"] {
            background: var(--sun);
            transform: translateY(calc(0.15 * var(--u)));
        }

        .content {
            display: grid;
            grid-template-rows: 1fr;
            overflow: hidden;
            min-height: 0;
            /* allow inner panels to shrink without forcing scrollbars */
            background: var(--page);
        }

        .panel {
            display: none;
            height: 100%;
            overflow: hidden;
        }

        .panel.active {
            display: grid;
            grid-template-rows: auto 1fr;
            min-height: 0;
            /* allow content to shrink within container */
        }

        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: calc(0.8 * var(--u));
            padding: calc(0.8 * var(--u)) calc(1.2 * var(--u));
            border-bottom: var(--bw) solid var(--ink);
            background: #fff;
        }

        .panel-body {
            padding: calc(1.0 * var(--u));
            overflow: auto;
            /* allow panel content (calendar, calculator, data) to scroll when needed */
        }

        /* Notes */

        .notes .panel-body {
            display: grid;
            grid-template-columns: 26% 74%;
            gap: calc(1.0 * var(--u));
            min-height: 0;
            /* allow children to shrink within grid to prevent overflow */
            overflow: hidden;
            /* localize scrolling to inner note list/content */
        }

        .note-list {
            border: var(--bw) solid var(--ink);
            border-radius: var(--radius-sm);
            overflow: auto;
            /* scroll only the list if it overflows */
            background: #fff;
            min-height: 0;
        }

        .note-item {
            display: flex;
            align-items: center;
            gap: calc(0.6 * var(--u));
            padding: calc(0.6 * var(--u));
            border-bottom: var(--bw) solid var(--ink);
            cursor: pointer;
            font-weight: 700;
        }

        .note-item:hover {
            background: var(--mint);
        }

        .note-item.active {
            background: var(--sun);
        }

        /* Title area inside note list item */
        .note-title {
            flex: 1 1 auto;
            min-width: 0;
        }

        /* Drag handle for touch/mouse reordering */
        .drag-handle {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: calc(2.2 * var(--u));
            height: calc(2.2 * var(--u));
            padding: 0;
            background: transparent;
            border: none;
            color: var(--ink-80);
            font-weight: 900;
            cursor: grab;
            user-select: none;
            touch-action: none;
            /* grabbing the handle should not scroll */
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        /* Visuals for custom touch-drag */
        .drag-ghost {
            position: fixed;
            z-index: 1000;
            pointer-events: none;
            opacity: 0.9;
            box-shadow: 0 calc(0.25 * var(--u)) 0 0 var(--ink);
        }

        .drag-placeholder {
            border: calc(0.2 * var(--u)) dashed var(--ink);
            border-radius: var(--radius-sm);
            margin: calc(0.2 * var(--u)) 0;
        }

        /* Dragging cues for sortable lists */
        .note-item.dragging,
        .task-item.dragging {
            opacity: 0.6;
        }

        .note-editor {
            display: grid;
            grid-template-rows: auto auto auto;
            /* title, textarea (resizable), buttons follow textarea */
            gap: calc(0.6 * var(--u));
            overflow: auto;
            /* allow the editor column to scroll if textarea is enlarged */
            min-height: 0;
            padding-bottom: calc(0.8 * var(--u));
            /* leave room so button shadows aren't clipped */
            padding-right: calc(1.0 * var(--u));
            /* add breathing room on the right edge so controls don't touch border */
            align-content: start;
            /* don't stretch rows to fill free space */
            align-items: start;
            /* don't stretch individual controls vertically */
        }

        /* Let note textarea take available space and be the only scroller in the editor column */
        #note-content {
            /* Let the textarea's own min-height control initial size; allow manual resize */
            overflow: auto;
        }

        .input,
        textarea {
            width: 100%;
            border: var(--bw) solid var(--ink);
            border-radius: var(--radius-sm);
            padding: calc(0.6 * var(--u));
            font-size: var(--fs);
            background: #fff;
        }

        /* Extra inner space so the caret doesn't hug the border */
        .input,
        input[type="text"],
        input[type="search"],
        input[type="email"],
        input[type="url"],
        input[type="password"],
        input[type="number"],
        input[type="date"],
        input[type="time"],
        textarea {
            padding: calc(0.8 * var(--u));
        }

        textarea {
            resize: vertical;
            min-height: calc(20 * var(--u));
        }

        /* Tasks */
        .task-input {
            display: flex;
            gap: calc(0.6 * var(--u));
        }

        .tasks-list {
            margin-top: calc(0.8 * var(--u));
        }

        .task-item {
            display: flex;
            align-items: center;
            gap: calc(0.6 * var(--u));
            padding: calc(0.5 * var(--u));
            border-bottom: var(--bw) solid var(--ink);
        }

        .task-item input[type="checkbox"] {
            width: calc(2.0 * var(--u));
            height: calc(2.0 * var(--u));
            border: var(--bw) solid var(--ink);
        }

        .task-item .txt {
            flex: 1;
            /* Preserve user-entered line breaks and wrap long words safely */
            white-space: pre-wrap;
            word-break: break-word;
        }

        /* While a task is being edited, give a subtle background and prevent accidental drag cursor */
        .task-item.editing {
            background: rgba(0, 0, 0, 0.03);
            cursor: default;
        }

        .task-item.done .txt {
            text-decoration: line-through;
            opacity: 0.7;
        }

        /* Calendar */
        .calendar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: calc(0.6 * var(--u));
        }

        .calendar-grid {
            margin-top: calc(0.8 * var(--u));
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: calc(0.5 * var(--u));
        }

        .day-name {
            text-align: center;
            font-weight: 900;
        }

        .day {
            border: var(--bw) solid var(--ink);
            border-radius: var(--radius-sm);
            min-height: calc(10.5 * var(--u));
            padding: calc(0.5 * var(--u));
            background: #fff;
            position: relative;
            cursor: pointer;
        }

        .day .date {
            font-weight: 900;
        }

        .dots {
            position: absolute;
            right: calc(0.5 * var(--u));
            bottom: calc(0.5 * var(--u));
            display: flex;
            gap: calc(0.3 * var(--u));
        }

        .dot {
            width: calc(0.8 * var(--u));
            height: calc(0.8 * var(--u));
            border-radius: 50%;
            border: var(--bw) solid var(--ink);
            background: var(--berry);
        }

        .event-editor {
            margin-top: calc(1.0 * var(--u));
            border: var(--bw) solid var(--ink);
            border-radius: var(--radius-sm);
            padding: calc(0.8 * var(--u));
            background: #fff;
        }

        /* Flip cards */
        .cards-wrap {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: calc(1.0 * var(--u));
        }

        .cards-wrap.practice .card-viewer {
            grid-column: 1 / -1;
        }

        .card-editor,
        .card-viewer {
            border: var(--bw) solid var(--ink);
            border-radius: var(--radius-sm);
            padding: calc(0.8 * var(--u));
            background: #fff;
        }

        /* Flip Cards: highlight active mode button and mute inactive */
        #cards-mode-practice[aria-pressed="true"],
        #cards-mode-manage[aria-pressed="true"] {
            background: var(--sun);
            filter: brightness(1.03);
        }
        #cards-mode-practice[aria-pressed="false"],
        #cards-mode-manage[aria-pressed="false"] {
            background: var(--mint-2);
        }

        #card-front,
        #card-back {
            flex: 1 1 20ch;
            min-height: calc(12 * var(--u));
        }

        .flashcard {
            border: var(--bw) solid var(--ink);
            border-radius: var(--radius);
            min-height: calc(18 * var(--u));
            display: grid;
            place-items: center;
            padding: calc(1.0 * var(--u));
            text-align: center;
            background: var(--mint);
            cursor: pointer;
            user-select: none;
            white-space: pre-wrap;
            overflow: auto;
            word-break: break-word;
            align-content: center;
        }

        .hidden {
            display: none !important;
        }

        /* Calculator */
        .calc {
            display: grid;
            grid-template-rows: auto 1fr;
            gap: calc(0.8 * var(--u));
            max-width: min(64vw, 560px);
        }

        .calc-display {
            border: var(--bw) solid var(--ink);
            border-radius: var(--radius-sm);
            padding: calc(0.8 * var(--u));
            background: #fff;
            font-weight: 900;
            letter-spacing: 0.04em;
        }

        .calc-keys {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: calc(0.6 * var(--u));
        }

        .key {
            text-align: center;
            padding: calc(0.8 * var(--u));
            border: var(--bw) solid var(--ink);
            border-radius: var(--radius-sm);
            background: var(--peach);
            font-weight: 900;
            cursor: pointer;
            user-select: none;
            box-shadow: 0 calc(0.25 * var(--u)) 0 0 var(--ink);
        }

        .key.op {
            background: var(--lav);
        }

        .key.wide {
            grid-column: span 2;
        }

        .key:active {
            transform: translateY(calc(0.25 * var(--u)));
            box-shadow: 0 0 0 0 var(--ink);
        }

        /* Data */
        .data-actions {
            display: flex;
            flex-wrap: wrap;
            gap: calc(0.6 * var(--u));
            margin-bottom: calc(0.8 * var(--u));
        }

        .mono {
            font-family: inherit;
            /* unify font across the app */
            font-size: inherit;
            /* standardize to base size everywhere */
        }

        .textarea-json {
            width: 100%;
            min-height: calc(22 * var(--u));
        }

        /* Visual cue for invalid JSON */
        .textarea-json.invalid {
            border-color: #d33 !important;
            box-shadow: 0 0 0 calc(0.2 * var(--u)) rgba(221, 51, 51, 0.15);
        }

        .notice {
            border: var(--bw) dashed var(--ink);
            border-radius: var(--radius-sm);
            padding: calc(0.8 * var(--u));
            margin-bottom: calc(0.8 * var(--u));
            background: #fff;
        }

        /* Footer */
        .footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: calc(1.0 * var(--u));
            padding: calc(0.8 * var(--u)) calc(1.2 * var(--u));
            border-top: var(--bw) solid var(--ink);
            background: var(--page);
        }

        /* Floating scale controls */
        .scale-controls {
            position: absolute;
            top: calc(env(safe-area-inset-top, 0px) + 0.8 * var(--u));
            right: calc(env(safe-area-inset-right, 0px) + 0.8 * var(--u));
            display: flex;
            gap: calc(0.4 * var(--u));
            z-index: 5;
        }

        /* When scale controls are placed inside the title bar, make them flow inline
           so they remain anchored to the bar (prevents overlap with the tab bar in fullscreen). */
        .titlebar .scale-controls {
            position: static;
            top: auto;
            right: auto;
            z-index: auto;
        }

        .round {
            border-radius: 50%;
            width: calc(3.8 * var(--u));
            height: calc(3.8 * var(--u));
            display: grid;
            place-items: center;
            line-height: 1;
            /* tighter baseline for symbols like ⤢, ⟳, −, + */
            padding: 0;
        }

        /* Ensure SVG icons inside round buttons match the visual weight and alignment of +/- */
        .round svg {
            width: 70%;
            height: 70%;
            display: block;
            fill: none;
        }
        .round svg path,
        .round svg polyline,
        .round svg line {
            stroke: var(--ink);
            stroke-width: 2.4;
            stroke-linecap: round;
            stroke-linejoin: round;
            fill: none;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Responsive adjustments */
        @media (max-width: 780px) {
            .organiser {
                width: 100vw;
            }

            .titlebar {
                padding: calc(0.8 * var(--u)) calc(1.0 * var(--u));
            }

            .tabbar {
                padding: calc(0.5 * var(--u)) calc(0.8 * var(--u));
            }

            .footer {
                padding: calc(0.6 * var(--u)) calc(0.8 * var(--u));
            }

            .notes .panel-body {
                grid-template-columns: 1fr;
            }

            .cards-wrap {
                grid-template-columns: 1fr;
            }

            #card-front,
            #card-back {
                min-height: calc(10 * var(--u));
            }
        }

        @media (max-height: 640px) {
            .titlebar {
                padding: calc(0.6 * var(--u)) calc(0.8 * var(--u));
            }

            .tabbar {
                padding: calc(0.4 * var(--u)) calc(0.6 * var(--u));
            }

            .panel-body {
                padding: calc(0.6 * var(--u));
            }

            .scale-controls {
                top: calc(env(safe-area-inset-top, 0px) + 0.5 * var(--u));
            }
        }
    </style>
</head>

<body>
    <div class="organiser" id="organiser" role="application" aria-label="Personal Organiser">
        <div class="scale-controls" aria-hidden="false">
            <button class="btn round teal" id="fullscreen-btn" title="Toggle Fullscreen" aria-pressed="false" aria-label="Toggle Fullscreen">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                    <polyline points="3 9 3 3 9 3"/>
                    <line x1="3" y1="3" x2="10" y2="10"/>
                    <polyline points="15 3 21 3 21 9"/>
                    <line x1="14" y1="10" x2="21" y2="3"/>
                    <polyline points="21 15 21 21 15 21"/>
                    <line x1="21" y1="21" x2="14" y2="14"/>
                    <polyline points="9 21 3 21 3 15"/>
                    <line x1="10" y1="14" x2="3" y2="21"/>
                </svg>
            </button>
            <button class="btn round peach" id="scale-down" title="Scale down" aria-label="Scale down">−</button>
            <button class="btn round lav" id="scale-reset" title="Reset scale" aria-label="Reset scale">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                    <polyline points="3 6 3 3 6 3"/>
                    <path d="M21 12a9 9 0 1 1-9-9"/>
                </svg>
            </button>
            <button class="btn round mint" id="scale-up" title="Scale up" aria-label="Scale up">+</button>
        </div>

        <div class="titlebar">
            <div class="title">
                <span style="font-size: var(--fs-lg)">📔</span>
                <span>Personal Organiser</span>
            </div>
            <div class="controls"></div>
        </div>

        <div class="tabbar" role="tablist" aria-label="Organiser sections">
            <button class="tab" role="tab" aria-selected="true" aria-controls="panel-notes"
                id="tab-notes">Notes</button>
            <button class="tab" role="tab" aria-selected="false" aria-controls="panel-calendar"
                id="tab-calendar">Calendar</button>
            <button class="tab" role="tab" aria-selected="false" aria-controls="panel-tasks"
                id="tab-tasks">Tasks</button>
            <button class="tab" role="tab" aria-selected="false" aria-controls="panel-cards" id="tab-cards">Flip
                Cards</button>
            <button class="tab" role="tab" aria-selected="false" aria-controls="panel-calc"
                id="tab-calc">Calculator</button>
            <button class="tab" role="tab" aria-selected="false" aria-controls="panel-data" id="tab-data">Data</button>
        </div>

        <div class="content">
            <!-- Notes Panel -->
            <section class="panel notes active" role="tabpanel" id="panel-notes" aria-labelledby="tab-notes">
                <div class="panel-header">
                    <div>
                        <button class="btn berry" id="add-note">+ New Note</button>
                    </div>
                    <div class="mono" id="notes-count">0 notes</div>
                </div>
                <div class="panel-body">
                    <div class="note-list" id="note-list" tabindex="0" aria-label="Notes list"></div>
                    <div class="note-editor">
                        <input class="input" id="note-title" placeholder="Note title" />
                        <textarea id="note-content" placeholder="Write your note here..."></textarea>
                        <div style="display:flex; gap: calc(0.6 * var(--u)); justify-content:flex-end;">
                            <button class="btn" id="delete-note">Delete</button>
                            <button class="btn mint" id="save-note">Save</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Calendar Panel -->
            <section class="panel" role="tabpanel" id="panel-calendar" aria-labelledby="tab-calendar">
                <div class="panel-header calendar-header">
                    <div style="display:flex; gap: calc(0.6 * var(--u)); align-items:center;">
                        <button class="btn" id="cal-prev">◀</button>
                        <div class="mono" id="cal-label">Month YYYY</div>
                        <button class="btn" id="cal-next">▶</button>
                    </div>
                    <button class="btn mint" id="cal-today">Today</button>
                </div>
                <div class="panel-body">
                    <div class="calendar-grid" id="calendar"></div>
                    <div class="event-editor" id="event-editor" hidden>
                        <div
                            style="display:flex; align-items:center; justify-content:space-between; gap: calc(0.6 * var(--u));">
                            <div class="mono" id="event-date-label"></div>
                            <div style="display:flex; gap: calc(0.6 * var(--u));">
                                <input class="input" id="event-text" placeholder="Add event" />
                                <button class="btn berry" id="add-event">Add</button>
                            </div>
                        </div>
                        <div id="event-list" class="tasks-list" style="margin-top: calc(0.8 * var(--u));"></div>
                    </div>
                </div>
            </section>

            <!-- Tasks Panel -->
            <section class="panel" role="tabpanel" id="panel-tasks" aria-labelledby="tab-tasks">
                <div class="panel-header">
                    <div class="task-input" style="flex:1;">
                        <input class="input" id="task-text" placeholder="New task" />
                        <button class="btn berry" id="add-task">Add</button>
                    </div>
                    <div class="mono" id="tasks-count">0 tasks</div>
                </div>
                <div class="panel-body">
                    <div id="tasks-list" class="tasks-list"></div>
                </div>
            </section>

            <!-- Flip Cards Panel -->
            <section class="panel" role="tabpanel" id="panel-cards" aria-labelledby="tab-cards">
                <div class="panel-header">
                    <div style="display:flex; gap: calc(0.6 * var(--u)); align-items:center;">
                        <div class="mono">Mode:</div>
                        <div style="display:flex; gap: calc(0.4 * var(--u));">
                            <button class="btn mint" id="cards-mode-practice" aria-pressed="true"
                                title="Practice mode">Practice</button>
                            <button class="btn" id="cards-mode-manage" aria-pressed="false"
                                title="Manage cards">Manage</button>
                        </div>
                        <div style="flex:1"></div>
                        <button class="btn mint" id="shuffle-cards" title="Shuffle deck">Shuffle</button>
                    </div>
                    <div class="mono" id="cards-count">0 flip cards</div>
                </div>
                <div class="panel-body">
                    <div class="cards-wrap">
                        <div class="card-editor">
                            <div
                                style="display:flex; flex-wrap:wrap; gap: calc(0.6 * var(--u)); align-items:flex-start;">
                                <textarea id="card-front" placeholder="Front (multi-line)..."></textarea>
                                <textarea id="card-back" placeholder="Back (multi-line)..."></textarea>
                                <div style="display:flex; gap: calc(0.6 * var(--u));">
                                    <button class="btn" id="add-card">+ New</button>
                                    <button class="btn mint" id="save-card">Save</button>
                                    <button class="btn" id="delete-card">Delete</button>
                                </div>
                            </div>
                            <div id="cards-list" class="tasks-list" style="margin-top: calc(0.8 * var(--u));"></div>
                        </div>
                        <div class="card-viewer">
                            <div class="flashcard" id="flashcard" title="Click to flip">Click to flip</div>
                            <div
                                style="display:flex; gap: calc(0.6 * var(--u)); justify-content:center; margin-top: calc(0.8 * var(--u));">
                                <button class="btn" id="prev-card">◀ Prev</button>
                                <button class="btn" id="next-card">Next ▶</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Calculator Panel -->
            <section class="panel" role="tabpanel" id="panel-calc" aria-labelledby="tab-calc">
                <div class="panel-header">
                    <div class="mono">Tap keys or type numbers/ops. Enter = equals, Backspace = clear last.</div>
                </div>
                <div class="panel-body">
                    <div class="calc">
                        <div class="calc-display mono" id="calc-display">0</div>
                        <div class="calc-keys" id="calc-keys">
                            <div class="key" data-k="7">7</div>
                            <div class="key" data-k="8">8</div>
                            <div class="key" data-k="9">9</div>
                            <div class="key op" data-k="/">÷</div>
                            <div class="key" data-k="4">4</div>
                            <div class="key" data-k="5">5</div>
                            <div class="key" data-k="6">6</div>
                            <div class="key op" data-k="*">×</div>
                            <div class="key" data-k="1">1</div>
                            <div class="key" data-k="2">2</div>
                            <div class="key" data-k="3">3</div>
                            <div class="key op" data-k="-">−</div>
                            <div class="key wide" data-k="0">0</div>
                            <div class="key" data-k=".">.</div>
                            <div class="key op" data-k="+">+</div>
                            <div class="key" data-k="C">C</div>
                            <div class="key wide" data-k="=">=</div>
                            <div class="key" data-k="(">(</div>
                            <div class="key" data-k=")">)</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Data Panel -->
            <section class="panel" role="tabpanel" id="panel-data" aria-labelledby="tab-data">
                <div class="panel-header">
                    <div class="data-actions">
                        <button class="btn mint" id="export-json">Export JSON</button>
                        <button class="btn" id="import-json">Import JSON</button>
                        <input type="file" id="file-input" accept="application/json" style="display:none" />
                        <button class="btn" id="apply-json" disabled>Apply Text</button>
                        <button class="btn berry" id="erase-all">Erase All</button>
                    </div>
                    <div class="mono">Local only • No accounts • No uploads</div>
                </div>
                <div class="panel-body">
                    <div class="notice">
                        <strong>Privacy Notice:</strong> Your organiser data is stored only in your browser's local
                        storage and never uploaded anywhere. You can export or erase it at any time.
                    </div>
                    <textarea id="json-area" class="textarea-json mono"
                        placeholder="Exported JSON appears here... Paste JSON here, then click Apply Text."></textarea>
                    <div class="mono" id="json-hint" style="margin-top: calc(0.5 * var(--u)); opacity: 0.8;">Paste JSON
                        and click Apply Text. Invalid JSON will not be imported.</div>
                </div>
            </section>
        </div>

        <div class="footer">
            <div class="mono">Tip: Use [ and ] to switch tabs • +/− buttons scale the whole UI</div>
            <div class="mono" id="status">Ready</div>
        </div>
    </div>

    <script>
        (function () {
            'use strict';

            const STORAGE_KEY = 'organiser-data-v1';
            const SCALE_KEY = 'organiser-ui-scale';

            // Choose a sensible default scale: bump size on mobile/coarse pointers, keep 1.0 on desktop
            function getDefaultScale() {
                try {
                    const coarse = window.matchMedia && window.matchMedia('(pointer: coarse)').matches;
                    const smallViewport = Math.min(window.innerWidth, window.innerHeight) <= 780;
                    return (coarse || smallViewport) ? 1.6 : 1.0;
                } catch {
                    return 1.0;
                }
            }

            const savedScaleStr = localStorage.getItem(SCALE_KEY);
            let userScale = savedScaleStr !== null ? Number(savedScaleStr) : getDefaultScale(); // persistent UI scale multiplier
            if (!isFinite(userScale) || userScale <= 0) userScale = getDefaultScale();

            const state = loadState() || {
                ui: { tab: 'notes', cardsMode: 'practice' },
                notes: [],
                tasks: [],
                events: {}, // { 'YYYY-MM-DD': [ {id, text} ] }
                cards: [],
            };

            // Ensure the floating controls are anchored inside the title bar so they move with it
            // (fixes Android fullscreen where absolute-positioned controls could overlap the tab bar).
            const titlebarControlsHost = document.querySelector('.titlebar .controls');
            const floatingScaleControls = document.querySelector('.scale-controls');
            if (titlebarControlsHost && floatingScaleControls && floatingScaleControls.parentElement !== titlebarControlsHost) {
                titlebarControlsHost.appendChild(floatingScaleControls);
            }

            // UTILITIES
            function gid(id) { return document.getElementById(id); }
            function fmtDate(d) {
                const y = d.getFullYear();
                const m = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                return `${y}-${m}-${day}`;
            }
            function uid() { return Math.random().toString(36).slice(2, 10); }
            function saveState() {
                try {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
                    setStatus('Saved');
                } catch (e) { console.warn('Save failed', e); setStatus('Save failed'); }
            }
            let saveTimer;
            function scheduleSave() { clearTimeout(saveTimer); saveTimer = setTimeout(saveState, 300); }
            function loadState() {
                try {
                    const s = localStorage.getItem(STORAGE_KEY);
                    return s ? JSON.parse(s) : null;
                } catch (e) { console.warn('Load failed', e); return null; }
            }
            function setStatus(msg) { gid('status').textContent = msg; setTimeout(() => gid('status').textContent = 'Ready', 1200); }

            // SCALING
            function updateScaleVars() {
                const minDim = Math.max(320, Math.min(window.innerWidth, window.innerHeight));
                const unit = (minDim / 100) * userScale;
                document.documentElement.style.setProperty('--u', unit + 'px');
            }
            function adjustScale(delta) {
                userScale = Math.max(0.6, Math.min(1.8, +(userScale + delta).toFixed(2)));
                localStorage.setItem(SCALE_KEY, String(userScale));
                updateScaleVars();
            }

            window.addEventListener('resize', updateScaleVars);
            gid('scale-up').addEventListener('click', () => adjustScale(0.05));
            gid('scale-down').addEventListener('click', () => adjustScale(-0.05));
            gid('scale-reset').addEventListener('click', () => {
                userScale = getDefaultScale();
                localStorage.setItem(SCALE_KEY, String(userScale));
                updateScaleVars();
                setStatus('Scale reset');
            });

            // FULLSCREEN
            const fsBtn = gid('fullscreen-btn');
            fsBtn.addEventListener('click', async () => {
                try {
                    if (!document.fullscreenElement) {
                        await gid('organiser').requestFullscreen();
                        fsBtn.setAttribute('aria-pressed', 'true');
                    } else {
                        await document.exitFullscreen();
                        fsBtn.setAttribute('aria-pressed', 'false');
                    }
                } catch (e) { console.warn(e); }
            });

            // TABS
            const tabs = [
                { id: 'notes', btn: gid('tab-notes'), panel: gid('panel-notes') },
                { id: 'calendar', btn: gid('tab-calendar'), panel: gid('panel-calendar') },
                { id: 'tasks', btn: gid('tab-tasks'), panel: gid('panel-tasks') },
                { id: 'cards', btn: gid('tab-cards'), panel: gid('panel-cards') },
                { id: 'calc', btn: gid('tab-calc'), panel: gid('panel-calc') },
                { id: 'data', btn: gid('tab-data'), panel: gid('panel-data') },
            ];
            function showTab(id) {
                tabs.forEach(t => {
                    const sel = (t.id === id);
                    t.btn.setAttribute('aria-selected', sel ? 'true' : 'false');
                    if (sel) t.panel.classList.add('active'); else t.panel.classList.remove('active');
                });
                state.ui.tab = id; scheduleSave();
            }
            tabs.forEach(t => t.btn.addEventListener('click', () => showTab(t.id)));
            window.addEventListener('keydown', (e) => {
                if (e.key === '[' || (e.altKey && e.key === 'ArrowLeft')) {
                    const idx = tabs.findIndex(t => t.id === state.ui.tab); showTab(tabs[(idx - 1 + tabs.length) % tabs.length].id);
                }
                if (e.key === ']' || (e.altKey && e.key === 'ArrowRight')) {
                    const idx = tabs.findIndex(t => t.id === state.ui.tab); showTab(tabs[(idx + 1) % tabs.length].id);
                }
            });

            // NOTES
            let currentNoteId = null;
            const noteList = gid('note-list');
            const noteTitle = gid('note-title');
            const noteContent = gid('note-content');
            let sortableNotesEnabled = false;
            function renderNotes() {
                noteList.innerHTML = '';
                state.notes.forEach(n => {
                    const div = document.createElement('div');
                    div.className = 'note-item' + (n.id === currentNoteId ? ' active' : '');
                    div.dataset.id = n.id;
                    div.setAttribute('draggable', 'true');
                    div.tabIndex = 0;

                    const title = document.createElement('div');
                    title.className = 'note-title';
                    title.textContent = n.title || '(untitled)';

                    const handle = document.createElement('button');
                    handle.type = 'button';
                    handle.className = 'drag-handle';
                    handle.title = 'Drag to reorder';
                    handle.setAttribute('aria-label', 'Drag to reorder');
                    handle.textContent = '⠿';
                    // Prevent row click when tapping the handle, but allow pointerdown to bubble for drag
                    handle.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); });

                    div.onclick = () => { currentNoteId = n.id; fillEditor(); renderNotes(); };
                    div.onkeydown = (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); div.click(); } };

                    div.append(title, handle);
                    noteList.appendChild(div);
                });
                gid('notes-count').textContent = `${state.notes.length} note${state.notes.length !== 1 ? 's' : ''}`;
            }
            function fillEditor() {
                const n = state.notes.find(x => x.id === currentNoteId);
                noteTitle.value = n ? n.title : '';
                noteContent.value = n ? n.content : '';
            }
            function saveCurrentNote(createIfMissing = false) {
                const title = noteTitle.value.trim();
                const content = noteContent.value;
                if (!currentNoteId) {
                    if (!createIfMissing) { return; }
                    if (!title && !content) { return; }
                    const n = { id: uid(), title: title || 'New note', content, updated: Date.now() };
                    state.notes.unshift(n);
                    currentNoteId = n.id;
                } else {
                    const n = state.notes.find(x => x.id === currentNoteId);
                    if (!n) return;
                    n.title = title;
                    n.content = content;
                    n.updated = Date.now();
                }
                scheduleSave();
                renderNotes();
                fillEditor();
            }
            gid('add-note').addEventListener('click', () => {
                const n = { id: uid(), title: 'New note', content: '', updated: Date.now() };
                state.notes.unshift(n);
                currentNoteId = n.id;
                scheduleSave();
                renderNotes();
                fillEditor();
                noteTitle.focus();
            });
            gid('save-note').addEventListener('click', () => saveCurrentNote(true));
            gid('delete-note').addEventListener('click', () => {
                if (!currentNoteId) return;
                const idx = state.notes.findIndex(x => x.id === currentNoteId);
                if (idx >= 0) { state.notes.splice(idx, 1); currentNoteId = null; scheduleSave(); renderNotes(); fillEditor(); }
            });
            noteTitle.addEventListener('input', () => saveCurrentNote(false));
            noteContent.addEventListener('input', () => saveCurrentNote(false));

            // TASKS
            const taskText = gid('task-text');
            const tasksList = gid('tasks-list');
            let sortableTasksEnabled = false;
            function renderTasks() {
                tasksList.innerHTML = '';
                state.tasks.forEach(t => {
                    const row = document.createElement('div');
                    row.className = 'task-item' + (t.done ? ' done' : '');
                    row.dataset.id = t.id;
                    row.setAttribute('draggable', 'true');

                    const handle = document.createElement('button');
                    handle.type = 'button';
                    handle.className = 'drag-handle';
                    handle.title = 'Drag to reorder';
                    handle.setAttribute('aria-label', 'Drag to reorder');
                    handle.textContent = '⠿';
                    handle.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); });

                    const cb = document.createElement('input');
                    cb.type = 'checkbox';
                    cb.checked = !!t.done;
                    cb.onchange = () => { t.done = cb.checked; scheduleSave(); renderTasks(); };

                    const txt = document.createElement('div');
                    txt.className = 'txt';
                    txt.textContent = t.text;

                    const editBtn = document.createElement('button');
                    editBtn.className = 'btn';
                    editBtn.textContent = 'Edit';

                    const del = document.createElement('button');
                    del.className = 'btn';
                    del.textContent = 'Delete';
                    del.onclick = () => { state.tasks = state.tasks.filter(x => x.id !== t.id); scheduleSave(); renderTasks(); };

                    // Inline edit flow with Save/Cancel
                    editBtn.onclick = () => {
                        if (row.classList.contains('editing')) return;
                        row.classList.add('editing');
                        // rebuild row for editing
                        row.innerHTML = '';
                        const cb2 = document.createElement('input'); cb2.type = 'checkbox'; cb2.checked = !!t.done; cb2.onchange = () => { t.done = cb2.checked; scheduleSave(); };
                        const editor = document.createElement('textarea'); editor.className = 'input mono'; editor.style.minHeight = 'calc(8 * var(--u))'; editor.value = t.text || '';
                        const saveBtn = document.createElement('button'); saveBtn.className = 'btn mint'; saveBtn.textContent = 'Save';
                        const cancelBtn = document.createElement('button'); cancelBtn.className = 'btn peach'; cancelBtn.textContent = 'Cancel';
                        const del2 = document.createElement('button'); del2.className = 'btn'; del2.textContent = 'Delete'; del2.onclick = () => { state.tasks = state.tasks.filter(x => x.id !== t.id); scheduleSave(); renderTasks(); };
                        saveBtn.onclick = () => { t.text = editor.value; scheduleSave(); renderTasks(); };
                        cancelBtn.onclick = () => { renderTasks(); };
                        row.append(cb2, editor, saveBtn, cancelBtn, del2);
                        editor.focus();
                    };

                    // Restrict native drag to only start from the handle and when not editing
                    row.addEventListener('dragstart', (e) => {
                        if (row.classList.contains('editing') || !e.target.closest('.drag-handle')) {
                            e.preventDefault();
                            return false;
                        }
                    });

                    row.append(handle, cb, txt, editBtn, del);
                    tasksList.appendChild(row);
                });
                gid('tasks-count').textContent = `${state.tasks.length} task${state.tasks.length !== 1 ? 's' : ''}`;
            }

            // SORTABLE (drag & drop) for notes and tasks
            function reorderArrayById(arr, ids) {
                const index = new Map();
                ids.forEach((id, i) => index.set(id, i));
                // Items with known ids ordered first, others keep their relative order at the end
                return arr.slice().sort((a, b) => {
                    const ai = index.has(a.id) ? index.get(a.id) : Number.MAX_SAFE_INTEGER;
                    const bi = index.has(b.id) ? index.get(b.id) : Number.MAX_SAFE_INTEGER;
                    if (ai !== bi) return ai - bi;
                    return 0;
                });
            }

            function enableSortable(container, itemSelector, onOrderChange) {
                function getAfterElement(y) {
                    const els = Array.from(container.querySelectorAll(itemSelector + ':not(.dragging)'));
                    return els.reduce((closest, child) => {
                        const box = child.getBoundingClientRect();
                        const offset = y - (box.top + box.height / 2);
                        if (offset < 0 && offset > closest.offset) { return { offset, element: child }; }
                        else { return closest; }
                    }, { offset: Number.NEGATIVE_INFINITY, element: null }).element;
                }

                // Desktop: native drag & drop, only from handle
                container.addEventListener('dragstart', (e) => {
                    const item = e.target.closest(itemSelector);
                    if (!item) return;
                    if (!e.target.closest('.drag-handle') || item.classList.contains('editing')) { e.preventDefault(); return; }
                    item.classList.add('dragging');
                    if (e.dataTransfer) { try { e.dataTransfer.effectAllowed = 'move'; } catch { } }
                });
                container.addEventListener('dragend', (e) => {
                    const item = e.target.closest(itemSelector);
                    if (item) item.classList.remove('dragging');
                });
                container.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    const dragging = container.querySelector('.dragging');
                    if (!dragging) return;
                    const after = getAfterElement(e.clientY);
                    if (after == null) container.appendChild(dragging); else container.insertBefore(dragging, after);
                });
                container.addEventListener('drop', (e) => {
                    e.preventDefault();
                    const orderedIds = Array.from(container.querySelectorAll(itemSelector)).map(el => el.dataset.id).filter(Boolean);
                    onOrderChange(orderedIds);
                });

                // Touch: pointer-based custom drag from handle only
                let draggingEl = null;
                let ghostEl = null;
                let placeholderEl = null;
                let startOffsetY = 0;
                let scrollTimer = null;
                function stopAutoScroll() { if (scrollTimer) { cancelAnimationFrame(scrollTimer); scrollTimer = null; } }
                function autoScrollIfNeeded(y) {
                    const rect = container.getBoundingClientRect();
                    const threshold = Math.min(40, rect.height * 0.1);
                    const topZone = rect.top + threshold;
                    const bottomZone = rect.bottom - threshold;
                    let delta = 0;
                    if (y < topZone) delta = -6; else if (y > bottomZone) delta = 6;
                    if (delta !== 0) { scrollTimer = requestAnimationFrame(() => { container.scrollTop += delta; }); }
                    else { stopAutoScroll(); }
                }

                container.addEventListener('pointerdown', (e) => {
                    const handle = e.target.closest('.drag-handle');
                    if (!handle) return;
                    const item = handle.closest(itemSelector);
                    if (!item || item.classList.contains('editing')) return;
                    e.preventDefault();
                    draggingEl = item;
                    const rect = draggingEl.getBoundingClientRect();
                    startOffsetY = e.clientY - rect.top;
                    placeholderEl = document.createElement('div');
                    placeholderEl.className = 'drag-placeholder';
                    placeholderEl.style.height = rect.height + 'px';
                    container.insertBefore(placeholderEl, draggingEl.nextSibling);
                    ghostEl = draggingEl.cloneNode(true);
                    ghostEl.classList.add('drag-ghost');
                    ghostEl.style.width = rect.width + 'px';
                    ghostEl.style.left = rect.left + 'px';
                    ghostEl.style.top = (e.clientY - startOffsetY) + 'px';
                    document.body.appendChild(ghostEl);
                    draggingEl.classList.add('dragging');
                    draggingEl.style.display = 'none';
                    handle.setPointerCapture?.(e.pointerId);

                    function onMove(ev) {
                        if (!ghostEl) return;
                        ghostEl.style.top = (ev.clientY - startOffsetY) + 'px';
                        const after = getAfterElement(ev.clientY);
                        if (after == null) container.appendChild(placeholderEl); else container.insertBefore(placeholderEl, after);
                        autoScrollIfNeeded(ev.clientY);
                    }
                    function onUp(ev) {
                        stopAutoScroll();
                        handle.releasePointerCapture?.(e.pointerId);
                        window.removeEventListener('pointermove', onMove);
                        window.removeEventListener('pointerup', onUp);
                        window.removeEventListener('pointercancel', onUp);
                        if (!draggingEl) return;
                        draggingEl.style.display = '';
                        draggingEl.classList.remove('dragging');
                        container.insertBefore(draggingEl, placeholderEl);
                        ghostEl?.remove(); ghostEl = null;
                        placeholderEl?.remove(); placeholderEl = null;
                        draggingEl = null;
                        const orderedIds = Array.from(container.querySelectorAll(itemSelector)).map(el => el.dataset.id).filter(Boolean);
                        onOrderChange(orderedIds);
                    }
                    window.addEventListener('pointermove', onMove, { passive: false });
                    window.addEventListener('pointerup', onUp, { passive: false });
                    window.addEventListener('pointercancel', onUp, { passive: false });
                }, { passive: false });
            }
            function addTask() {
                const v = taskText.value.trim(); if (!v) return;
                state.tasks.push({ id: uid(), text: v, done: false });
                taskText.value = '';
                scheduleSave(); renderTasks();
            }
            gid('add-task').addEventListener('click', addTask);
            taskText.addEventListener('keydown', (e) => { if (e.key === 'Enter') { addTask(); } });

            // Flush pending save before closing/navigating away
            window.addEventListener('beforeunload', () => { try { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); } catch { } });

            // CALENDAR
            const cal = gid('calendar');
            const calLabel = gid('cal-label');
            const eventEditor = gid('event-editor');
            const eventDateLabel = gid('event-date-label');
            const eventText = gid('event-text');
            const eventList = gid('event-list');
            let calYear, calMonth; // month 0-11
            let selectedDateStr = null;

            function setMonth(y, m) { calYear = y; calMonth = m; renderCalendar(); }
            function renderCalendar() {
                const names = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                calLabel.textContent = `${names[calMonth]} ${calYear}`;
                cal.innerHTML = '';
                const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                dayNames.forEach(n => { const d = document.createElement('div'); d.className = 'day-name'; d.textContent = n; cal.appendChild(d); });
                const first = new Date(calYear, calMonth, 1);
                const start = first.getDay();
                const daysInMonth = new Date(calYear, calMonth + 1, 0).getDate();
                for (let i = 0; i < start; i++) { const empty = document.createElement('div'); cal.appendChild(empty); }
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `${calYear}-${String(calMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const cell = document.createElement('div');
                    cell.className = 'day';
                    const label = document.createElement('div'); label.className = 'date'; label.textContent = String(day);
                    cell.appendChild(label);
                    const dots = document.createElement('div'); dots.className = 'dots';
                    const evs = state.events[dateStr] || [];
                    evs.slice(0, 4).forEach(() => { const dot = document.createElement('div'); dot.className = 'dot'; dots.appendChild(dot); });
                    cell.appendChild(dots);
                    cell.onclick = () => { selectedDateStr = dateStr; openEventEditor(dateStr); };
                    cal.appendChild(cell);
                }
            }
            function openEventEditor(dateStr) {
                eventEditor.hidden = false;
                eventDateLabel.textContent = dateStr;
                eventText.value = '';
                renderEventsFor(dateStr);
            }
            function renderEventsFor(dateStr) {
                eventList.innerHTML = '';
                const evs = state.events[dateStr] || [];
                evs.forEach(ev => {
                    const row = document.createElement('div'); row.className = 'task-item';
                    const dot = document.createElement('div'); dot.className = 'dot'; dot.style.marginRight = 'calc(0.4 * var(--u))';
                    const txt = document.createElement('div'); txt.className = 'txt'; txt.contentEditable = 'true'; txt.textContent = ev.text; txt.oninput = () => { ev.text = txt.textContent; scheduleSave(); };
                    const del = document.createElement('button'); del.className = 'btn'; del.textContent = 'Delete'; del.onclick = () => { state.events[dateStr] = (state.events[dateStr] || []).filter(x => x.id !== ev.id); if (state.events[dateStr].length === 0) delete state.events[dateStr]; scheduleSave(); renderCalendar(); renderEventsFor(dateStr); };
                    row.append(dot, txt, del);
                    eventList.appendChild(row);
                });
            }
            gid('add-event').addEventListener('click', () => {
                if (!selectedDateStr) return; const v = eventText.value.trim(); if (!v) return;
                const list = state.events[selectedDateStr] = state.events[selectedDateStr] || [];
                list.push({ id: uid(), text: v });
                eventText.value = '';
                scheduleSave(); renderCalendar(); renderEventsFor(selectedDateStr);
            });
            gid('cal-prev').addEventListener('click', () => { let m = calMonth - 1, y = calYear; if (m < 0) { m = 11; y--; } setMonth(y, m); });
            gid('cal-next').addEventListener('click', () => { let m = calMonth + 1, y = calYear; if (m > 11) { m = 0; y++; } setMonth(y, m); });
            gid('cal-today').addEventListener('click', () => { const d = new Date(); setMonth(d.getFullYear(), d.getMonth()); });

            // INDEX CARDS (Practice / Manage)
            const cardsList = gid('cards-list');
            const cardFront = gid('card-front');
            const cardBack = gid('card-back');
            const flashcard = gid('flashcard');
            const cardsModePracticeBtn = gid('cards-mode-practice');
            const cardsModeManageBtn = gid('cards-mode-manage');
            const cardsWrap = document.querySelector('.cards-wrap');
            let currentCardId = null;
            let viewerIndex = 0;
            let viewerFront = true;

            function setCardsMode(mode) {
                state.ui.cardsMode = mode;
                const isPractice = mode === 'practice';
                cardsModePracticeBtn.setAttribute('aria-pressed', String(isPractice));
                cardsModeManageBtn.setAttribute('aria-pressed', String(!isPractice));
                // Hide editor when practicing
                const editor = document.querySelector('.card-editor');
                if (isPractice) {
                    editor.classList.add('hidden');
                    cardsWrap.classList.add('practice');
                    cardsWrap.classList.remove('manage');
                    // ensure we start on the front side when practicing
                    viewerFront = true; updateViewer();
                } else {
                    editor.classList.remove('hidden');
                    cardsWrap.classList.remove('practice');
                    cardsWrap.classList.add('manage');
                }
                scheduleSave();
            }

            function renderCards() {
                cardsList.innerHTML = '';
                state.cards.forEach(c => {
                    const row = document.createElement('div'); row.className = 'task-item';
                    const preview = document.createElement('div'); preview.className = 'txt mono';
                    const firstLine = (c.front || '').split(/\r?\n/)[0] || '(front)';
                    preview.textContent = firstLine;
                    const sel = document.createElement('button'); sel.className = 'btn'; sel.textContent = 'Edit'; sel.onclick = () => { currentCardId = c.id; cardFront.value = c.front; cardBack.value = c.back; };
                    const del = document.createElement('button'); del.className = 'btn'; del.textContent = 'Delete'; del.onclick = () => { state.cards = state.cards.filter(x => x.id !== c.id); scheduleSave(); renderCards(); updateViewer(); };
                    row.append(preview, sel, del);
                    cardsList.appendChild(row);
                });
                gid('cards-count').textContent = `${state.cards.length} flip card${state.cards.length !== 1 ? 's' : ''}`;
            }

            function updateViewer() {
                if (state.cards.length === 0) { flashcard.textContent = 'No flip cards yet'; return; }
                const c = state.cards[(viewerIndex % state.cards.length + state.cards.length) % state.cards.length];
                flashcard.textContent = viewerFront ? (c.front || '(front)') : (c.back || '(back)');
            }

            // Manage actions
            // Add creates a blank card and selects it for editing
            gid('add-card')?.addEventListener('click', () => {
                const c = { id: uid(), front: '', back: '' };
                state.cards.push(c); currentCardId = c.id; cardFront.value = ''; cardBack.value = '';
                scheduleSave(); renderCards(); updateViewer();
            });

            gid('save-card').addEventListener('click', () => {
                if (!currentCardId) { // create new if none selected
                    const c = { id: uid(), front: cardFront.value, back: cardBack.value };
                    state.cards.push(c);
                } else {
                    const c = state.cards.find(x => x.id === currentCardId); if (c) { c.front = cardFront.value; c.back = cardBack.value; }
                }
                currentCardId = null; cardFront.value = ''; cardBack.value = ''; scheduleSave(); renderCards(); updateViewer();
            });

            gid('delete-card').addEventListener('click', () => {
                if (!currentCardId) return; state.cards = state.cards.filter(x => x.id !== currentCardId); currentCardId = null; cardFront.value = ''; cardBack.value = ''; scheduleSave(); renderCards(); updateViewer();
            });

            // Practice actions
            gid('shuffle-cards').addEventListener('click', () => {
                for (let i = state.cards.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1));[state.cards[i], state.cards[j]] = [state.cards[j], state.cards[i]]; }
                viewerIndex = 0; viewerFront = true; updateViewer(); scheduleSave();
            });
            gid('prev-card').addEventListener('click', () => { viewerIndex--; viewerFront = true; updateViewer(); });
            gid('next-card').addEventListener('click', () => { viewerIndex++; viewerFront = true; updateViewer(); });
            flashcard.addEventListener('click', () => { viewerFront = !viewerFront; updateViewer(); });

            // Mode toggle
            cardsModePracticeBtn.addEventListener('click', () => setCardsMode('practice'));
            cardsModeManageBtn.addEventListener('click', () => setCardsMode('manage'));

            // CALCULATOR
            const calcDisplay = gid('calc-display');
            const calcKeys = gid('calc-keys');
            let expr = '';
            function setDisplay(v) { calcDisplay.textContent = v; }
            function sanitize(s) { return s.replace(/[^0-9+\-*/().]/g, ''); }
            function press(k) {
                if (k === 'C') { expr = ''; setDisplay('0'); return; }
                if (k === '=') { try { const res = Function('return (' + sanitize(expr || '0') + ')')(); expr = String(res); setDisplay(expr); } catch { setDisplay('Err'); } return; }
                if (k === 'Backspace') { expr = expr.slice(0, -1); setDisplay(expr || '0'); return; }
                expr += k; setDisplay(expr);
            }
            calcKeys.addEventListener('click', (e) => { const t = e.target.closest('.key'); if (!t) return; press(t.dataset.k); });
            window.addEventListener('keydown', (e) => {
                if (['0', '1', '2', '3', '4', '5', '6', '7', '8', '9', '.', '+', '-', '*', '/', '(', ')'].includes(e.key)) press(e.key);
                else if (e.key === 'Enter' || e.key === '=') press('=');
                else if (e.key === 'Backspace') press('Backspace');
            });

            // DATA PANEL
            const exportBtn = gid('export-json');
            const importBtn = gid('import-json');
            const fileInput = gid('file-input');
            const jsonArea = gid('json-area');
            exportBtn.addEventListener('click', () => {
                const data = JSON.stringify(state, null, 2);
                jsonArea.value = data;
                try {
                    const blob = new Blob([data], { type: 'application/json' });
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    a.download = 'organiser-export.json';
                    a.click();
                    URL.revokeObjectURL(a.href);
                } catch { }
            });
            importBtn.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', () => {
                const f = fileInput.files && fileInput.files[0]; if (!f) return;
                const r = new FileReader();
                r.onload = () => {
                    try { const obj = JSON.parse(String(r.result)); if (obj && typeof obj === 'object') { Object.assign(state, obj); scheduleSave(); initRenderAll(); setStatus('Imported'); } }
                    catch (e) { alert('Invalid JSON'); }
                };
                r.readAsText(f);
            });
            // Validate JSON as user types/pastes; do not import until Apply is pressed
            const applyBtn = gid('apply-json');
            function validateJsonInput() {
                const txt = jsonArea.value.trim();
                if (!txt) { jsonArea.classList.remove('invalid'); applyBtn.disabled = true; return; }
                try { JSON.parse(txt); jsonArea.classList.remove('invalid'); applyBtn.disabled = false; }
                catch { jsonArea.classList.add('invalid'); applyBtn.disabled = true; }
            }
            jsonArea.addEventListener('input', validateJsonInput);
            jsonArea.addEventListener('paste', () => setTimeout(validateJsonInput, 0));
            applyBtn.addEventListener('click', () => {
                const txt = jsonArea.value.trim();
                try {
                    const obj = JSON.parse(txt);
                    if (obj && typeof obj === 'object') {
                        Object.assign(state, obj);
                        scheduleSave();
                        initRenderAll();
                        setStatus('Imported');
                        applyBtn.disabled = true;
                    }
                } catch {
                    alert('Invalid JSON');
                }
            });
            gid('erase-all').addEventListener('click', () => {
                if (confirm('Erase ALL organiser data? This cannot be undone.')) {
                    localStorage.removeItem(STORAGE_KEY);
                    state.ui = { tab: 'notes' }; state.notes = []; state.tasks = []; state.events = {}; state.cards = [];
                    initRenderAll(); setStatus('Erased');
                }
            });

            // INIT
            function initRenderAll() {
                // Notes
                if (state.notes.length) { currentNoteId = state.notes[0].id; } else { currentNoteId = null; }
                renderNotes(); fillEditor();
                if (!sortableNotesEnabled) {
                    enableSortable(noteList, '.note-item', (ids) => {
                        state.notes = reorderArrayById(state.notes, ids);
                        scheduleSave();
                        renderNotes();
                        fillEditor();
                    });
                    sortableNotesEnabled = true;
                }
                // Tasks
                renderTasks();
                if (!sortableTasksEnabled) {
                    enableSortable(tasksList, '.task-item', (ids) => {
                        state.tasks = reorderArrayById(state.tasks, ids);
                        scheduleSave();
                        renderTasks();
                    });
                    sortableTasksEnabled = true;
                }
                // Calendar
                const d = new Date(); setMonth(d.getFullYear(), d.getMonth()); selectedDateStr = null; eventEditor.hidden = true;
                // Cards
                renderCards(); updateViewer(); setCardsMode(state.ui.cardsMode || 'practice');
                // Tabs
                showTab(state.ui.tab || 'notes');
            }

            // Start
            updateScaleVars();
            initRenderAll();
        })();
    </script>
</body>

</html>