<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fossil Hunter - Archaeological Discovery Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #8B4513, #D2691E, #F4A460);
            color: white;
            height: 100vh;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            user-select: none;
        }

        .game-header {
            background: rgba(0,0,0,0.4);
            box-shadow: 0 1px 5px rgba(0,0,0,0.3);
            padding: 8px 12px;
            position: relative;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 100%;
            gap: 15px;
        }

        .game-title {
            font-size: 1.3em;
            color: #ffd700;
            font-weight: bold;
            white-space: nowrap;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .header-stats {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 4px;
            background: rgba(255,255,255,0.1);
            border-radius: 6px;
            padding: 4px 8px;
            min-width: 0;
        }

        .stat-label {
            font-size: 0.75em;
            color: #ccc;
            white-space: nowrap;
        }

        .stat-value {
            font-size: 0.9em;
            font-weight: bold;
            color: #ffd700;
            white-space: nowrap;
        }

        .header-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .header-btn {
            background: linear-gradient(145deg, #8B4513, #A0522D);
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: bold;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .header-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.3);
        }

        .game-area {
            flex: 1;
            position: relative;
            background: linear-gradient(145deg, #8B4513, #A0522D);
            border: 4px solid #654321;
            border-radius: 15px;
            margin: 8px;
            padding: 8px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Responsive layout - auto-fit to viewport */
        .game-header {
            flex-shrink: 0;
        }
        
        .game-area {
            flex: 1;
            min-height: 0; /* Allow flexbox to shrink */
        }
        
        /* Mobile landscape adjustments */
        @media (orientation: landscape) and (max-height: 500px) {
            .game-area {
                margin: 4px;
            }
            .header-content {
                gap: 8px;
            }
        }
        
        /* Responsive fossil sizing */
        #fossilCanvas {
            width: 100%;
            height: 100%;
            max-width: 100vw;
            max-height: calc(100vh - 80px);
            object-fit: contain;
        }

        #fossilCanvas {
            width: 100%;
            height: 100%;
            border-radius: 10px;
            cursor: crosshair;
            background: #D2B48C;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.3);
        }

        .tool-panel {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(0,0,0,0.7);
            border-radius: 10px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 50;
        }

        .tool-section {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: center;
        }

        .tool-label {
            font-size: 0.8em;
            color: #ffd700;
            font-weight: bold;
        }

        .brush-controls {
            display: flex;
            gap: 5px;
        }

        .brush-btn {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            border: 2px solid #ffd700;
            background: linear-gradient(145deg, #8B4513, #A0522D);
            color: white;
            cursor: pointer;
            font-size: 0.8em;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .brush-btn.active {
            background: linear-gradient(145deg, #ffd700, #ffed4e);
            color: #654321;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .brush-btn:hover {
            transform: scale(1.1);
        }

        .size-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100px;
            height: 5px;
            border-radius: 5px;
            background: #654321;
            outline: none;
        }

        .size-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: #ffd700;
            cursor: pointer;
        }

        .size-slider::-moz-range-thumb {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: #ffd700;
            cursor: pointer;
            border: none;
        }

        .progress-panel {
            position: absolute;
            bottom: 15px;
            left: 15px;
            background: rgba(0,0,0,0.7);
            border-radius: 10px;
            padding: 15px;
            min-width: 200px;
            z-index: 50;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #654321;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ffd700, #ffed4e);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 0.9em;
            text-align: center;
            color: #ffd700;
        }

        .fossil-info {
            margin-top: 10px;
            font-size: 0.8em;
            color: #ccc;
            text-align: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .fossil-info.visible {
            opacity: 1;
        }

        /* Particle effects */
        .sand-particle {
            position: absolute;
            background: #C19A6B; /* Slightly darker sand color for better visibility */
            border-radius: 50%;
            pointer-events: none;
            z-index: 30;
            box-shadow: 0 1px 2px rgba(0,0,0,0.3); /* Add subtle shadow */
        }

        /* Discovery celebration overlay */
        .discovery-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 200;
            animation: fadeIn 0.5s ease-out;
        }

        .discovery-overlay.show {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .discovery-panel {
            background: linear-gradient(145deg, #1a5c3a, #0d4f3c);
            border: 4px solid #ffd700;
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            max-width: 80%;
            min-width: 300px;
            box-shadow: 
                0 0 0 3px rgba(255, 215, 0, 0.3),
                0 10px 40px rgba(0, 0, 0, 0.8),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            animation: celebrationBounce 0.6s ease-out;
        }

        @keyframes celebrationBounce {
            0% { 
                transform: scale(0.3) rotate(-5deg);
                opacity: 0;
            }
            50% { 
                transform: scale(1.05) rotate(2deg);
            }
            100% { 
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }

        .discovery-title {
            font-size: 2em;
            color: #ffd700;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .discovery-fossil {
            font-size: 4em;
            margin: 20px 0;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.3);
        }

        .discovery-name {
            font-size: 1.5em;
            color: #4CAF50;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .discovery-description {
            color: #ccc;
            margin-bottom: 25px;
            line-height: 1.4;
        }

        .discovery-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .discovery-btn {
            background: linear-gradient(145deg, #4CAF50, #388E3C);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .discovery-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
        }

        .discovery-btn.secondary {
            background: linear-gradient(145deg, #8B4513, #A0522D);
        }

        .discovery-btn.secondary:hover {
            box-shadow: 0 4px 12px rgba(139, 69, 19, 0.4);
        }

        /* Dig Collapse Overlay */
        .collapse-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(139, 69, 19, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 300;
            animation: fadeIn 0.5s ease-out;
        }

        .collapse-overlay.show {
            display: flex;
        }

        .collapse-panel {
            background: linear-gradient(145deg, #654321, #8B4513);
            border: 4px solid #D2691E;
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            max-width: 80%;
            min-width: 300px;
            box-shadow: 
                0 0 0 3px rgba(210, 105, 30, 0.3),
                0 10px 40px rgba(0, 0, 0, 0.8),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            animation: emergencyShake 0.6s ease-out;
        }

        @keyframes emergencyShake {
            0% { 
                transform: scale(0.3) rotate(-5deg);
                opacity: 0;
            }
            20% { 
                transform: scale(1.05) rotate(2deg);
            }
            40% { 
                transform: scale(0.95) rotate(-1deg);
            }
            60% { 
                transform: scale(1.02) rotate(1deg);
            }
            80% { 
                transform: scale(0.98) rotate(-0.5deg);
            }
            100% { 
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }

        .collapse-title {
            font-size: 1.8em;
            color: #ff6b35;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .collapse-icon {
            font-size: 3em;
            margin: 15px 0;
            animation: bounce 1s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .collapse-message {
            color: #ffd700;
            margin-bottom: 25px;
            line-height: 1.4;
            font-size: 1.1em;
        }

        .collapse-submessage {
            color: #ccc;
            margin-bottom: 25px;
            line-height: 1.4;
            font-size: 0.9em;
        }

        .collapse-btn {
            background: linear-gradient(145deg, #D2691E, #B8860B);
            border: none;
            color: white;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            transition: all 0.3s ease;
            min-width: 150px;
        }

        .collapse-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(210, 105, 30, 0.4);
        }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .tool-panel {
                top: 10px;
                right: 10px;
                padding: 10px;
            }

            .brush-btn {
                width: 30px;
                height: 30px;
                font-size: 0.7em;
            }

            .size-slider {
                width: 80px;
            }

            .progress-panel {
                bottom: 10px;
                left: 10px;
                min-width: 150px;
                padding: 10px;
            }

            #fossilCanvas {
                cursor: pointer;
            }
        }

        /* Touch optimization */
        .brush-btn, .header-btn {
            min-height: 44px;
            -webkit-tap-highlight-color: rgba(255, 215, 0, 0.3);
        }

        .brush-btn:disabled, .header-btn:disabled {
            cursor: not-allowed;
            background: #666 !important;
            color: #999 !important;
            border-color: #555 !important;
            transform: none !important;
            box-shadow: none !important;
        }

        @media (max-width: 480px) {
            .brush-btn, .header-btn {
                min-height: 48px;
            }
            
            .collapse-panel {
                padding: 20px;
                min-width: 250px;
            }
            
            .collapse-title {
                font-size: 1.5em;
            }
            
            .collapse-icon {
                font-size: 2.5em;
            }
        }
    </style>
</head>
<body>
    <header class="game-header">
        <div class="header-content">
            <div class="game-title">ü¶¥ Fossil Hunter ‚õèÔ∏è</div>
            <div class="header-controls">
                <button class="header-btn" onclick="newFossil()">New Dig</button>
                <button class="header-btn" onclick="resetProgress()">Reset</button>
            </div>
        </div>
    </header>

    <main class="game-area">
        <canvas id="fossilCanvas"></canvas>
        
        <!-- Discovery Celebration Overlay -->
        <div class="discovery-overlay" id="discovery-overlay">
            <div class="discovery-panel">
                <div class="discovery-title">üéâ Discovery Complete! üéâ</div>
                <div class="discovery-fossil" id="discovery-emoji"></div>
                <div class="discovery-name" id="discovery-name"></div>
                <div class="discovery-description" id="discovery-description"></div>
                <div class="discovery-buttons">
                    <button class="discovery-btn" onclick="continueDigging()">New Dig Site</button>
                    <button class="discovery-btn secondary" onclick="admireDiscovery()">Admire Find</button>
                </div>
            </div>
        </div>
        
        <!-- Dig Site Collapse Overlay -->
        <div class="collapse-overlay" id="collapse-overlay">
            <div class="collapse-panel">
                <div class="collapse-title">‚ö†Ô∏è Dig Site Collapse! ‚ö†Ô∏è</div>
                <div class="collapse-icon">üèóÔ∏è</div>
                <div class="collapse-message">
                    The excavation site has collapsed due to shifting ground conditions!
                </div>
                <div class="collapse-submessage">
                    Environmental changes have destabilized the dig area. We need to establish a new site with proper measurements.
                </div>
                <button class="collapse-btn" onclick="restartDigSite()">üîß Establish New Site</button>
            </div>
        </div>
        
        <div class="tool-panel">
            <div class="tool-section">
                <div class="tool-label">Brush Type</div>
                <div class="brush-controls">
                    <button class="brush-btn active" data-brush="soft" title="Soft Brush">üñåÔ∏è</button>
                    <button class="brush-btn" data-brush="medium" title="Medium Brush">üñçÔ∏è</button>
                    <button class="brush-btn" data-brush="fine" title="Fine Brush">‚úèÔ∏è</button>
                </div>
            </div>
            
            <div class="tool-section">
                <div class="tool-label">Brush Size</div>
                <input type="range" class="size-slider" id="brushSize" min="5" max="50" value="20">
            </div>
        </div>

        <div class="progress-panel">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">0% Revealed</div>
            <div class="fossil-info" id="fossilInfo">
                Carefully brush away the sand to reveal the ancient fossil beneath...
            </div>
        </div>
    </main>

    <script>
        // Game state
        let canvas, ctx;
        let currentFossil = 'trex';
        let fossilsDiscovered = 0;
        let revealProgress = 0;
        let isDrawing = false;
        let currentBrushType = 'soft';
        let brushSize = 20;

        // Canvas layers
        let fossilCanvas, sandCanvas;
        let fossilCtx, sandCtx;

        // Touch handling
        let lastTouchX = 0;
        let lastTouchY = 0;
        
        // Performance throttling
        let lastBrushTime = 0;
        let lastProgressUpdate = 0;
        const BRUSH_THROTTLE_MS = 16; // ~60fps limit
        const PROGRESS_UPDATE_MS = 100; // Update progress less frequently

        // Resize handling
        let resizeTimeout;
        let gameActive = true;
        let lastWindowWidth = window.innerWidth;
        let lastWindowHeight = window.innerHeight;

        // Funny dig site failure reasons
        const digFailureReasons = [
            {
                title: "‚ö†Ô∏è Underground Gopher Convention! ‚ö†Ô∏è",
                message: "A massive gopher gathering has destabilized the dig site!",
                submessage: "The local gopher union has called an emergency meeting directly beneath your excavation. We must respect their territorial rights.",
                icon: "üêπ"
            },
            {
                title: "‚ö†Ô∏è Dinosaur Sneeze Detected! ‚ö†Ô∏è", 
                message: "Seismic readings indicate a prehistoric sneeze!",
                submessage: "Our equipment has detected what can only be described as a T-Rex sized achoo from deep underground. Safety protocols require immediate evacuation.",
                icon: "ü§ß"
            },
            {
                title: "‚ö†Ô∏è Time Portal Malfunction! ‚ö†Ô∏è",
                message: "Temporal interference has compromised the dig site!",
                submessage: "A small time vortex has opened up, causing the soil layers to shift between geological periods. We need to recalibrate our chronometers.",
                icon: "üåÄ"
            },
            {
                title: "‚ö†Ô∏è Underground Wi-Fi Outage! ‚ö†Ô∏è",
                message: "The mole internet has gone down!",
                submessage: "Critical infrastructure failure in the subterranean communication network. Even our most sophisticated digging equipment requires a stable connection.",
                icon: "üì∂"
            },
            {
                title: "‚ö†Ô∏è Fossil Union Strike! ‚ö†Ô∏è",
                message: "The ancient specimens have organized!",
                submessage: "Local fossils are demanding better working conditions and dental coverage. Negotiations are ongoing with their prehistoric representatives.",
                icon: "ü™ß"
            },
            {
                title: "‚ö†Ô∏è Unexpected Tea Break! ‚ö†Ô∏è",
                message: "The dig site has declared mandatory teatime!",
                submessage: "British archaeological protocols require a proper tea break every 4 hours. The soil itself has become too civilized to continue without refreshments.",
                icon: "‚òï"
            },
            {
                title: "‚ö†Ô∏è Meteor Shower Alert! ‚ö†Ô∏è",
                message: "Space rocks are incoming!",
                submessage: "A small meteor shower is predicted to impact the area. While exciting for future paleontologists, it's rather inconvenient for current ones.",
                icon: "‚òÑÔ∏è"
            },
            {
                title: "‚ö†Ô∏è Dragon Territorial Dispute! ‚ö†Ô∏è",
                message: "An ancient dragon has filed a property claim!",
                submessage: "Legal documents from the Cretaceous period have surfaced, indicating this land belongs to a very old and very grumpy dragon. Best not to argue.",
                icon: "üê≤"
            },
            {
                title: "‚ö†Ô∏è Caffeine Shortage Crisis! ‚ö†Ô∏è",
                message: "The archaeological team has run out of coffee!",
                submessage: "No serious excavation can proceed without adequate caffeine levels. The dig site has been declared unsafe until a coffee supply run is completed.",
                icon: "‚òï"
            },
            {
                title: "‚ö†Ô∏è Spontaneous Quicksand! ‚ö†Ô∏è",
                message: "The ground has become unexpectedly wiggly!",
                submessage: "Geological surveys indicate the soil has developed a mind of its own and is now doing the archaeological equivalent of the cha-cha. Safety first!",
                icon: "üåä"
            }
        ];

        // Fossil definitions with emoji representations
        const fossils = {
            // Classic Dinosaurs
            trex: {
                name: 'T-Rex',
                description: 'The mighty Tyrannosaurus Rex, king of the dinosaurs',
                emoji: 'ü¶ñ'
            },
            triceratops: {
                name: 'Triceratops',
                description: 'A large herbivorous dinosaur with three horns and a bony frill',
                emoji: 'ü¶ï'
            },
            stegosaurus: {
                name: 'Stegosaurus',
                description: 'An armored dinosaur with distinctive back plates and tail spikes',
                emoji: 'ü¶¥'
            },
            velociraptor: {
                name: 'Velociraptor',
                description: 'A swift and intelligent pack hunter from the Cretaceous period',
                emoji: 'üêâ'
            },
            pterodactyl: {
                name: 'Pterodactyl',
                description: 'A flying reptile that soared through prehistoric skies',
                emoji: 'ü¶Ö'
            },

            // Ice Age Mammals
            mammoth: {
                name: 'Woolly Mammoth',
                description: 'A massive elephant ancestor covered in thick fur from the ice age',
                emoji: 'ü¶£'
            },
            sabertooth: {
                name: 'Saber-Tooth Cat',
                description: 'A fearsome predator with enormous canine teeth',
                emoji: 'üêÖ'
            },
            cavebear: {
                name: 'Cave Bear',
                description: 'A giant bear that lived alongside early humans',
                emoji: 'üêª'
            },
            giantsloth: {
                name: 'Giant Ground Sloth',
                description: 'A car-sized sloth that walked upright in ancient America',
                emoji: 'ü¶•'
            },

            // Marine Fossils
            megalodon: {
                name: 'Megalodon',
                description: 'A prehistoric shark the size of a school bus with teeth like daggers',
                emoji: 'ü¶à'
            },
            ammonite: {
                name: 'Ammonite',
                description: 'A spiral-shelled marine mollusk from ancient seas',
                emoji: 'üêö'
            },
            trilobite: {
                name: 'Trilobite',
                description: 'An ancient marine arthropod with compound eyes',
                emoji: 'ü¶ê'
            },
            plesiosaur: {
                name: 'Plesiosaur',
                description: 'A long-necked marine reptile, the Loch Ness Monster of prehistory',
                emoji: 'üêç'
            },
            nautilus: {
                name: 'Ancient Nautilus',
                description: 'A cephalopod with a beautiful chambered shell',
                emoji: 'ü¶ë'
            },

            // Early Life & Plants
            fern: {
                name: 'Prehistoric Fern',
                description: 'An ancient plant that dominated primordial forests',
                emoji: 'üåø'
            },
            tree: {
                name: 'Petrified Wood',
                description: 'A tree turned to stone over millions of years',
                emoji: 'üå≥'
            },
            flower: {
                name: 'Ancient Flower',
                description: 'One of the first flowering plants to evolve on Earth',
                emoji: 'üå∏'
            },
            bacteria: {
                name: 'Stromatolite',
                description: 'Evidence of some of Earth\'s earliest life forms',
                emoji: 'üß¨'
            },

            // Human Ancestors & Skulls
            humanskull: {
                name: 'Early Human Skull',
                description: 'The remains of one of our ancient ancestors',
                emoji: 'üíÄ'
            },
            neanderthal: {
                name: 'Neanderthal',
                description: 'Our closest extinct human relative from ice age Europe',
                emoji: 'üßü'
            },
            australopithecus: {
                name: 'Australopithecus',
                description: 'An early hominin that walked upright 3 million years ago',
                emoji: 'üêí'
            },

            // Mythical/Cryptid Finds
            dragon: {
                name: 'Dragon Skeleton',
                description: 'Wait... dragons were real?! This changes everything!',
                emoji: 'üê≤'
            },
            unicorn: {
                name: 'Unicorn Horn',
                description: 'A mystical spiral horn from a legendary creature',
                emoji: 'ü¶Ñ'
            },
            phoenix: {
                name: 'Phoenix Feather',
                description: 'A preserved feather that still glows with inner fire',
                emoji: 'üî•'
            },

            // Weird & Wonderful
            dodo: {
                name: 'Dodo Bird',
                description: 'The famously extinct flightless bird from Mauritius',
                emoji: 'ÔøΩ'
            },
            crab: {
                name: 'Giant Prehistoric Crab',
                description: 'A massive crustacean from ancient shallow seas',
                emoji: 'ü¶Ä'
            },
            spider: {
                name: 'Ancient Arachnid',
                description: 'A prehistoric spider preserved in amber',
                emoji: 'üï∑Ô∏è'
            },
            butterfly: {
                name: 'Prehistoric Butterfly',
                description: 'Delicate wings preserved against all odds',
                emoji: 'ü¶ã'
            },
            beetle: {
                name: 'Giant Beetle',
                description: 'A massive insect from when bugs ruled the world',
                emoji: 'ü™≤'
            },
            
            // More Marine Life
            octopus: {
                name: 'Ancient Octopus',
                description: 'A prehistoric cephalopod with incredible intelligence',
                emoji: 'üêô'
            },
            whale: {
                name: 'Prehistoric Whale',
                description: 'An ancient whale ancestor that walked on land',
                emoji: 'üêã'
            },
            turtle: {
                name: 'Giant Sea Turtle',
                description: 'A massive turtle that roamed ancient oceans',
                emoji: 'üê¢'
            },

            // Mysterious Finds
            alien: {
                name: 'Unidentified Specimen',
                description: 'This doesn\'t match any known species... fascinating!',
                emoji: 'üëΩ'
            },
            crystal: {
                name: 'Fossil Crystal',
                description: 'A mysterious crystalline formation of unknown origin',
                emoji: 'üíé'
            },
            egg: {
                name: 'Mystery Egg',
                description: 'A perfectly preserved egg from an unknown creature',
                emoji: 'ü•ö'
            }
        };

        // Initialize the game
        function initGame() {
            canvas = document.getElementById('fossilCanvas');
            ctx = canvas.getContext('2d');
            
            // Initialize window size tracking
            lastWindowWidth = window.innerWidth;
            lastWindowHeight = window.innerHeight;
            
            // Set up canvas size
            resizeCanvas();
            
            // Set up event listeners
            setupEventListeners();
            
            // Initialize first fossil
            loadFossil(currentFossil);
            
            // Update UI
            updateUI();
        }



        function resizeCanvas() {
            // Force a complete canvas refresh by resetting its CSS dimensions
            canvas.style.width = '';
            canvas.style.height = '';
            canvas.style.display = 'none';
            canvas.offsetHeight; // Force reflow
            canvas.style.display = 'block';
            
            // Wait for the browser to calculate new dimensions
            const rect = canvas.getBoundingClientRect();
            let width = rect.width;
            let height = rect.height;
            
            // Fallback: calculate dimensions from parent container if canvas rect is invalid
            if (width === 0 || height === 0) {
                const gameArea = document.querySelector('.game-area');
                const gameRect = gameArea.getBoundingClientRect();
                width = gameRect.width - 16; // Account for padding
                height = gameRect.height - 16;
            }
            
            // Ensure we have valid dimensions
            if (width <= 0) width = window.innerWidth - 32;
            if (height <= 0) height = window.innerHeight - 100;
            
            // Main canvas
            canvas.width = width * window.devicePixelRatio;
            canvas.height = height * window.devicePixelRatio;
            ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
            canvas.style.width = width + 'px';
            canvas.style.height = height + 'px';
            
            // Create off-screen canvases for layers
            fossilCanvas = document.createElement('canvas');
            sandCanvas = document.createElement('canvas');
            
            fossilCanvas.width = width;
            fossilCanvas.height = height;
            sandCanvas.width = width;
            sandCanvas.height = height;
            
            fossilCtx = fossilCanvas.getContext('2d', { willReadFrequently: true });
            sandCtx = sandCanvas.getContext('2d', { willReadFrequently: true });
            
            // Always recreate layers after resize to ensure proper dimensions
            if (fossilCtx && sandCtx) {
                // Reset progress since we're creating new layers
                revealProgress = 0;
                
                // Create fresh layers with new dimensions
                createFossilLayer();
                createSandLayer();
                
                // Reset progress UI
                document.getElementById('progressFill').style.width = '0%';
                document.getElementById('progressText').textContent = '0% Revealed';
                document.getElementById('fossilInfo').classList.remove('visible');
                document.getElementById('fossilInfo').style.color = '#ccc';
                document.getElementById('fossilInfo').textContent = 'Carefully brush away the sand to reveal the ancient fossil beneath...';
            }
        }

        function handleResize() {
            // Check if this is a significant resize (not just minor browser chrome changes)
            const widthDiff = Math.abs(window.innerWidth - lastWindowWidth);
            const heightDiff = Math.abs(window.innerHeight - lastWindowHeight);
            const significantChange = widthDiff > 50 || heightDiff > 50;
            
            // Only trigger collapse modal for significant changes and if game is active
            if (significantChange && gameActive && revealProgress > 0 && revealProgress < 100) {
                // Pause the game and show collapse modal
                pauseGame();
                showCollapseModal();
            } else if (significantChange) {
                // Just resize without modal if no active digging
                resizeCanvas();
            }
            
            // Update stored dimensions
            lastWindowWidth = window.innerWidth;
            lastWindowHeight = window.innerHeight;
        }

        function debouncedResize() {
            // Clear existing timeout
            clearTimeout(resizeTimeout);
            
            // Set new timeout
            resizeTimeout = setTimeout(handleResize, 200);
        }

        function setupEventListeners() {
            // Mouse events
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseleave', stopDrawing);
            
            // Touch events
            canvas.addEventListener('touchstart', handleTouchStart);
            canvas.addEventListener('touchmove', handleTouchMove);
            canvas.addEventListener('touchend', stopDrawing);
            
            // Prevent scrolling on touch
            canvas.addEventListener('touchstart', e => e.preventDefault());
            canvas.addEventListener('touchmove', e => e.preventDefault());
            
            // Resize and orientation events
            window.addEventListener('resize', debouncedResize);
            window.addEventListener('orientationchange', () => {
                // Give device time to complete rotation
                setTimeout(debouncedResize, 300);
            });
            
            // Brush controls
            document.querySelectorAll('.brush-btn').forEach(btn => {
                btn.addEventListener('click', () => setBrushType(btn.dataset.brush));
            });
            
            document.getElementById('brushSize').addEventListener('input', (e) => {
                brushSize = parseInt(e.target.value);
            });
        }

        function startDrawing(e) {
            if (!gameActive) return;
            isDrawing = true;
            draw(e);
        }

        function draw(e) {
            if (!isDrawing || !gameActive) return;
            
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            brushAway(x, y);
        }

        function stopDrawing() {
            isDrawing = false;
            // Ensure final composite after stroke ends (in case throttled operations pending)
            compositeLayers();
        }

        function handleTouchStart(e) {
            if (!gameActive) return;
            const touch = e.touches[0];
            const rect = canvas.getBoundingClientRect();
            lastTouchX = touch.clientX - rect.left;
            lastTouchY = touch.clientY - rect.top;
            isDrawing = true;
            brushAway(lastTouchX, lastTouchY);
        }

        function handleTouchMove(e) {
            if (!isDrawing || !gameActive) return;
            
            const touch = e.touches[0];
            const rect = canvas.getBoundingClientRect();
            const x = touch.clientX - rect.left;
            const y = touch.clientY - rect.top;
            
            // Interpolate between last position and current for smooth strokes
            const steps = Math.max(Math.abs(x - lastTouchX), Math.abs(y - lastTouchY));
            for (let i = 0; i <= steps; i++) {
                const interpX = lastTouchX + (x - lastTouchX) * (i / steps);
                const interpY = lastTouchY + (y - lastTouchY) * (i / steps);
                brushAway(interpX, interpY);
            }
            
            lastTouchX = x;
            lastTouchY = y;
        }

        function brushAway(x, y) {
            // Throttle brush operations for performance
            const now = Date.now();
            if (now - lastBrushTime < BRUSH_THROTTLE_MS) {
                return;
            }
            lastBrushTime = now;
            
            // Clear sand in circular area
            const radius = brushSize;
            
            // Different brush effects based on type
            let intensity = 1;
            let falloff = 1;
            
            switch (currentBrushType) {
                case 'soft':
                    intensity = 0.3;
                    falloff = 2;
                    break;
                case 'medium':
                    intensity = 0.6;
                    falloff = 1.5;
                    break;
                case 'fine':
                    intensity = 0.9;
                    falloff = 1;
                    break;
            }
            
            // Apply brush effect to sand layer only
            sandCtx.globalCompositeOperation = 'destination-out';
            
            // Create gradient for soft brush effect
            const gradient = sandCtx.createRadialGradient(x, y, 0, x, y, radius);
            gradient.addColorStop(0, `rgba(0,0,0,${intensity})`);
            gradient.addColorStop(0.7, `rgba(0,0,0,${intensity * 0.5})`);
            gradient.addColorStop(1, 'rgba(0,0,0,0)');
            
            sandCtx.fillStyle = gradient;
            sandCtx.beginPath();
            sandCtx.arc(x, y, radius, 0, Math.PI * 2);
            sandCtx.fill();
            
            sandCtx.globalCompositeOperation = 'source-over';
            
            // Re-composite layers to show updated result
            compositeLayers();
            
            // Create sand particles (minimal for performance)
            if (Math.random() < 0.3) { // Only 30% chance to create particles
                createSandParticles(x, y, Math.min(2, Math.round(radius * 0.05)));
            }
            
            // Update progress (throttled)
            const currentTime = Date.now();
            if (currentTime - lastProgressUpdate > PROGRESS_UPDATE_MS) {
                lastProgressUpdate = currentTime;
                updateProgress();
            }
        }

        function createSandParticles(x, y, count) {
            // Ultra-light particle system for performance
            for (let i = 0; i < count; i++) {
                const particle = document.createElement('div');
                particle.className = 'sand-particle';
                
                const size = Math.random() * 3 + 1; // Smaller particles
                const offsetX = (Math.random() - 0.5) * 20; // Less spread
                const offsetY = (Math.random() - 0.5) * 20;
                const duration = 200; // Much shorter duration
                
                particle.style.cssText = `
                    width: ${size}px;
                    height: ${size}px;
                    left: ${x + offsetX}px;
                    top: ${y + offsetY}px;
                    opacity: 0.6;
                    transition: all ${duration}ms ease-out;
                `;
                
                document.body.appendChild(particle);
                
                // Immediate animation - no setTimeout delay
                requestAnimationFrame(() => {
                    particle.style.transform = `translate(${offsetX}px, ${offsetY + 10}px)`;
                    particle.style.opacity = '0';
                });
                
                // Quick cleanup
                setTimeout(() => {
                    if (particle.parentNode) {
                        particle.parentNode.removeChild(particle);
                    }
                }, duration + 50);
            }
        }



        function updateProgress() {
            // Don't update progress if fossil is already completed
            if (revealProgress >= 100) return;
            
            // Sample the sand layer to determine how much has been cleared
            const imageData = sandCtx.getImageData(0, 0, sandCanvas.width, sandCanvas.height);
            const data = imageData.data;
            
            let clearedPixels = 0;
            let totalPixels = 0;
            
            // Count transparent pixels in sand layer
            for (let i = 3; i < data.length; i += 4) {
                totalPixels++;
                if (data[i] < 128) { // Alpha channel - considering partially transparent as cleared
                    clearedPixels++;
                }
            }
            
            revealProgress = Math.min((clearedPixels / totalPixels) * 100, 100);
            
            // Update UI
            document.getElementById('progressFill').style.width = revealProgress + '%';
            document.getElementById('progressText').textContent = Math.floor(revealProgress) + '% Revealed';
            
            // Show fossil info as progress increases
            const fossilInfo = document.getElementById('fossilInfo');
            if (revealProgress > 15) {
                fossilInfo.textContent = `${fossils[currentFossil].description}`;
                fossilInfo.classList.add('visible');
            }
            
            // Complete fossil discovery
            if (revealProgress >= 80) {
                completeFossil();
            }
        }

        function completeFossil() {
            // Prevent multiple completions
            if (revealProgress >= 100) return;
            
            revealProgress = 100; // Mark as completed
            fossilsDiscovered++;
            updateUI();
            
            // Show completion message in progress panel
            const fossilInfo = document.getElementById('fossilInfo');
            fossilInfo.textContent = `üéâ Discovery Complete! You found a ${fossils[currentFossil].name}!`;
            fossilInfo.style.color = '#4CAF50';
            
            // Show beautiful discovery overlay after a short delay
            setTimeout(() => {
                showDiscoveryOverlay();
            }, 1000);
        }

        function showDiscoveryOverlay() {
            const fossil = fossils[currentFossil];
            
            // Populate overlay content
            document.getElementById('discovery-emoji').textContent = fossil.emoji;
            document.getElementById('discovery-name').textContent = `You discovered a ${fossil.name}!`;
            document.getElementById('discovery-description').textContent = fossil.description;
            
            // Show overlay
            document.getElementById('discovery-overlay').classList.add('show');
        }

        function continueDigging() {
            // Hide overlay
            document.getElementById('discovery-overlay').classList.remove('show');
            
            // Start new dig
            setTimeout(() => {
                newFossil();
            }, 300);
        }

        function admireDiscovery() {
            // Hide overlay to admire the fossil
            document.getElementById('discovery-overlay').classList.remove('show');
        }

        function pauseGame() {
            gameActive = false;
            isDrawing = false;
            
            // Disable canvas interactions
            canvas.style.pointerEvents = 'none';
            canvas.style.opacity = '0.7';
            
            // Disable UI controls
            document.querySelectorAll('.brush-btn, .size-slider, .header-btn').forEach(element => {
                element.disabled = true;
                element.style.opacity = '0.5';
            });
        }

        function resumeGame() {
            gameActive = true;
            
            // Re-enable canvas interactions
            canvas.style.pointerEvents = 'auto';
            canvas.style.opacity = '1';
            
            // Re-enable UI controls
            document.querySelectorAll('.brush-btn, .size-slider, .header-btn').forEach(element => {
                element.disabled = false;
                element.style.opacity = '1';
            });
        }

        function showCollapseModal() {
            // Select a random failure reason
            const reason = digFailureReasons[Math.floor(Math.random() * digFailureReasons.length)];
            // Update modal content with random reason
            document.querySelector('.collapse-title').textContent = reason.title;
            document.querySelector('.collapse-icon').textContent = reason.icon;
            document.querySelector('.collapse-message').textContent = reason.message;
            document.querySelector('.collapse-submessage').textContent = reason.submessage;
            
            document.getElementById('collapse-overlay').classList.add('show');
        }

        function hideCollapseModal() {
            document.getElementById('collapse-overlay').classList.remove('show');
        }

        function restartDigSite() {
            // Hide collapse modal
            hideCollapseModal();
            
            // Force a proper resize after modal closes
            setTimeout(() => {
                // Update stored dimensions to current viewport
                lastWindowWidth = window.innerWidth;
                lastWindowHeight = window.innerHeight;
                
                // Force layout reflow to ensure game area has correct dimensions
                const gameArea = document.querySelector('.game-area');
                gameArea.style.display = 'none';
                gameArea.offsetHeight; // Force reflow
                gameArea.style.display = 'flex';
                
                // Wait for reflow then resize canvas
                requestAnimationFrame(() => {
                    // Give an extra frame for the canvas element to resize
                    requestAnimationFrame(() => {
                        resizeCanvas(); // This now handles layer recreation automatically
                        
                        // Resume game (layers are already recreated by resizeCanvas)
                        resumeGame();
                    });
                });
            }, 100);
        }

        function setBrushType(type) {
            currentBrushType = type;
            document.querySelectorAll('.brush-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-brush="${type}"]`).classList.add('active');
        }

        function loadFossil(fossilType) {
            currentFossil = fossilType;
            revealProgress = 0;
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Create fossil background layer
            createFossilLayer();
            
            // Create sand layer on top
            createSandLayer();
            
            // Reset UI
            document.getElementById('fossilInfo').classList.remove('visible');
            document.getElementById('fossilInfo').style.color = '#ccc';
            document.getElementById('fossilInfo').textContent = 'Carefully brush away the sand to reveal the ancient fossil beneath...';
            
            updateUI();
        }

        function createFossilLayer() {
            const centerX = fossilCanvas.width / 2;
            const centerY = fossilCanvas.height / 2;
            
            // Clear fossil layer
            fossilCtx.clearRect(0, 0, fossilCanvas.width, fossilCanvas.height);
            
            // Draw background - same color as sand particles
            fossilCtx.fillStyle = '#C19A6B';
            fossilCtx.fillRect(0, 0, fossilCanvas.width, fossilCanvas.height);
            
            // Draw emoji fossil - very large to fill most of the space
            const emoji = fossils[currentFossil].emoji;
            const fontSize = Math.min(fossilCanvas.width, fossilCanvas.height) * 0.6;
            
            fossilCtx.font = `${fontSize}px serif`;
            fossilCtx.textAlign = 'center';
            fossilCtx.textBaseline = 'middle';
            fossilCtx.fillStyle = '#8B4513';
            
            // Add text shadow/outline effect for better visibility
            fossilCtx.strokeStyle = '#4a3621';
            fossilCtx.lineWidth = 3;
            fossilCtx.strokeText(emoji, centerX, centerY);
            fossilCtx.fillText(emoji, centerX, centerY);
        }

        function createSandLayer() {
            // Clear sand layer
            sandCtx.clearRect(0, 0, sandCanvas.width, sandCanvas.height);
            
            // Create sand texture
            sandCtx.fillStyle = '#D2B48C';
            sandCtx.fillRect(0, 0, sandCanvas.width, sandCanvas.height);
            
            // Add sand texture noise
            const imageData = sandCtx.getImageData(0, 0, sandCanvas.width, sandCanvas.height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                const noise = (Math.random() - 0.5) * 30;
                data[i] += noise;     // Red
                data[i + 1] += noise; // Green  
                data[i + 2] += noise; // Blue
            }
            
            sandCtx.putImageData(imageData, 0, 0);
            
            // Composite the layers on main canvas
            compositeLayers();
        }

        function compositeLayers() {
            // Clear main canvas
            ctx.clearRect(0, 0, canvas.width / window.devicePixelRatio, canvas.height / window.devicePixelRatio);
            
            // Draw fossil layer first (background)
            ctx.drawImage(fossilCanvas, 0, 0);
            
            // Draw sand layer on top
            ctx.drawImage(sandCanvas, 0, 0);
        }

        function newFossil() {
            if (!gameActive) return;
            
            const fossilTypes = Object.keys(fossils);
            const randomFossil = fossilTypes[Math.floor(Math.random() * fossilTypes.length)];
            loadFossil(randomFossil);
        }

        function resetProgress() {
            if (!gameActive) return;
            
            fossilsDiscovered = 0;
            loadFossil(currentFossil);
        }

        function updateUI() {
            // UI elements for fossil count and current fossil were removed for header compacting
            // Progress is now shown in the progress panel instead
        }

        // Initialize game when page loads
        window.addEventListener('load', initGame);
    </script>
</body>
<script src="parental.js"></script>
</html>