<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Letter Writer - Write letters the old-fashioned way</title>
    <link rel="icon" type="image/x-icon" href="assets/appicons/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="assets/appicons/apple-touch-icon.png">
    <link rel="manifest" href="manifest.webmanifest">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            --paper-cream: #f5f0e6;
            --paper-lines: #d4c9b8;
            --ink-blue: #1a365d;
            --ink-black: #2d2d2d;
            --margin-red: #c9a0a0;
        }

        body {
            font-family: 'Caveat', cursive;
            background: linear-gradient(135deg, #8b7355 0%, #6b5344 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 {
            color: #f5f0e6;
            font-family: 'Caveat', cursive;
            font-weight: 500;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            font-size: 2.2rem;
        }

        .toolbar {
            background: rgba(0,0,0,0.2);
            padding: 10px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
        }

        .toolbar label {
            color: #f5f0e6;
            font-size: 0.9rem;
        }

        .toolbar select, .toolbar button {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            font-family: inherit;
            cursor: pointer;
        }

        .toolbar select {
            background: #f5f0e6;
            color: #2d2d2d;
        }

        .toolbar button {
            background: #4a6741;
            color: white;
            transition: background 0.2s;
        }

        .toolbar button:hover {
            background: #5a7a51;
        }

        .paper {
            background: var(--paper-cream);
            width: 100%;
            max-width: 700px;
            min-height: 900px;
            padding: 60px 70px 60px 90px;
            box-shadow: 
                0 0 10px rgba(0,0,0,0.3),
                inset 0 0 50px rgba(0,0,0,0.05);
            position: relative;
            background-image: 
                linear-gradient(to bottom, var(--paper-cream) 60px, transparent 60px),
                linear-gradient(var(--paper-lines) 1px, transparent 1px);
            background-size: 100% 100%, 100% 28px;
            background-position: 0 0, 0 4px;
        }

        .paper::before {
            content: '';
            position: absolute;
            left: 70px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--margin-red);
            opacity: 0.5;
        }

        .letter-content {
            position: relative;
            line-height: 28px;
            font-size: 1.4rem;
            color: var(--ink-blue);
        }

        .sender-address {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 28px;
        }

        .sender-address textarea {
            text-align: left;
            width: auto;
            min-width: 200px;
        }

        .recipient-address {
            text-align: left;
            margin-bottom: 28px;
        }

        .date-line {
            text-align: right;
            margin-bottom: 28px;
        }

        .salutation {
            margin-bottom: 28px;
        }

        .body-text {
            margin-bottom: 28px;
            min-height: 168px;
        }

        .closing {
            margin-bottom: 56px;
        }

        .signature-area {
            margin-bottom: 0;
        }

        .editable {
            border: none;
            background: transparent;
            font-family: inherit;
            font-size: inherit;
            color: inherit;
            line-height: 28px;
            resize: none;
            overflow: hidden;
            width: 100%;
            outline: none;
        }

        .editable:focus {
            background: rgba(26, 54, 93, 0.05);
        }

        .editable.right {
            text-align: right;
        }

        .editable::placeholder {
            color: #a0a0a0;
            font-style: italic;
        }

        textarea.editable {
            display: block;
        }

        .signature-input {
            font-family: 'Caveat', cursive;
            font-size: 2.4rem;
            font-weight: 600;
            font-style: italic;
            line-height: 56px;
            height: 56px;
            border: none;
            background: transparent;
            color: inherit;
            outline: none;
            width: 100%;
            display: block;
        }

        .printed-name {
            font-variant: small-caps;
        }

        .help-text {
            color: #f5f0e6;
            font-size: 0.85rem;
            max-width: 700px;
            text-align: center;
            margin-top: 20px;
            opacity: 0.8;
            line-height: 1.5;
        }

        /* Ink color options */
        .ink-blue { color: #1a365d; }
        .ink-black { color: #2d2d2d; }
        .ink-sepia { color: #5c4033; }

        /* Paper style options */
        .paper.plain {
            background-image: none;
        }

        .paper.plain::before {
            display: none;
        }

        .paper.aged {
            background-color: #e8dcc8;
            background-image: 
                linear-gradient(to bottom, #e8dcc8 60px, transparent 60px),
                linear-gradient(#d4c4a8 1px, transparent 1px),
                url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%' height='100%' filter='url(%23noise)' opacity='0.08'/%3E%3C/svg%3E");
            background-size: 100% 100%, 100% 28px, cover;
            background-position: 0 0, 0 4px, 0 0;
        }

        @media print {
            body {
                background: none;
                padding: 0;
            }
            h1, .toolbar, .help-text {
                display: none;
            }
            .paper {
                box-shadow: none;
                max-width: none;
                padding: 40px 60px 40px 80px;
            }
            .editable:focus {
                background: transparent;
            }
        }

        @media (max-width: 600px) {
            body {
                padding: 10px;
                overflow: hidden;
            }

            .paper-viewport {
                position: relative;
                width: 100%;
                height: calc(100vh - 200px);
                overflow: hidden;
                border-radius: 4px;
                touch-action: none;
            }

            .paper {
                position: absolute;
                transform-origin: 0 0;
                padding: 40px 50px 40px 70px;
                min-height: 800px;
                width: 600px;
            }
            .paper::before {
                left: 55px;
            }
            h1 {
                font-size: 1.4rem;
            }
            .toolbar {
                padding: 8px 12px;
                gap: 8px;
            }
            .toolbar button, .toolbar select {
                padding: 6px 10px;
                font-size: 0.85rem;
            }
            .help-text {
                display: none;
            }

            /* Touch targets for mobile */
            .editable, .signature-input {
                pointer-events: none;
            }
            .touch-target {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                cursor: pointer;
            }
            .sender-address,
            .recipient-address,
            .date-line,
            .salutation,
            .body-text,
            .closing,
            .signature-area {
                position: relative;
                min-height: 28px;
            }
        }

        /* Modal editor for mobile */
        .modal-editor {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            padding: 20px;
            flex-direction: column;
        }
        .modal-editor.active {
            display: flex;
        }
        .modal-editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .modal-editor-title {
            color: #f5f0e6;
            font-size: 1.3rem;
            font-family: 'Caveat', cursive;
        }
        .modal-editor-close {
            background: #4a6741;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            font-size: 1rem;
            cursor: pointer;
        }
        .modal-editor-input {
            flex: 1;
            background: var(--paper-cream);
            border: none;
            border-radius: 8px;
            padding: 20px;
            font-family: 'Caveat', cursive;
            font-size: 1.5rem;
            line-height: 1.6;
            color: var(--ink-blue);
            resize: none;
            outline: none;
        }
        .modal-editor-input::placeholder {
            color: #a0a0a0;
        }

        /* Zoom controls for mobile */
        .zoom-controls {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100;
            flex-direction: column;
            gap: 8px;
        }
        @media (max-width: 600px) {
            .zoom-controls {
                display: flex;
            }
        }
        .zoom-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: none;
            background: rgba(0,0,0,0.6);
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .zoom-btn:active {
            background: rgba(0,0,0,0.8);
        }
    </style>
</head>
<body>
    <h1>‚úâÔ∏è Letter Writer</h1>
    
    <div class="toolbar">
        <label>
            Paper:
            <select id="paperStyle">
                <option value="lined">Lined</option>
                <option value="plain">Plain</option>
                <option value="aged">Aged</option>
            </select>
        </label>
        <label>
            Ink:
            <select id="inkColor">
                <option value="ink-blue">Blue</option>
                <option value="ink-black">Black</option>
                <option value="ink-sepia">Sepia</option>
            </select>
        </label>
        <button onclick="printLetter()">üñ®Ô∏è Print</button>
        <button onclick="clearLetter()">üóëÔ∏è Clear</button>
        <button onclick="saveLetter()">üíæ Save</button>
    </div>

    <div class="paper" id="paper">
        <div class="letter-content" id="letterContent">
            <!-- Sender's Address (top right) -->
            <div class="sender-address">
                <textarea class="editable" id="senderAddress" rows="4" placeholder="Your Name
Your Street Address
Your City, County
Your Postcode"></textarea>
            </div>

            <!-- Recipient's Address (left) -->
            <div class="recipient-address">
                <textarea class="editable" id="recipientAddress" rows="4" placeholder="Recipient's Name
Their Street Address
Their City, County
Their Postcode"></textarea>
            </div>

            <!-- Date (right) -->
            <div class="date-line">
                <input type="text" class="editable right" id="dateLine" placeholder="9th December 2025">
            </div>

            <!-- Salutation -->
            <div class="salutation">
                <input type="text" class="editable" id="salutation" placeholder="Dear Friend,">
            </div>

            <!-- Body -->
            <div class="body-text">
                <textarea class="editable" id="bodyText" rows="6" placeholder="Write your letter here...

Take your time. Letters are meant to be thoughtful."></textarea>
            </div>

            <!-- Closing -->
            <div class="closing">
                <input type="text" class="editable" id="closing" placeholder="Yours sincerely,">
            </div>

            <!-- Signature Area -->
            <div class="signature-area">
                <input type="text" class="signature-input" id="signature" placeholder="Your signature">
                <input type="text" class="editable printed-name" id="printedName" placeholder="Your Printed Name">
            </div>
        </div>
    </div>

    <p class="help-text">
        Write your letter above. Click in each area to edit. Use Print to create a physical letter, 
        or Save to keep a copy in your browser. Letters were once the threads that connected hearts across distances.
    </p>

    <!-- Modal editor for mobile -->
    <div class="modal-editor" id="modalEditor">
        <div class="modal-editor-header">
            <span class="modal-editor-title" id="modalTitle">Edit</span>
            <button class="modal-editor-close" onclick="closeModal()">‚úì Done</button>
        </div>
        <textarea class="modal-editor-input" id="modalInput" placeholder="Type here..."></textarea>
    </div>

    <!-- Zoom controls for mobile -->
    <div class="zoom-controls">
        <button class="zoom-btn" onclick="zoomIn()">+</button>
        <button class="zoom-btn" onclick="zoomOut()">‚àí</button>
        <button class="zoom-btn" onclick="resetZoom()">‚ü≤</button>
    </div>

    <script>
        const STORAGE_KEY = 'idlegames-letter';

        // Auto-resize textareas
        function autoResize(el) {
            el.style.height = 'auto';
            el.style.height = el.scrollHeight + 'px';
        }

        document.querySelectorAll('textarea.editable').forEach(textarea => {
            textarea.addEventListener('input', () => autoResize(textarea));
            autoResize(textarea);
        });

        // Set today's date as default
        function setDefaultDate() {
            const dateInput = document.getElementById('dateLine');
            if (!dateInput.value) {
                const options = { day: 'numeric', month: 'long', year: 'numeric' };
                const today = new Date().toLocaleDateString('en-GB', options);
                // Convert "9 December 2025" to "9th December 2025"
                const parts = today.split(' ');
                const day = parseInt(parts[0]);
                const suffix = getOrdinalSuffix(day);
                dateInput.value = day + suffix + ' ' + parts.slice(1).join(' ');
            }
        }

        function getOrdinalSuffix(day) {
            if (day > 3 && day < 21) return 'th';
            switch (day % 10) {
                case 1: return 'st';
                case 2: return 'nd';
                case 3: return 'rd';
                default: return 'th';
            }
        }

        // Paper style
        document.getElementById('paperStyle').addEventListener('change', (e) => {
            const paper = document.getElementById('paper');
            paper.classList.remove('plain', 'aged');
            if (e.target.value !== 'lined') {
                paper.classList.add(e.target.value);
            }
            saveSettings();
        });

        // Ink color
        document.getElementById('inkColor').addEventListener('change', (e) => {
            const content = document.getElementById('letterContent');
            content.classList.remove('ink-blue', 'ink-black', 'ink-sepia');
            content.classList.add(e.target.value);
            saveSettings();
        });

        // Print
        function printLetter() {
            window.print();
        }

        // Clear
        function clearLetter() {
            if (confirm('Clear all letter content? This cannot be undone.')) {
                document.getElementById('senderAddress').value = '';
                document.getElementById('recipientAddress').value = '';
                document.getElementById('dateLine').value = '';
                document.getElementById('salutation').value = '';
                document.getElementById('bodyText').value = '';
                document.getElementById('closing').value = '';
                document.getElementById('signature').value = '';
                document.getElementById('printedName').value = '';
                
                document.querySelectorAll('textarea.editable').forEach(autoResize);
                setDefaultDate();
                saveLetter();
            }
        }

        // Save letter to localStorage
        function saveLetter() {
            const data = {
                senderAddress: document.getElementById('senderAddress').value,
                recipientAddress: document.getElementById('recipientAddress').value,
                dateLine: document.getElementById('dateLine').value,
                salutation: document.getElementById('salutation').value,
                bodyText: document.getElementById('bodyText').value,
                closing: document.getElementById('closing').value,
                signature: document.getElementById('signature').value,
                printedName: document.getElementById('printedName').value,
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        // Save settings
        function saveSettings() {
            const settings = {
                paperStyle: document.getElementById('paperStyle').value,
                inkColor: document.getElementById('inkColor').value,
            };
            localStorage.setItem(STORAGE_KEY + '-settings', JSON.stringify(settings));
        }

        // Load letter from localStorage
        function loadLetter() {
            try {
                const data = JSON.parse(localStorage.getItem(STORAGE_KEY));
                if (data) {
                    document.getElementById('senderAddress').value = data.senderAddress || '';
                    document.getElementById('recipientAddress').value = data.recipientAddress || '';
                    document.getElementById('dateLine').value = data.dateLine || '';
                    document.getElementById('salutation').value = data.salutation || '';
                    document.getElementById('bodyText').value = data.bodyText || '';
                    document.getElementById('closing').value = data.closing || '';
                    document.getElementById('signature').value = data.signature || '';
                    document.getElementById('printedName').value = data.printedName || '';
                    
                    document.querySelectorAll('textarea.editable').forEach(autoResize);
                }
            } catch (e) {}

            // Load settings
            try {
                const settings = JSON.parse(localStorage.getItem(STORAGE_KEY + '-settings'));
                if (settings) {
                    if (settings.paperStyle) {
                        document.getElementById('paperStyle').value = settings.paperStyle;
                        const paper = document.getElementById('paper');
                        paper.classList.remove('plain', 'aged');
                        if (settings.paperStyle !== 'lined') {
                            paper.classList.add(settings.paperStyle);
                        }
                    }
                    if (settings.inkColor) {
                        document.getElementById('inkColor').value = settings.inkColor;
                        const content = document.getElementById('letterContent');
                        content.classList.remove('ink-blue', 'ink-black', 'ink-sepia');
                        content.classList.add(settings.inkColor);
                    }
                }
            } catch (e) {}

            setDefaultDate();
        }

        // Auto-save on changes
        document.querySelectorAll('.editable, .signature-input').forEach(el => {
            el.addEventListener('input', saveLetter);
        });

        // Mobile detection
        const isMobile = () => window.innerWidth <= 600;

        // Pan and zoom state
        let scale = 1;
        let panX = 0;
        let panY = 0;
        let isPanning = false;
        let startX, startY, startPanX, startPanY;
        let lastTouchDistance = 0;

        const paper = document.getElementById('paper');

        function getInitialScale() {
            // Fit paper width (600px) to viewport width with small margin
            const viewportWidth = window.innerWidth - 20; // 10px padding each side
            return Math.min(viewportWidth / 600, 1);
        }

        function updateTransform() {
            if (isMobile()) {
                paper.style.transform = `translate(${panX}px, ${panY}px) scale(${scale})`;
            } else {
                paper.style.transform = '';
            }
        }

        function zoomIn() {
            scale = Math.min(scale * 1.2, 2);
            updateTransform();
        }

        function zoomOut() {
            scale = Math.max(scale / 1.2, 0.3);
            updateTransform();
        }

        function resetZoom() {
            scale = getInitialScale();
            panX = 0;
            panY = 0;
            updateTransform();
        }

        // Touch events for pan/zoom
        function getTouchDistance(touches) {
            const dx = touches[0].clientX - touches[1].clientX;
            const dy = touches[0].clientY - touches[1].clientY;
            return Math.sqrt(dx * dx + dy * dy);
        }

        function getTouchCenter(touches) {
            return {
                x: (touches[0].clientX + touches[1].clientX) / 2,
                y: (touches[0].clientY + touches[1].clientY) / 2
            };
        }

        function setupMobileViewport() {
            if (!isMobile()) return;
            
            // Wrap paper in viewport if not already
            if (!document.querySelector('.paper-viewport')) {
                const viewport = document.createElement('div');
                viewport.className = 'paper-viewport';
                paper.parentNode.insertBefore(viewport, paper);
                viewport.appendChild(paper);

                // Add touch targets to editable areas
                const fields = [
                    { selector: '.sender-address', title: 'Your Address', inputId: 'senderAddress' },
                    { selector: '.recipient-address', title: "Recipient's Address", inputId: 'recipientAddress' },
                    { selector: '.date-line', title: 'Date', inputId: 'dateLine' },
                    { selector: '.salutation', title: 'Salutation', inputId: 'salutation' },
                    { selector: '.body-text', title: 'Letter Body', inputId: 'bodyText' },
                    { selector: '.closing', title: 'Closing', inputId: 'closing' },
                    { selector: '.signature-area', title: 'Signature', inputId: 'signature' },
                ];

                fields.forEach(field => {
                    const el = document.querySelector(field.selector);
                    if (el) {
                        const target = document.createElement('div');
                        target.className = 'touch-target';
                        target.dataset.title = field.title;
                        target.dataset.inputId = field.inputId;
                        target.addEventListener('click', (e) => {
                            e.stopPropagation();
                            openModal(field.title, field.inputId);
                        });
                        el.appendChild(target);
                    }
                });

                // Pan/zoom on viewport
                viewport.addEventListener('touchstart', handleTouchStart, { passive: false });
                viewport.addEventListener('touchmove', handleTouchMove, { passive: false });
                viewport.addEventListener('touchend', handleTouchEnd);
            }

            // Set initial scale AFTER viewport is set up
            scale = getInitialScale();
            updateTransform();
        }

        function handleTouchStart(e) {
            // Don't intercept touch targets - let click bubble up
            if (e.target.classList.contains('touch-target')) {
                return; // Don't preventDefault, let click happen
            }
            
            if (e.touches.length === 1) {
                isPanning = true;
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
                startPanX = panX;
                startPanY = panY;
                e.preventDefault();
            } else if (e.touches.length === 2) {
                isPanning = false;
                lastTouchDistance = getTouchDistance(e.touches);
                lastTouchCenter = getTouchCenter(e.touches);
                e.preventDefault();
            }
        }

        let lastTouchCenter = null;

        function handleTouchMove(e) {
            if (e.touches.length === 1 && isPanning) {
                const dx = e.touches[0].clientX - startX;
                const dy = e.touches[0].clientY - startY;
                panX = startPanX + dx;
                panY = startPanY + dy;
                updateTransform();
                e.preventDefault();
            } else if (e.touches.length === 2) {
                const distance = getTouchDistance(e.touches);
                const center = getTouchCenter(e.touches);
                
                if (lastTouchDistance > 0 && lastTouchCenter) {
                    const scaleDelta = distance / lastTouchDistance;
                    const newScale = Math.max(0.3, Math.min(2, scale * scaleDelta));
                    
                    // Get viewport bounds
                    const viewport = document.querySelector('.paper-viewport');
                    const viewportRect = viewport.getBoundingClientRect();
                    
                    // Pinch center relative to viewport
                    const centerX = center.x - viewportRect.left;
                    const centerY = center.y - viewportRect.top;
                    
                    // Adjust pan to keep pinch center stationary
                    // The point under fingers in paper coords: (centerX - panX) / scale
                    // After zoom, we want same paper point under fingers
                    // newPanX = centerX - paperX * newScale
                    const paperX = (centerX - panX) / scale;
                    const paperY = (centerY - panY) / scale;
                    
                    panX = centerX - paperX * newScale;
                    panY = centerY - paperY * newScale;
                    scale = newScale;
                    
                    // Also handle pan from center movement
                    panX += center.x - lastTouchCenter.x;
                    panY += center.y - lastTouchCenter.y;
                    
                    updateTransform();
                }
                lastTouchDistance = distance;
                lastTouchCenter = center;
                e.preventDefault();
            }
        }

        function handleTouchEnd(e) {
            if (e.touches.length === 0) {
                isPanning = false;
            }
            if (e.touches.length < 2) {
                lastTouchDistance = 0;
                lastTouchCenter = null;
            }
        }

        // Modal editor
        let currentEditingId = null;

        function openModal(title, inputId) {
            const modal = document.getElementById('modalEditor');
            const modalTitle = document.getElementById('modalTitle');
            const modalInput = document.getElementById('modalInput');
            const sourceInput = document.getElementById(inputId);

            currentEditingId = inputId;
            modalTitle.textContent = title;
            modalInput.value = sourceInput.value;
            modalInput.placeholder = sourceInput.placeholder;
            
            // Use same ink color
            const content = document.getElementById('letterContent');
            if (content.classList.contains('ink-black')) {
                modalInput.style.color = '#2d2d2d';
            } else if (content.classList.contains('ink-sepia')) {
                modalInput.style.color = '#5c4033';
            } else {
                modalInput.style.color = '#1a365d';
            }

            modal.classList.add('active');
            modalInput.focus();
        }

        function closeModal() {
            const modal = document.getElementById('modalEditor');
            const modalInput = document.getElementById('modalInput');
            
            if (currentEditingId) {
                const sourceInput = document.getElementById(currentEditingId);
                sourceInput.value = modalInput.value;
                if (sourceInput.tagName === 'TEXTAREA') {
                    autoResize(sourceInput);
                }
                saveLetter();
            }

            modal.classList.remove('active');
            currentEditingId = null;
        }

        // Handle resize
        window.addEventListener('resize', () => {
            if (isMobile()) {
                setupMobileViewport();
            } else {
                // Remove mobile transforms
                paper.style.transform = '';
            }
        });

        // Initialize
        loadLetter();
        if (isMobile()) {
            setupMobileViewport();
        }
    </script>
    <script src="parental.js" defer></script>
    <script src="assets/js/pwa.js" defer></script>
</body>
</html>
