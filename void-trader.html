<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Void Trader</title>
  <style>
    :root {
      color-scheme: dark;
      --bg: #06060a;
      --panel: #101017;
      --ink: #e7e9ff;
      --muted: #7c88a9;
      --accent: #43f4d9;
      --warn: #ff7a5c;
      font-family: "Inter", "Segoe UI", system-ui, sans-serif;
      font-size: 13px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: radial-gradient(circle at top, #131323 0%, #050509 60%);
      color: var(--ink);
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
    }
    main {
      width: min(920px, calc(100vw - 24px));
      margin: 12px;
      padding: 16px;
      background: rgba(4, 4, 12, 0.82);
      border: 1px solid rgba(255, 255, 255, 0.04);
      border-radius: 14px;
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      grid-auto-flow: row dense;
      box-shadow: 0 20px 40px rgba(3, 8, 20, 0.65);
    }
    header {
      grid-column: 1 / -1;
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      font-weight: 600;
      font-size: 13px;
      color: var(--muted);
    }
    header span {
      font-size: 11px;
      color: rgba(231, 233, 255, 0.45);
      letter-spacing: 0.32em;
    }
    section {
      background: rgba(9, 12, 24, 0.65);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      padding: 12px;
      display: grid;
      gap: 10px;
      min-width: 0;
      min-height: 0;
    }
    h2 {
      margin: 0;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.24em;
      color: var(--muted);
    }
    .stat-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
    }
    .stat {
      padding: 8px 10px;
      background: rgba(9, 14, 26, 0.85);
      border-radius: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      letter-spacing: 0.04em;
      color: var(--muted);
    }
    .stat strong {
      font-size: 12px;
      color: var(--ink);
      letter-spacing: 0.02em;
    }
    .meters {
      display: grid;
      gap: 6px;
    }
    .meter {
      display: grid;
      gap: 2px;
    }
    .meter label {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: var(--muted);
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }
    .bar {
      height: 36px;
      border-radius: 10px;
      background: rgba(16, 18, 30, 0.9);
      overflow: hidden;
      position: relative;
    }
    .bar::after {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(90deg, rgba(67, 244, 217, 0.82), rgba(10, 122, 191, 0.82));
      width: var(--fill, 0%);
      transition: width 0.2s ease;
    }
    .bar[data-kind="fuel"]::after { background: linear-gradient(90deg, #f9a33a, #f9572b); }
    .bar[data-kind="solar"]::after { background: linear-gradient(90deg, rgba(123, 91, 255, 0.9), rgba(32, 204, 255, 0.8)); }
    .readouts {
      display: grid;
      gap: 6px;
      font-size: 11px;
      color: var(--muted);
    }
    .readouts span { color: var(--ink); font-weight: 600; letter-spacing: 0.04em; }
    .controls {
      display: grid;
      gap: 12px;
    }
    .control-row {
      display: grid;
      gap: 6px;
    }
    .control-row label {
      display: flex;
      justify-content: space-between;
      font-size: 10px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: var(--muted);
    }
    input[type="range"] {
      width: 100%;
      accent-color: var(--accent);
    }
    #transfer-slider {
      --transfer-mid: 50%;
      --direction-accent: var(--accent);
      accent-color: var(--direction-accent);
      background: linear-gradient(90deg, rgba(12, 17, 28, 0.85), rgba(12, 17, 28, 0.85)) padding-box,
        linear-gradient(90deg, rgba(249, 87, 43, 0.35) 0%, rgba(249, 87, 43, 0.35) var(--transfer-mid),
        rgba(67, 244, 217, 0.35) var(--transfer-mid), rgba(67, 244, 217, 0.35) 100%);
      border-radius: 999px;
      transition: background 0.2s ease, accent-color 0.2s ease;
    }
    #transfer-slider[data-direction="reverse"] {
      --direction-accent: rgba(249, 87, 43, 0.9);
    }
    #transfer-slider[data-direction="forward"] {
      --direction-accent: rgba(67, 244, 217, 0.9);
    }
    #transfer-slider[data-direction="idle"] {
      --direction-accent: rgba(231, 233, 255, 0.7);
      background: linear-gradient(90deg, rgba(12, 17, 28, 0.85), rgba(12, 17, 28, 0.85));
    }
    #transfer-percent[data-direction="reverse"] { color: rgba(249, 163, 58, 0.85); }
    #transfer-percent[data-direction="forward"] { color: rgba(67, 244, 217, 0.85); }
    button {
      appearance: none;
      border: none;
      border-radius: 10px;
      padding: 10px 12px;
      background: rgba(26, 40, 52, 0.85);
      color: var(--ink);
      font: inherit;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      cursor: pointer;
      transition: background 0.2s ease, transform 0.1s ease;
    }
    button:hover { background: rgba(42, 74, 96, 0.9); }
    button:active { transform: scale(0.98); }
    button:disabled {
      opacity: 0.35;
      cursor: default;
      background: rgba(18, 26, 38, 0.8);
    }
    .dual-btns {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
    }
    .small {
      font-size: 10px;
      letter-spacing: 0.12em;
      color: rgba(231, 233, 255, 0.55);
      text-transform: uppercase;
      text-align: center;
    }
    .small.left { text-align: left; }
    select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: rgba(16, 24, 38, 0.85);
      color: var(--ink);
      font: inherit;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }
    select:disabled { opacity: 0.4; }
    .bar.thin { height: 14px; }
    .list { display: grid; gap: 6px; }
    .cargo-row {
      background: rgba(12, 17, 28, 0.9);
      border-radius: 9px;
      padding: 8px 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      letter-spacing: 0.04em;
      color: var(--muted);
    }
    .cargo-name { color: var(--ink); font-weight: 600; letter-spacing: 0.04em; }
    .cargo-qty { font-size: 10px; letter-spacing: 0.08em; color: rgba(231, 233, 255, 0.55); }
    .market-list { display: grid; gap: 8px; }
    .market-row {
      background: rgba(12, 17, 28, 0.9);
      border-radius: 9px;
      padding: 8px 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }
    .market-details { display: grid; gap: 2px; font-size: 11px; color: var(--muted); }
    .market-good { color: var(--ink); font-weight: 600; letter-spacing: 0.04em; }
    .market-price { font-size: 10px; letter-spacing: 0.08em; }
    .market-hold { font-size: 10px; letter-spacing: 0.08em; color: rgba(231, 233, 255, 0.55); }
    .market-actions { display: grid; gap: 6px; }
    button.mini { padding: 6px 8px; font-size: 10px; letter-spacing: 0.14em; }
    #travel-summary { margin-top: 2px; }
    @media (max-width: 620px) {
      main {
        width: min(480px, calc(100vw - 16px));
        grid-template-columns: minmax(0, 1fr);
      }
      .dual-btns { grid-template-columns: minmax(0, 1fr); }
    }
  </style>
</head>
<body>
  <main>
    <header>
      <div>Void Trader</div>
      <span>Compact Ops</span>
    </header>

    <section>
      <h2>Vitals</h2>
      <div class="stat-grid">
        <div class="stat"><span>Credits</span><strong id="credits">0</strong></div>
        <div class="stat"><span>Battery</span><strong id="battery">0%</strong></div>
        <div class="stat"><span>Draw</span><strong id="draw">0 W</strong></div>
        <div class="stat"><span>Supply</span><strong id="supply">0 W</strong></div>
      </div>
    </section>

    <section>
      <h2>Fuel</h2>
      <div class="meters">
        <div class="meter">
          <label><span>Fore</span><span id="fore-label">0 L</span></label>
          <div class="bar" data-kind="fuel" id="fore-fill"></div>
        </div>
        <div class="meter">
          <label><span>Aft</span><span id="aft-label">0 L</span></label>
          <div class="bar" data-kind="fuel" id="aft-fill"></div>
        </div>
      </div>
      <div class="readouts">
        <div>Transfer <span id="transfer-readout">0.0</span> KL/min</div>
        <div>Dump <span id="dump-readout">0.0</span> KL/min</div>
      </div>
    </section>

    <section class="controls">
      <h2>Controls</h2>
      <div class="control-row">
        <label><span>Fuel Transfer</span><span id="transfer-percent">Idle</span></label>
        <input type="range" id="transfer-slider" min="-100" max="100" value="0" step="5" list="transfer-marks">
        <datalist id="transfer-marks">
          <option value="-100"></option>
          <option value="-50"></option>
          <option value="0"></option>
          <option value="50"></option>
          <option value="100"></option>
        </datalist>
      </div>
      <div class="control-row">
        <label><span>Aft Dump</span><span id="dump-percent">0%</span></label>
        <input type="range" id="dump-slider" min="0" max="100" value="0">
      </div>
      <div class="control-row">
        <label><span>Solar Extension</span><span id="solar-percent">50%</span></label>
        <input type="range" id="solar-slider" min="0" max="100" value="50">
      </div>
      <div class="control-row">
        <label><span>Life Support</span><span id="life-support">ON</span></label>
        <input type="range" id="life-slider" min="0" max="100" value="70">
      </div>
      <div class="dual-btns">
        <button id="balance-btn">Balance</button>
        <button id="refuel-btn">Refuel</button>
      </div>
      <button id="export-btn">Export Save</button>
      <label class="small" for="import-input">Import JSON</label>
      <input type="file" id="import-input" accept="application/json">
    </section>

    <section id="travel-section">
      <h2>Travel</h2>
      <div class="readouts">
        <div>Current <span id="location-label">Solace Station</span></div>
        <div id="travel-status">Docked</div>
      </div>
      <div class="control-row">
        <label for="travel-select"><span>Destination</span><span id="travel-target-label"></span></label>
        <select id="travel-select"></select>
      </div>
      <div class="small left" id="travel-summary">Select a destination</div>
      <div class="bar thin" id="travel-progress"></div>
      <button id="travel-btn">Engage Travel</button>
    </section>

    <section id="cargo-section">
      <h2>Cargo</h2>
      <div class="stat-grid">
        <div class="stat"><span>Capacity</span><strong id="cargo-capacity">0</strong></div>
        <div class="stat"><span>Free</span><strong id="cargo-free">0</strong></div>
      </div>
      <div class="list" id="cargo-list">
        <div class="small">Hold empty</div>
      </div>
    </section>

    <section id="trade-section">
      <h2>Trade</h2>
      <div class="small left">Local exchange rates</div>
      <div class="market-list" id="market-list">
        <div class="small">Docked market offline</div>
      </div>
    </section>

    <section>
      <h2>Power</h2>
      <div class="meters">
        <div class="meter">
          <label><span>Solar Output</span><span id="solar-label">0 W</span></label>
          <div class="bar" data-kind="solar" id="solar-fill"></div>
        </div>
        <div class="meter">
          <label><span>Net Flow</span><span id="net-label">0 W</span></label>
          <div class="bar" id="net-fill"></div>
        </div>
      </div>
      <div class="small" id="status-line">Idle</div>
    </section>
  </main>

  <script>
    const clamp = (v, min, max) => Math.min(max, Math.max(min, v));
    const ROUND = (v, p = 1) => Number.parseFloat(v.toFixed(p));
    const formatPercent = (value) => (Number.isFinite(value) ? value.toFixed(1).replace(/\.0$/, '') : '0');
    const TRAVEL_POWER_BASE = 240;

    function setFill(el, ratio) {
      if (!el) return;
      el.style.setProperty('--fill', `${clamp(ratio * 100, 0, 100)}%`);
    }

    function freshTravelState() {
      return {
        active: false,
        originKey: null,
        originName: '',
        targetKey: null,
        targetName: '',
        remainingMs: 0,
        totalMs: 0,
        fuelCost: 0,
        powerDrawW: TRAVEL_POWER_BASE,
        arrivalBonus: 0
      };
    }

    const GOODS = {
      water: { name: 'Water Ice', volume: 1 },
      ore: { name: 'Iridium Ore', volume: 2 },
      data: { name: 'Encrypted Data', volume: 0.2 },
      spices: { name: 'Sundown Spice', volume: 0.5 },
      alloys: { name: 'Alloy Plates', volume: 1.5 }
    };

    const PORTS = [
      {
        key: 'solace',
        name: 'Solace Station',
        distance: 0,
        travelMinutes: 0,
        fuelCost: 0,
        arrivalBonus: 0,
        powerDrawW: 240,
        market: {
          water: { buy: 10, sell: 8 },
          ore: { buy: 68, sell: 54 },
          data: { buy: 102, sell: 86 }
        }
      },
      {
        key: 'drift',
        name: 'Drift City',
        distance: 1.3,
        travelMinutes: 2.5,
        fuelCost: 180,
        arrivalBonus: 120,
        powerDrawW: 230,
        market: {
          water: { buy: 8, sell: 6 },
          spices: { buy: 160, sell: 130 },
          data: { buy: 120, sell: 95 }
        }
      },
      {
        key: 'aurora',
        name: 'Aurora Forge',
        distance: 2.1,
        travelMinutes: 3.4,
        fuelCost: 240,
        arrivalBonus: 160,
        powerDrawW: 250,
        market: {
          ore: { buy: 84, sell: 68 },
          alloys: { buy: 220, sell: 185 },
          water: { buy: 7, sell: 5 }
        }
      },
      {
        key: 'mirage',
        name: 'Mirage Bazaar',
        distance: 2.8,
        travelMinutes: 4.1,
        fuelCost: 280,
        arrivalBonus: 210,
        powerDrawW: 260,
        market: {
          spices: { buy: 210, sell: 170 },
          data: { buy: 138, sell: 112 },
          water: { buy: 15, sell: 11 }
        }
      }
    ];

    const PORT_MAP = new Map(PORTS.map((port) => [port.key, port]));

    const DEFAULT_STATE = {
      timestamp: Date.now(),
      credits: 12000,
      batteryWh: 4200,
      batteryCapacityWh: 6000,
      baseDrawW: 320,
      lifeSupportDrawW: 180,
      solarExtension: 0.5,
      solarMaxW: 1400,
      transferRate: 0,
      dumpRate: 0,
      fore: { max: 1000, current: 620 },
      aft: { max: 1000, current: 360 },
      lifeSupport: 0.7,
      refuelCostPerLitre: 3,
      maxTransferKlPerMin: 2,
      maxDumpKlPerMin: 1.2,
      locationKey: 'solace',
      cargo: { capacity: 40, items: { water: 6 } },
      travel: freshTravelState(),
      lastDestination: null
    };

    const STORAGE_KEY = 'void-trader-save';
    const state = loadState();
    ensureStateShape();

    const els = {
      credits: document.getElementById('credits'),
      battery: document.getElementById('battery'),
      draw: document.getElementById('draw'),
      supply: document.getElementById('supply'),
      foreLabel: document.getElementById('fore-label'),
      aftLabel: document.getElementById('aft-label'),
      foreFill: document.getElementById('fore-fill'),
      aftFill: document.getElementById('aft-fill'),
      transferReadout: document.getElementById('transfer-readout'),
      dumpReadout: document.getElementById('dump-readout'),
      transferPercent: document.getElementById('transfer-percent'),
      dumpPercent: document.getElementById('dump-percent'),
      solarPercent: document.getElementById('solar-percent'),
      lifeSupport: document.getElementById('life-support'),
      transferSlider: document.getElementById('transfer-slider'),
      dumpSlider: document.getElementById('dump-slider'),
      solarSlider: document.getElementById('solar-slider'),
      lifeSlider: document.getElementById('life-slider'),
      balanceBtn: document.getElementById('balance-btn'),
      refuelBtn: document.getElementById('refuel-btn'),
      exportBtn: document.getElementById('export-btn'),
      importInput: document.getElementById('import-input'),
      solarLabel: document.getElementById('solar-label'),
      netLabel: document.getElementById('net-label'),
      solarFill: document.getElementById('solar-fill'),
      netFill: document.getElementById('net-fill'),
      statusLine: document.getElementById('status-line'),
      locationLabel: document.getElementById('location-label'),
      travelStatus: document.getElementById('travel-status'),
      travelTargetLabel: document.getElementById('travel-target-label'),
      travelSelect: document.getElementById('travel-select'),
      travelSummary: document.getElementById('travel-summary'),
      travelBtn: document.getElementById('travel-btn'),
      travelProgress: document.getElementById('travel-progress'),
      cargoCapacity: document.getElementById('cargo-capacity'),
      cargoFree: document.getElementById('cargo-free'),
      cargoList: document.getElementById('cargo-list'),
      marketList: document.getElementById('market-list')
    };

    els.transferSlider.value = Math.round(clamp(state.transferRate, -1, 1) * 20) * 5;
    els.dumpSlider.value = Math.round(state.dumpRate * 100);
    els.solarSlider.value = Math.round(state.solarExtension * 100);
    els.lifeSlider.value = Math.round(state.lifeSupport * 100);

    populateTravelSelect();

    let lastTick = performance.now();
    let dirty = false;
    const LOOP_MS = 200;
    let saveTimer = 0;
    let cargoListSignature = '';
    let lastMarketKey = '';

    requestAnimationFrame(tick);
    updateUI();

    els.transferSlider.addEventListener('input', () => {
      state.transferRate = clamp(els.transferSlider.value / 100, -1, 1);
      dirty = true;
      updateUI();
    });

    els.dumpSlider.addEventListener('input', () => {
      state.dumpRate = els.dumpSlider.value / 100;
      dirty = true;
      updateUI();
    });

    els.solarSlider.addEventListener('input', () => {
      state.solarExtension = els.solarSlider.value / 100;
      dirty = true;
      updateUI();
    });

    els.lifeSlider.addEventListener('input', () => {
      state.lifeSupport = els.lifeSlider.value / 100;
      dirty = true;
      updateUI();
    });

    els.balanceBtn.addEventListener('click', () => {
      const total = state.fore.current + state.aft.current;
      const target = total / 2;
      state.fore.current = clamp(target, 0, state.fore.max);
      state.aft.current = clamp(total - state.fore.current, 0, state.aft.max);
      state.transferRate = 0;
      els.transferSlider.value = 0;
      dirty = true;
      updateUI();
    });

    els.refuelBtn.addEventListener('click', () => {
      const deficit = state.aft.max - state.aft.current;
      if (deficit <= 0) return;
      const cost = Math.ceil(deficit) * state.refuelCostPerLitre;
      if (state.credits < cost) {
        window.alert('Insufficient credits.');
        return;
      }
      state.credits -= cost;
      state.aft.current = state.aft.max;
      dirty = true;
      updateUI();
    });

    els.exportBtn.addEventListener('click', () => {
      try {
        const payload = JSON.stringify({ ...state, timestamp: Date.now() }, null, 2);
        const blob = new Blob([payload], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `void-trader-save-${new Date().toISOString().replace(/[:.]/g, '-')}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        setTimeout(() => URL.revokeObjectURL(url), 0);
      } catch (err) {
        console.error('Export failed', err);
      }
    });

    els.importInput.addEventListener('change', async () => {
      const file = els.importInput.files && els.importInput.files[0];
      if (!file) return;
      try {
        const text = await file.text();
        const incoming = JSON.parse(text);
        Object.assign(state, { ...DEFAULT_STATE, ...incoming });
        ensureStateShape();
        state.travel = { ...freshTravelState(), ...state.travel };
        cargoListSignature = '';
        lastMarketKey = '';
        populateTravelSelect();
        dirty = true;
        saveState(true);
        updateUI();
      } catch (err) {
        console.error('Import failed', err);
        window.alert('Invalid save file.');
      } finally {
        els.importInput.value = '';
      }
    });

    els.travelSelect.addEventListener('change', () => {
      state.lastDestination = els.travelSelect.value || null;
      updateTravelUI();
      dirty = true;
    });

    els.travelBtn.addEventListener('click', () => {
      beginTravel(els.travelSelect.value);
    });

    els.marketList.addEventListener('click', (event) => {
      const btn = event.target.closest('button[data-action]');
      if (!btn) return;
      handleMarketAction(btn.dataset.action, btn.dataset.good);
    });

    window.addEventListener('beforeunload', () => saveState(true));

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return { ...DEFAULT_STATE };
        const parsed = JSON.parse(raw);
        return { ...DEFAULT_STATE, ...parsed };
      } catch (err) {
        console.warn('Failed to parse saved state, using defaults', err);
        return { ...DEFAULT_STATE };
      }
    }

    function ensureStateShape() {
      if (!PORT_MAP.has(state.locationKey)) {
        state.locationKey = PORTS[0].key;
      }
      if (!state.cargo || typeof state.cargo !== 'object') {
        state.cargo = { capacity: DEFAULT_STATE.cargo.capacity, items: {} };
      }
      if (typeof state.cargo.capacity !== 'number') {
        state.cargo.capacity = DEFAULT_STATE.cargo.capacity;
      }
      if (!state.cargo.items || typeof state.cargo.items !== 'object') {
        state.cargo.items = {};
      } else {
        state.cargo.items = { ...state.cargo.items };
      }
      if (!state.travel || typeof state.travel !== 'object') {
        state.travel = freshTravelState();
      } else {
        state.travel = { ...freshTravelState(), ...state.travel };
      }
      if (state.lastDestination && !PORT_MAP.has(state.lastDestination)) {
        state.lastDestination = null;
      }
  const normalizedTransfer = clamp(Number.isFinite(state.transferRate) ? state.transferRate : 0, -1, 1);
  state.transferRate = Math.round(normalizedTransfer * 20) / 20;
      state.dumpRate = clamp(Number.isFinite(state.dumpRate) ? state.dumpRate : 0, 0, 1);
    }

    function saveState(force = false) {
      if (!dirty && !force) return;
      try {
        const payload = { ...state, timestamp: Date.now() };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
        dirty = false;
      } catch (err) {
        console.warn('Save failed', err);
      }
    }

    function formatLitres(value) {
      if (value >= 1000) return `${ROUND(value / 1000, 2)} KL`;
      return `${Math.round(value)} L`;
    }

    function cargoSignature() {
      const entries = Object.entries(state.cargo.items || {}).filter(([, qty]) => qty > 0);
      if (!entries.length) return '';
      entries.sort((a, b) => a[0].localeCompare(b[0]));
      return entries.map(([key, qty]) => `${key}:${qty}`).join('|');
    }

    function getCargoUsed() {
      return Object.entries(state.cargo.items || {}).reduce((total, [key, qty]) => {
        const good = GOODS[key];
        if (!good) return total;
        return total + good.volume * qty;
      }, 0);
    }

    function getCargoFree(used = getCargoUsed()) {
      return Math.max(0, state.cargo.capacity - used);
    }

    function findPort(key) {
      return PORT_MAP.get(key) || PORTS[0];
    }

    function populateTravelSelect() {
      const select = els.travelSelect;
      if (!select) return;
      const current = state.locationKey;
      const preferred = state.lastDestination && state.lastDestination !== current ? state.lastDestination : null;
      select.innerHTML = '';
      let fallback = null;
      PORTS.forEach((port) => {
        if (port.key === current) return;
        const option = document.createElement('option');
        option.value = port.key;
        option.textContent = port.name;
        select.appendChild(option);
        if (!fallback) fallback = port.key;
      });
      if (preferred && Array.from(select.options).some((opt) => opt.value === preferred)) {
        select.value = preferred;
      } else if (fallback) {
        select.value = fallback;
      } else {
        const option = document.createElement('option');
        option.value = current;
        option.textContent = 'No destinations';
        select.appendChild(option);
        select.value = current;
      }
    }

    function formatEta(ms) {
      if (ms <= 0) return 'Arriving';
      if (ms < 60000) return `${Math.ceil(ms / 1000)} s`;
      return `${ROUND(ms / 60000, 1)} min`;
    }

    function updateUI() {
      els.credits.textContent = `${state.credits.toLocaleString()}₵`;
      const batteryPct = clamp((state.batteryWh / state.batteryCapacityWh) * 100, 0, 100);
      els.battery.textContent = `${formatPercent(batteryPct)}%`;

      const solarOutput = state.solarExtension * state.solarMaxW;
      const draw = state.baseDrawW + state.lifeSupportDrawW * state.lifeSupport + computePumpDraw() + computeTravelDraw();
      const supply = solarOutput;
      els.draw.textContent = `${Math.round(draw)} W`;
      els.supply.textContent = `${Math.round(supply)} W`;

      els.foreLabel.textContent = formatLitres(state.fore.current);
      els.aftLabel.textContent = formatLitres(state.aft.current);
      setFill(els.foreFill, state.fore.current / state.fore.max);
      setFill(els.aftFill, state.aft.current / state.aft.max);

      const transferSign = Math.sign(state.transferRate);
      const transferMagnitude = Math.abs(state.transferRate);
      const transferRate = transferMagnitude * state.maxTransferKlPerMin;
      const dumpRate = state.dumpRate * state.maxDumpKlPerMin;
      const transferDirection = transferSign === 0 ? 'idle' : transferSign > 0 ? 'forward' : 'reverse';
      const transferPercent = transferMagnitude * 100;
      const sliderValue = Math.round(clamp(state.transferRate, -1, 1) * 20) * 5;
      const sliderRatio = (sliderValue + 100) / 200;
      const sliderMid = `${(1 - sliderRatio) * 100}%`;
  const rateText = transferRate.toFixed(2);
  const dumpText = dumpRate.toFixed(2);

  els.transferReadout.textContent = transferSign === 0 ? '0.00' : `${transferSign > 0 ? '+' : '-'}${rateText}`;
  els.dumpReadout.textContent = dumpText;

      if (transferDirection === 'idle') {
        els.transferPercent.textContent = 'Idle · 0.00 KL/min';
        delete els.transferPercent.dataset.direction;
      } else {
  els.transferPercent.textContent = `${transferSign > 0 ? 'Fore → Aft' : 'Aft → Fore'} · ${Math.round(transferPercent)}% · ${rateText} KL/min`;
        els.transferPercent.dataset.direction = transferDirection;
      }

      els.transferSlider.value = sliderValue;
      els.transferSlider.dataset.direction = transferDirection;
      els.transferSlider.style.setProperty('--transfer-mid', sliderMid);
  els.transferSlider.setAttribute('aria-valuetext', transferSign === 0 ? 'Transfer idle' : `${transferSign > 0 ? 'Fore to aft' : 'Aft to fore'} at ${rateText} kilolitres per minute`);
  els.transferSlider.title = transferSign === 0 ? 'Fuel transfer idle' : `${transferSign > 0 ? 'Fore to aft' : 'Aft to fore'} fuel transfer · ${rateText} KL/min`;

      els.dumpPercent.textContent = `${Math.round(state.dumpRate * 100)}%`;
      els.solarPercent.textContent = `${Math.round(state.solarExtension * 100)}%`;
      els.lifeSupport.textContent = state.lifeSupport > 0.01 ? 'ON' : 'OFF';
      els.lifeSlider.classList.toggle('warn', state.lifeSupport < 0.2);

      els.solarLabel.textContent = `${Math.round(solarOutput)} W`;
      const net = supply - draw;
      els.netLabel.textContent = `${net >= 0 ? '+' : ''}${Math.round(net)} W`;
      setFill(els.solarFill, solarOutput / state.solarMaxW);
      setFill(els.netFill, clamp((net + state.solarMaxW) / (state.solarMaxW * 2), 0, 1));
      els.netFill.dataset.kind = net >= 0 ? 'solar' : 'fuel';
      if (state.travel.active) {
        els.statusLine.textContent = `Transit · ${state.travel.targetName}`;
      } else {
        const dock = findPort(state.locationKey);
        const base = net >= 0 ? 'Charging' : 'Discharging';
        els.statusLine.textContent = `${base} · ${dock.name}`;
      }

      updateTravelUI();
      updateCargoUI();
      updateMarketUI();
    }

    function computePumpDraw() {
      const transfer = Math.abs(state.transferRate);
      const dump = state.dumpRate;
      return 90 * transfer + 120 * dump;
    }

    function computeTravelDraw() {
      if (!state.travel || !state.travel.active) return 0;
      return state.travel.powerDrawW ?? TRAVEL_POWER_BASE;
    }

    function updateTravelUI() {
      const currentPort = findPort(state.locationKey);
      els.locationLabel.textContent = currentPort.name;
      if (state.travel.active) {
        els.travelSelect.disabled = true;
        els.travelBtn.disabled = true;
        els.travelBtn.textContent = 'In Transit';
        els.travelTargetLabel.textContent = state.travel.targetName;
        const progress = state.travel.totalMs ? 1 - state.travel.remainingMs / state.travel.totalMs : 0;
        setFill(els.travelProgress, progress);
        els.travelStatus.textContent = `Transit · ${state.travel.targetName} · ETA ${formatEta(state.travel.remainingMs)}`;
        const bonusText = state.travel.arrivalBonus ? ` · Bonus ${state.travel.arrivalBonus}₵` : '';
        els.travelSummary.textContent = `${Math.round(state.travel.fuelCost)} L expended${bonusText}`;
        return;
      }

      els.travelSelect.disabled = false;
      let destination = PORT_MAP.get(els.travelSelect.value);
      if (!destination || destination.key === currentPort.key) {
        const fallback = Array.from(els.travelSelect.options).find((opt) => opt.value !== currentPort.key);
        if (fallback) {
          els.travelSelect.value = fallback.value;
          destination = PORT_MAP.get(fallback.value);
        } else {
          destination = null;
        }
      }

      if (destination) {
        els.travelTargetLabel.textContent = destination.name;
        const summary = `${ROUND(destination.distance, 2)} AU · ${ROUND(destination.travelMinutes, 1)} min · ${Math.round(destination.fuelCost)} L aft`;
        const bonusText = destination.arrivalBonus ? ` · Bonus ${destination.arrivalBonus}₵` : '';
        els.travelSummary.textContent = summary + bonusText;
        const lackingFuel = state.aft.current < destination.fuelCost;
        els.travelBtn.disabled = lackingFuel;
        els.travelBtn.textContent = lackingFuel ? 'Need Fuel' : 'Engage Travel';
      } else {
        els.travelTargetLabel.textContent = '--';
        els.travelSummary.textContent = 'Select a destination';
        els.travelBtn.disabled = true;
        els.travelBtn.textContent = 'Engage Travel';
      }
      els.travelStatus.textContent = `Docked · ${currentPort.name}`;
      setFill(els.travelProgress, 0);
    }

    function updateCargoUI() {
      const used = getCargoUsed();
      const free = getCargoFree(used);
      els.cargoCapacity.textContent = `${ROUND(used, 1)} / ${ROUND(state.cargo.capacity, 1)} u`;
      els.cargoFree.textContent = `${ROUND(free, 1)} u free`;
      const signature = cargoSignature();
      if (signature === cargoListSignature) return;
      cargoListSignature = signature;
      els.cargoList.innerHTML = '';
      if (!signature) {
        const empty = document.createElement('div');
        empty.className = 'small';
        empty.textContent = 'Hold empty';
        els.cargoList.appendChild(empty);
        return;
      }
      Object.keys(state.cargo.items)
        .filter((key) => state.cargo.items[key] > 0 && GOODS[key])
        .sort((a, b) => GOODS[a].name.localeCompare(GOODS[b].name))
        .forEach((key) => {
          const qty = state.cargo.items[key];
          const good = GOODS[key];
          const row = document.createElement('div');
          row.className = 'cargo-row';
          row.innerHTML = `<div class="cargo-name">${good.name}</div><div class="cargo-qty">${qty} @ ${ROUND(good.volume * qty, 1)} u</div>`;
          els.cargoList.appendChild(row);
        });
    }

    function updateMarketUI() {
      const port = findPort(state.locationKey);
      if (!port) return;
      if (lastMarketKey !== port.key) {
        els.marketList.innerHTML = '';
        const goods = Object.keys(port.market || {});
        if (!goods.length) {
          const empty = document.createElement('div');
          empty.className = 'small';
          empty.textContent = 'Market closed';
          els.marketList.appendChild(empty);
        } else {
          goods.forEach((key) => {
            const good = GOODS[key];
            const entry = port.market[key];
            if (!good || !entry) return;
            const row = document.createElement('div');
            row.className = 'market-row';
            row.dataset.good = key;
            row.innerHTML = `
              <div class="market-details">
                <div class="market-good">${good.name}</div>
                <div class="market-price"></div>
                <div class="market-hold">Hold 0</div>
              </div>
              <div class="market-actions">
                <button class="mini" data-action="buy" data-good="${key}">Buy</button>
                <button class="mini" data-action="sell" data-good="${key}">Sell</button>
              </div>
            `;
            els.marketList.appendChild(row);
          });
        }
        lastMarketKey = port.key;
      }
      const used = getCargoUsed();
      const free = getCargoFree(used);
      els.marketList.querySelectorAll('.market-row').forEach((row) => refreshMarketRow(row, port, free));
    }

    function refreshMarketRow(row, port, freeSpace) {
      const key = row.dataset.good;
      const entry = port.market[key];
      const good = GOODS[key];
      if (!entry || !good) return;
      const owned = state.cargo.items[key] || 0;
      const priceEl = row.querySelector('.market-price');
      const holdEl = row.querySelector('.market-hold');
      const buyBtn = row.querySelector('button[data-action="buy"]');
      const sellBtn = row.querySelector('button[data-action="sell"]');
      if (priceEl) priceEl.textContent = `Buy ${entry.buy}₵ · Sell ${entry.sell}₵`;
      if (holdEl) holdEl.textContent = `Hold ${owned}`;
      const canBuy = !state.travel.active && state.credits >= entry.buy && freeSpace >= good.volume;
      const canSell = !state.travel.active && owned > 0;
      if (buyBtn) buyBtn.disabled = !canBuy;
      if (sellBtn) sellBtn.disabled = !canSell;
    }

    function simulate(dtMs) {
      const dtMinutes = dtMs / 60000;
      const transferSign = Math.sign(state.transferRate);
      const transferRate = Math.abs(state.transferRate) * state.maxTransferKlPerMin;
      const dumpRate = state.dumpRate * state.maxDumpKlPerMin;

      if (transferRate > 0 && transferSign !== 0) {
        const litres = transferRate * dtMinutes * 1000;
        if (transferSign > 0) {
          const moved = Math.min(litres, state.fore.current, state.aft.max - state.aft.current);
          if (moved > 0) {
            state.fore.current -= moved;
            state.aft.current += moved;
            dirty = true;
          }
        } else {
          const moved = Math.min(litres, state.aft.current, state.fore.max - state.fore.current);
          if (moved > 0) {
            state.aft.current -= moved;
            state.fore.current += moved;
            dirty = true;
          }
        }
      }

      if (dumpRate > 0) {
        const litres = dumpRate * dtMinutes * 1000;
        const dumped = Math.min(litres, state.aft.current);
        if (dumped > 0) {
          state.aft.current -= dumped;
          dirty = true;
        }
      }

      const solarOutput = state.solarExtension * state.solarMaxW;
      const draw = state.baseDrawW + state.lifeSupportDrawW * state.lifeSupport + computePumpDraw() + computeTravelDraw();
      const net = solarOutput - draw;
      if (net !== 0) {
        const deltaWh = (net * dtMs) / 3600000;
        state.batteryWh = clamp(state.batteryWh + deltaWh, 0, state.batteryCapacityWh);
        dirty = true;
      }

      if (state.travel.active) {
        state.travel.remainingMs = Math.max(0, state.travel.remainingMs - dtMs);
        dirty = true;
        if (state.travel.remainingMs === 0) {
          completeTravel();
        }
      }
    }

    function beginTravel(destKey) {
      if (!destKey || state.travel.active) return;
      const current = findPort(state.locationKey);
      const destination = PORT_MAP.get(destKey);
      if (!destination || destination.key === current.key) return;
      if (destination.fuelCost > state.aft.current) {
        window.alert('Insufficient aft fuel for jump.');
        return;
      }
      const travelMs = Math.max(1000, Math.round(destination.travelMinutes * 60000));
      state.aft.current -= destination.fuelCost;
      state.travel = {
        ...freshTravelState(),
        active: true,
        originKey: current.key,
        originName: current.name,
        targetKey: destination.key,
        targetName: destination.name,
        remainingMs: travelMs,
        totalMs: travelMs,
        fuelCost: destination.fuelCost,
        powerDrawW: destination.powerDrawW ?? TRAVEL_POWER_BASE,
        arrivalBonus: destination.arrivalBonus ?? 0
      };
      state.lastDestination = destination.key;
      dirty = true;
      updateTravelUI();
    }

    function completeTravel() {
      const destination = findPort(state.travel.targetKey);
      if (destination) {
        state.locationKey = destination.key;
        if (state.travel.arrivalBonus) {
          state.credits += state.travel.arrivalBonus;
        }
      }
      const returnKey = state.travel.originKey && state.travel.originKey !== state.locationKey ? state.travel.originKey : null;
      state.lastDestination = returnKey;
      state.travel = freshTravelState();
      lastMarketKey = '';
      populateTravelSelect();
      dirty = true;
    }

    function handleMarketAction(action, goodKey) {
      if (!action || !goodKey) return;
      const port = findPort(state.locationKey);
      const entry = port.market[goodKey];
      const good = GOODS[goodKey];
      if (!entry || !good) return;
      if (action === 'buy') {
        if (state.travel.active) return;
        if (state.credits < entry.buy) {
          window.alert('Insufficient credits.');
          return;
        }
        if (getCargoFree() < good.volume) {
          window.alert('Cargo hold full.');
          return;
        }
        state.credits -= entry.buy;
        state.cargo.items[goodKey] = (state.cargo.items[goodKey] || 0) + 1;
        dirty = true;
      } else if (action === 'sell') {
        const owned = state.cargo.items[goodKey] || 0;
        if (owned <= 0) {
          window.alert('Nothing to sell.');
          return;
        }
        state.credits += entry.sell;
        if (owned === 1) {
          delete state.cargo.items[goodKey];
        } else {
          state.cargo.items[goodKey] = owned - 1;
        }
        dirty = true;
      }
      updateUI();
    }

    function tick(now) {
      const elapsed = now - lastTick;
      if (elapsed >= LOOP_MS) {
        simulate(elapsed);
        updateUI();
        lastTick = now;
        saveTimer += elapsed;
        if (saveTimer >= 5000) {
          saveState();
          saveTimer = 0;
        }
      }
      requestAnimationFrame(tick);
    }
  </script>
</body>
</html>
